version: '1.4'
updated: '2026-01-17'

# =============================================================================
# ENVIRONMENT VARIABLES - SSOT Registry
# =============================================================================
# Ogni variabile ha UN SOLO file autoritativo. NO duplicati.
# Drift detector verifica che non ci siano duplicati.
# =============================================================================
environment:
  # SSOT per API keys e secrets (Claude/MCP related)
  # NOTE: ~/.claude/.env RIMOSSO 2026-01-17 - secrets migrati a SOPS/GSM
  claude_secrets:
    file: ~/.claude/.env.enc  # Cifrato con SOPS/age (se necessario)
    migrated_to_gsm:
      - LINEAR_API_KEY        # -> GSM: linear-api-key
      - SENTRY_AUTH_TOKEN     # -> SOPS: secrets.enc
    keys:
      - DISCORD_WEBHOOK_URL   # Notifications

  # SSOT per infrastruttura locale
  infra_config:
    file: /media/sam/1TB/nautilus_dev/.env
    keys:
      - QUESTDB_HOST          # Database host
      - QUESTDB_ILP_PORT      # Database port
      - SENTRY_DSN            # Sentry DSN (non token)
      - SENTRY_ORG            # Sentry org
      - SENTRY_PROJECT        # Sentry project

  # SSOT per AI/ML tools
  ai_tools:
    file: /media/sam/1TB/N8N_dev/.env
    keys:
      - GOOGLE_CLOUD_PROJECT  # GCP project (futuro GSM)
      - LANGSMITH_API_KEY     # LangSmith tracing
      - BRAVE_API_KEY         # Brave search

  # GSM (Google Secret Manager) - ATTIVO
  gsm:
    enabled: true
    project: custom-mix-460500-g9  # GCP project ID
    secrets:
      - github-token
      - linear-api-key          # Added 2026-01-17
      - sentry-auth-token
      - discord-bot-token
      - openai-api-key
      - gemini-api-key
      - n8n-api-key
      - grafana-service-token
      - jwt-secret-key
      - hyperliquid-testnet-pk
    usage: "gcloud secrets versions access latest --secret=SECRET_NAME"

  # Caricamento automatico via ~/.bashrc

infrastructure:
  backstage:
    path: /media/sam/1TB/backstage-portal
    frontend_port: 3002
    backend_port: 7007
    database: postgresql  # Reuses n8n PostgreSQL
    catalog:
      system: catalog/system.yaml
      mcp_config: catalog/mcp-profiles.yaml  # References ~/.mcp.json SSOT
      repos:
        - /media/sam/1TB/nautilus_dev/catalog-info.yaml
        - /media/sam/1TB/N8N_dev/catalog-info.yaml
        - /media/sam/1TB/UTXOracle/catalog-info.yaml
        - /media/sam/1TB/LiquidationHeatmap/catalog-info.yaml
    plugins:
      - grafana
      - github-actions
      - github-pull-requests
  questdb:
    host: localhost
    http_port: 9000
    ilp_port: 9009
    pg_port: 8812
  redis:
    host: localhost
    port: 6379
  hooks_shared:
    path: /media/sam/1TB/claude-hooks-shared
  # Monitoring is in nautilus_dev but serves ALL projects (shared infra)
  monitoring:
    path: /media/sam/1TB/nautilus_dev/monitoring
    grafana_port: 3000
    dashboards: /media/sam/1TB/nautilus_dev/monitoring/grafana/dashboards
    dashboard_list:
      - claude_metrics.json      # Ralph iterations, agents, AI metrics
      - quality-score.json       # NEW: Quality scores, ClaudeFlow strategy
      - config-drift.json        # Config drift tracking
      - security.json            # Security events
      - infrastructure.json      # Infrastructure metrics
      - trading.json             # Trading metrics
      - evolution.json           # Strategy evolution
    alerts: /media/sam/1TB/nautilus_dev/monitoring/grafana/provisioning/alerting
    prometheus_port: 9090
    cadvisor_port: 8484
  # Expected services for infrastructure health monitoring
  expected_services:
    systemd:
      critical:
        - name: grafana-server
          port: 3000
        - name: prometheus
          port: 9090
        - name: node_exporter
          port: 9100
        - name: process-exporter
          port: 9256
        - name: docker
        - name: bitcoind
          port: 8333
      important:
        - name: research-events
        - name: cloudflared
        - name: ollama
    docker:
      critical:
        - name: nautilus-questdb
          ports: [9000, 9009, 8812]
        - name: nautilus-redis
          ports: [6379]
      important:
        - name: backstage-portal
          ports: [7007]
        - name: n8n-n8n-1
          ports: [5678]
        - name: neo4j-research
          ports: [7474, 7687]
        - name: mempool-api
          ports: [8999]
        - name: mempool-web
          ports: [8080]
        - name: claude-reflection-qdrant
          ports: [6333]
        - name: influxdb-production
          ports: [8086]
      optional:
        - name: nautilus-github-runner
        - name: n8n-n8n-worker-1
        - name: n8n-postgres-1
        - name: n8n-redis-1
        - name: mempool-electrs
        - name: mempool-db
        - name: phoenix-phoenix-1
        - name: phoenix-postgres-1
        - name: claude-reflection-mcp
    cron:
      - name: utxoracle_daily
        schedule: "*/10 * * * *"
        command: /media/sam/1TB/UTXOracle/scripts/daily_analysis.py
        log: /tmp/daily_analysis_cron.log
        severity: high
      - name: weekly_scrape
        schedule: "0 3 * * 0"
        command: /media/sam/1TB/UTXOracle/scripts/bootstrap/run_weekly_scrape.sh
        severity: medium
      - name: nautilus_update
        schedule: "0 7 * * *"
        command: /media/sam/1TB/nautilus_dev/scripts/auto_update/run_update.sh
        severity: medium
    ports:
      critical:
        3000: grafana
        9000: questdb-http
        9009: questdb-ilp
        8812: questdb-pg
        6379: redis
        9090: prometheus
        8333: bitcoind
      important:
        7007: backstage
        5678: n8n
        7474: neo4j-http
        7687: neo4j-bolt
        8080: mempool-web
        8999: mempool-api
        6333: qdrant
        8086: influxdb
      monitoring:
        9100: node_exporter
        9256: process_exporter
        8484: cadvisor
  notifications:
    discord:
      webhook_env: DISCORD_WEBHOOK_URL
      enabled: true
    email:
      smtp_host_env: SMTP_HOST  # e.g., smtp.gmail.com
      smtp_port: 587
      smtp_user_env: SMTP_USER
      smtp_password_env: SMTP_PASSWORD  # Use app password for Gmail
      smtp_from_env: SMTP_FROM  # e.g., alerts@claudecode.local
      recipients_env: ALERT_EMAIL  # Comma-separated for multiple
      enabled: true
      triggers:
        on_critical: true  # Always email for critical severity issues
        on_discord_failure: true  # Fallback when Discord fails
        on_health_score_below: 70  # Email if score drops below threshold
repositories:
  nautilus_dev:
    path: /media/sam/1TB/nautilus_dev
    language: python
    framework: nautilustrader
    test_command: uv run pytest tests/ -x
    lint_command: uv run ruff check .
    format_command: uv run ruff format .
    features:
    - trading_strategies
    - backtesting
    - live_trading
  n8n_dev:
    path: /media/sam/1TB/N8N_dev
    language: typescript
    framework: n8n
    test_command: npm test
    lint_command: npm run lint
    features:
    - workflow_automation
    - integrations
  utxoracle:
    path: /media/sam/1TB/UTXOracle
    language: python
    framework: fastapi
    test_command: uv run pytest tests/ -x
    lint_command: uv run ruff check .
    features:
    - bitcoin_analytics
    - utxo_analysis
  liquidation_heatmap:
    path: /media/sam/1TB/LiquidationHeatmap
    language: python
    framework: flask
    test_command: uv run pytest tests/ -x
    lint_command: uv run ruff check .
    features:
    - market_visualization
    - liquidation_data
global:
  commands:
  - tdd/
  - undo/
  - speckit.analyze
  - speckit.checklist
  - speckit.clarify
  - speckit.constitution
  - speckit.implement
  - speckit.plan
  - speckit.specify
  - speckit.tasks
  - speckit.taskstoissues
  - verify-tasks
  - refine-prompt
  - health
  - audit
  - new-project
  - tips
  - auto-resolve
  - research
  - research-papers
  skills:
  - pytest-test-generator
  - pydantic-model-generator
  - github-workflow
  - metrics-insight
  hooks:
    pre_tool_use:
    - context_bundle_builder.py
    - smart-safety-check.py (Bash)
    - git-safety-check.py (Bash)
    - tdd-guard-check.py (Write|Edit)
    - agent-spawn-tracker.py (Task)
    post_tool_use:
    - post-tool-use.py
    - dora-tracker.py
    - auto-format.py (Write|Edit)
    - quality-score-tracker.py (Bash)  # NEW: Quality metrics tracking
    - architecture-validator.py (Bash)
    - readme-generator.py (Bash)
    stop:
    - stop.py
    - context-preservation.py
    - session-summary.py
    - auto-ralph.py
    - ralph-loop.py
    - claudeflow-sync.py  # NEW: Sync ClaudeFlow JSON+SQLite to QuestDB
    subagent_stop:
    - subagent-checkpoint.sh
    user_prompt_submit:
    - task-classifier-v2.py
    - ssot_check.py
    - ralph-resume.py
    - verbalized_sampling.py
    - framework-detector.py  # NEW: Detect SpecKit/CGSD frameworks
  # Git hooks (native git, separate from Claude Code hooks)
  git_hooks:
    global_path: ~/.claude/hooks
    hooks:
      pre-push: pre-push-review.sh  # ClaudeFlow Bug Hunter
    features:
      - Uses claude --print (Max subscription, FREE)
      - Blocks CRITICAL issues
      - Prompts on HIGH severity
      - Filters code files only (.py, .ts, .js, etc.)
  # AI Services (localhost)
  ai_services:
    ai_validation:
      path: /media/sam/1TB/claude-hooks-shared/services/ai_validation_service.py
      port: 3848
      endpoints:
        - /health
        - /review-pr
        - /validate-data
        - /validate-visual
        - /validate-domain
        - /quality-score
      systemd: ai-validation.service
      domains: [nautilus, bitcoin, n8n, visualization, default]
  # N8N Workflows (automation)
  n8n_workflows:
    ai_pr_review:
      id: W7.1_AI_PR_Review
      webhook: https://n8nubuntu.princyx.xyz/webhook/ai-pr-review
      spec: ~/.claude/plans/modular-snuggling-snail.md#appendice-b
      status: pending  # Delegated to N8N team
  utility_scripts:
    drift_detector:
      path: ~/.claude/scripts/drift-detector.py
      description: Check for config drift across repositories
      checks: [duplicates, missing_files, settings_drift, obsolete, ports, services, containers, cron]
    drift_to_questdb:
      path: ~/.claude/scripts/drift-to-questdb.py
      description: Send drift metrics to QuestDB for Grafana visualization
      schedule: "*/30 * * * *"  # Every 30 minutes
      dashboard: config-drift
    weekly_health_report:
      path: ~/.claude/scripts/weekly-health-report.sh
      description: Send health report to Discord + email fallback
      schedule: "0 8 * * 1"  # Every Monday 8:00 AM
    daily_health_report:
      path: ~/.claude/scripts/daily-health-report.sh
      description: Conditional daily health check (only if issues)
      schedule: "0 8 * * *"  # Every day 8:00 AM
    issue_resolver:
      path: ~/.claude/scripts/issue-resolver.py
      description: Auto-resolution pipeline for drift issues
      usage: --json | --dry-run | --create-issues | --execute ISSUE_ID
    n8n_research_trigger:
      path: ~/.claude/scripts/trigger-n8n-research.sh
      description: Trigger N8N academic research pipeline
      webhook: https://n8nubuntu.princyx.xyz/webhook/779dcea3-a780-4c67-a092-4785d5df68f0
      auth_header: X-N8N-Auth-Token
      usage: '"<query>" or --status'
    system_state_snapshot:
      path: ~/.claude/scripts/system-state-snapshot.sh
      description: Capture system configuration for disaster recovery
      usage: --save to persist, --save --push to push to git
    backup_validator:
      path: ~/.claude/scripts/backup-validator.sh
      description: Verify GitHub backups are recent and complete
      usage: --fix to push unpushed changes
project_specific:
  nautilus_dev:
    skills:
    - paper-to-strategy
    - formula-to-code
    commands:
    - research.md
    - optimize.md
    - pinescript.md
    agents:
    - nautilus-coder
    - nautilus-docs-specialist
    - backtest-analyzer
  utxoracle:
    skills:
    - bitcoin-rpc-connector
metrics:
  schema: ~/.claude/schemas/metrics.yaml
  tables:
  - claude_tool_usage
  - claude_events
  - claude_sessions
  - claude_agents
  - claude_hooks
  - claude_tasks
  - claude_context
  - claude_quality_scores      # NEW: Quality metrics from pytest/ruff/mypy
  - claude_strategy_metrics    # NEW: ClaudeFlow strategy performance
  - claude_strategy_trends     # NEW: ClaudeFlow strategy score trends
  - claude_agent_learning      # NEW: Per-agent learning patterns
  - claude_neural_patterns     # NEW: Neural patterns from SQLite
  - claude_swarm_metrics       # NEW: Swarm performance metrics
  retention:
    default: 90d
    sessions: 365d
    hooks: 30d
reports:
  daily:
    period: 24h
    sections:
    - summary
    - errors
    - top_issues
    output: terminal
  weekly:
    period: 7d
    sections:
    - summary
    - trends
    - agent_performance
    - recommendations
    output: markdown
  monthly:
    period: 30d
    sections:
    - summary
    - cost_analysis
    - trends
    - agent_roi
    - recommendations
    - next_actions
    output: markdown
thresholds:
  hook_latency_warn_ms: 100
  hook_latency_critical_ms: 500
  agent_success_rate_min: 0.8
  daily_cost_warn_usd: 30
  daily_cost_critical_usd: 50
  context_utilization_warn: 0.8
features:
  self_healing_hooks:
    enabled: true
    max_failures: 3
    failure_window_seconds: 300
    disable_duration_seconds: 3600
    state_file: ~/.claude/metrics/hook_health.json
  cost_attribution:
    enabled: true
    by_project: true
    by_branch: true
    by_task_type: true
    task_types:
    - feature
    - bugfix
    - refactor
    - testing
    - docs
  optimization_tips:
    enabled: true
    tips_file: ~/.claude/metrics/last_session_tips.json
    command: /tips  # Manual command, user decides when to view/use
claudeflow:
  enabled: true  # DEFAULT ON (Claude Max 20x = unlimited budget)
  mode: orchestrator  # Full orchestration, not just on-demand
  install_path: /media/sam/1TB/claude-flow
  version: v3  # Updated to v3 branch (DDD architecture, 15-agent swarm)
  global_hive_mind_db: ~/.claude/hive-mind/hive-mind.db  # Global SQLite for learning
  speckit_integration:
    checkpoints:
      - phase: specify
        validator: truth_score
        threshold: 0.7
      - phase: plan
        validator: feasibility_check
        threshold: 0.7
      - phase: implement
        validator: tests_pass
    worktrees:
      enabled: true
      base_dir: /tmp/claude-worktrees
      cleanup_on_merge: true
  self_healing:
    circuit_breaker:
      max_failures: 3
      cooldown_seconds: 300
    rollback:
      mode: partial  # strict|partial|recovery
      auto_on_failure: true
  hooks_integration:
    external_hooks:
      enabled: true
      python_hooks_path: /media/sam/1TB/claude-hooks-shared/hooks
      timeout_ms: 5000
    session_sync:
      provider: questdb
      sync_interval_ms: 30000

# =============================================================================
# MCP SERVERS - Global Configuration (2026-01-17)
# =============================================================================
# SSOT: ~/.mcp.json (global) + project/.mcp.json (project-specific)
# Secrets via SOPS or GSM - NO inline credentials.
# =============================================================================
mcp:
  ssot: ~/.mcp.json  # Single source of truth for global MCP servers

  tool_search:
    enabled: true
    threshold: 10
    token_savings: "85-95%"

  # Global servers (in ~/.mcp.json)
  global_servers:
    - linear        # GSM wrapper
    - context7      # No secrets
    - serena        # No secrets
    - sentry        # OAuth
    - firecrawl-mcp # SOPS inline
    - wolframalpha  # SOPS inline
    - paper-search-mcp  # No secrets
    - download-mcp  # No secrets

  # Project-specific servers (in project/.mcp.json)
  project_servers:
    nautilus_dev: [matlab-server]
    N8N_dev: [n8n-mcp]
    UTXOracle: [brk]

  secrets_sources:
    sops:
      file: /media/sam/1TB/secrets.enc
      keys: [FIRECRAWL_API_KEY, WOLFRAM_LLM_APP_ID]
    gsm:
      project: custom-mix-460500-g9
      secrets: [linear-api-key]

sync:
  # NOTE: Commands speckit/tdd/undo are GLOBAL ONLY (no longer synced to repos)
  # Repos use the global versions directly via ~/.claude/commands/
  global_only:
  - commands/speckit.*.md
  - commands/tdd/
  - commands/undo/
  - commands/verify-tasks.md
  - commands/refine-prompt.md
  - skills/pytest-test-generator/
  - skills/pydantic-model-generator/
  - skills/github-workflow/
  - skills/metrics-insight/
  - agents/architecture-validator.md
  - agents/readme-generator.md
  project_only:
  - CLAUDE.md  # At repo root, NOT in .claude/
  - .claude/settings.local.json
  - .claude/agents/  # Project-specific agents
  - .claude/commands/  # Project-specific commands only
  consistency_check:
  - hooks configuration in settings.json
  - env variables (QUESTDB_HOST, etc.)

# Standard repository structure (established 2026-01-10)
standard_structure:
  documentation:
    # CLAUDE.md must be at repo ROOT (not in .claude/)
    claude_md: /CLAUDE.md
    architecture_md: /docs/ARCHITECTURE.md  # Auto-generated by architecture-validator
    readme_md: /README.md  # Auto-generated by readme-generator

  claude_folder:
    # .claude/ contains ONLY project-specific items
    agents: .claude/agents/  # Project-specific agents
    commands: .claude/commands/  # Project-specific commands ONLY
    settings: .claude/settings.local.json  # Local overrides (gitignored)
    context_bundles: .claude/context_bundles/  # Auto-generated
    stats: .claude/stats/  # Auto-generated
    # NOTE: speckit/, tdd/, undo/ should NOT exist here - use global

  hooks:
    location: /media/sam/1TB/claude-hooks-shared/hooks/
    auto_generation:
      - architecture-validator.py  # Triggers on git commit
      - readme-generator.py  # Triggers on git commit (rate-limited)

  ssot_principles:
    - Commands: Global ~/.claude/commands/ is SSOT (no duplicates in repos)
    - Skills: Global ~/.claude/skills/ is SSOT
    - Hooks: /media/sam/1TB/claude-hooks-shared/ is SSOT
    - CLAUDE.md: Each repo has its own at ROOT (not .claude/)
    - ARCHITECTURE.md: Auto-generated, validated on commit
    - README.md: Auto-generated, validated on commit (rate-limited)
