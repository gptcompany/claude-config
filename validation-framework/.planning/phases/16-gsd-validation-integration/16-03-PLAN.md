# Plan 16-03: Session Checkpoint Integration

## Objective

Enable crash recovery for GSD phases by integrating claude-flow session checkpoints:
- session_save before phase execution
- session_save after phase completion
- session_restore on resume

## Prerequisites

- claude-flow MCP tools available
- claudeflow-sync.js hook exists (but not wired)
- Memory store working (verified in analysis)

## Current State

### Documented (CLAUDE.md)

```markdown
### 1. BEFORE spawning Task agents
mcp__claude-flow__session_save sessionId="{project}-{phase}-start"
mcp__claude-flow__memory_store key="gsd:{project}:{phase}"

### 2. AFTER completion
mcp__claude-flow__memory_store key="gsd:{project}:{phase}" value={"status":"done"}
mcp__claude-flow__session_save sessionId="{project}-{phase}-done"
```

### Actually Happening

- memory_store: Used (5 entries in store.json)
- session_save: Never called
- session_restore: Never called
- 10 empty session files exist

## Tasks

### Task 1: Wire claudeflow-sync.js Hook (6 tests)

**File:** `~/.claude/settings.json`

**Changes:**

1. Add to PostToolUse hooks:
```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "node ~/.claude/scripts/hooks/metrics/claudeflow-sync.js",
            "timeout": 5000
          }
        ]
      }
    ]
  }
}
```

**Tests:**
- `test_claudeflow_sync_triggered_on_task`: Hook runs on Task tool
- `test_claudeflow_sync_updates_memory`: Memory store called
- `test_claudeflow_sync_handles_timeout`: Graceful on slow response
- `test_claudeflow_sync_nonblocking`: Doesn't delay Task tool
- `test_claudeflow_sync_logs_errors`: Errors logged but not thrown
- `test_claudeflow_sync_skips_non_gsd`: Only syncs GSD-related tasks

### Task 2: Add Session Save to GSD Workflows (6 tests)

**File:** `~/.claude/get-shit-done/workflows/execute-phase.md`

**Changes:**

1. Add session checkpoint before execution:
```markdown
## Session Checkpoint (Start)

<step name="session_start">
**Save session checkpoint before phase execution:**

Use MCP tool: `mcp__claude-flow__session_save`
- sessionId: `{project}-phase{N}-start`
- Include: current STATE.md, plan list, task status

This enables recovery if Claude Code crashes mid-phase.
</step>
```

2. Add session checkpoint after execution:
```markdown
## Session Checkpoint (Complete)

<step name="session_complete">
**Save session checkpoint after phase completion:**

Use MCP tool: `mcp__claude-flow__session_save`
- sessionId: `{project}-phase{N}-done`
- Include: results, metrics, next steps

Use MCP tool: `mcp__claude-flow__memory_store`
- key: `gsd:{project}:{N}`
- value: `{"status": "completed", "plans": N, "tests": M, "timestamp": "..."}`
</step>
```

**Tests:**
- `test_session_save_called_before_execution`: Start checkpoint exists
- `test_session_save_called_after_completion`: Done checkpoint exists
- `test_session_save_includes_state`: STATE.md content captured
- `test_memory_store_called_on_complete`: Memory updated
- `test_session_id_format_correct`: Format is {project}-phase{N}-{state}
- `test_session_save_handles_mcp_error`: Graceful on MCP failure

### Task 3: Implement Session Restore on Resume (4 tests)

**File:** `~/.claude/get-shit-done/workflows/resume-work.md`

**Changes:**

1. Add session recovery check:
```markdown
## Session Recovery Check

<step name="check_recovery">
**Check for interrupted session:**

Use MCP tool: `mcp__claude-flow__memory_retrieve`
- key: `gsd:{project}:*`

**If found incomplete session:**
1. Show last checkpoint state
2. Ask: "Found interrupted phase {N}. Resume from checkpoint?"
3. If yes: `mcp__claude-flow__session_restore` with last sessionId
4. If no: Start fresh

**If no incomplete session:**
Proceed with normal resume flow.
</step>
```

2. Add recovery execution:
```markdown
## Execute Recovery

<step name="execute_recovery">
**If resuming from checkpoint:**

1. Load session: `mcp__claude-flow__session_restore sessionId={last_session}`
2. Show: "Restored to checkpoint: {description}"
3. List: Completed plans, remaining plans
4. Continue from first incomplete plan
</step>
```

**Tests:**
- `test_resume_checks_memory_store`: memory_retrieve called on resume
- `test_resume_detects_incomplete`: Incomplete session detected
- `test_resume_asks_user`: User prompted for recovery choice
- `test_resume_restores_session`: session_restore called on yes

## Acceptance Criteria

- [ ] claudeflow-sync.js wired into PostToolUse for Task
- [ ] Session saved before phase execution
- [ ] Session saved after phase completion
- [ ] Memory store updated on completion
- [ ] Resume checks for incomplete sessions
- [ ] Session restore works on recovery
- [ ] 16 tests pass (6 + 6 + 4)

## Files Modified

- `~/.claude/settings.json`
- `~/.claude/get-shit-done/workflows/execute-phase.md`
- `~/.claude/get-shit-done/workflows/resume-work.md`
- `tests/integration/test_session_checkpoint.py` (new)

## Estimated Effort

- Task 1: 30 min
- Task 2: 45 min
- Task 3: 45 min
- **Total: ~2 hours**
