# Plan 16-01: GSD Workflow Integration

## Objective

Integrate ValidationOrchestrator into GSD workflows so that:
- `/gsd:execute-plan` runs Tier 1 validation after implementation
- `/gsd:verify-work` runs Tier 1+2 before conversational UAT
- `/gsd:complete-milestone` enforces quality gate (all tiers)

## Prerequisites

- ValidationOrchestrator working (`python3 orchestrator.py 1` returns exit code)
- GSD workflow files accessible
- Write access to `~/.claude/get-shit-done/workflows/`

## Tasks

### Task 1: Update execute-plan.md (10 tests)

**File:** `~/.claude/get-shit-done/workflows/execute-plan.md`

**Changes:**
1. After "Implementation Complete" section, add:

```markdown
## Post-Implementation Validation

<step name="tier1_validation">
**Run Tier 1 (blockers) validation:**

\`\`\`bash
python3 ~/.claude/templates/validation/orchestrator.py 1
\`\`\`

**Exit code handling:**
- `0`: All Tier 1 passed → proceed to mark complete
- `1`: Tier 1 failure → DO NOT mark complete, show failures
- `2`: Orchestrator error → warn and proceed (fail-open)

**If Tier 1 fails:**
- List each failing validator with message
- Suggest: "Fix issues or run `/gsd:plan-fix` to create fix plan"
- Do NOT update SUMMARY.md as complete

**If Tier 1 passes:**
- Log in SUMMARY.md: "Validation: Tier 1 PASSED (code_quality, type_safety, security)"
- Proceed to mark plan complete
</step>
```

**Tests:**
- `test_execute_plan_calls_orchestrator`: Verify orchestrator.py is called
- `test_execute_plan_blocks_on_tier1_fail`: Exit code 1 stops completion
- `test_execute_plan_proceeds_on_tier1_pass`: Exit code 0 continues
- `test_execute_plan_failopen_on_error`: Exit code 2 warns but continues
- `test_execute_plan_logs_validation_result`: SUMMARY.md updated
- `test_execute_plan_shows_failure_details`: Failure messages displayed
- `test_execute_plan_suggests_planfix`: Suggests /gsd:plan-fix on failure
- `test_execute_plan_no_duplicate_validation`: Debounce multiple runs
- `test_execute_plan_respects_validation_disabled`: VALIDATION_ENABLED=false skips
- `test_execute_plan_handles_missing_orchestrator`: Graceful if orchestrator not found

### Task 2: Update verify-work.md (10 tests)

**File:** `~/.claude/get-shit-done/workflows/verify-work.md`

**Changes:**
1. Before "Conversational UAT" section, add:

```markdown
## Automated Validation (Pre-UAT)

<step name="automated_validation">
**Run automated validation before conversational UAT:**

### Tier 1 (Blockers) - MUST PASS
\`\`\`bash
python3 ~/.claude/templates/validation/orchestrator.py 1
\`\`\`

**If Tier 1 fails:**
- Show failure summary
- Skip UAT (no point testing broken code)
- Route to `/gsd:plan-fix`

### Tier 2 (Warnings) - Show to User
\`\`\`bash
python3 ~/.claude/templates/validation/orchestrator.py 2
\`\`\`

**Present Tier 2 results:**
- List any warnings (design_principles, oss_reuse, etc.)
- Note: "These are suggestions, not blockers"
- User can acknowledge and proceed

### Proceed to UAT
Only if Tier 1 passed, proceed to conversational UAT.
</step>
```

**Tests:**
- `test_verify_work_runs_tier1_first`: Tier 1 called before UAT
- `test_verify_work_runs_tier2_second`: Tier 2 called after Tier 1
- `test_verify_work_skips_uat_on_tier1_fail`: No UAT if Tier 1 fails
- `test_verify_work_shows_tier2_warnings`: Warnings displayed to user
- `test_verify_work_proceeds_with_tier2_warnings`: Tier 2 doesn't block
- `test_verify_work_routes_to_planfix`: Suggests plan-fix on Tier 1 fail
- `test_verify_work_shows_validation_summary`: Summary before UAT
- `test_verify_work_handles_both_tiers_pass`: Clean proceed to UAT
- `test_verify_work_respects_quick_flag`: --quick skips Tier 2
- `test_verify_work_logs_validation_metrics`: Results logged for tracking

### Task 3: Update complete-milestone.md (5 tests)

**File:** `~/.claude/get-shit-done/workflows/complete-milestone.md`

**Changes:**
1. Before "Archive Milestone" section, add:

```markdown
## Milestone Quality Gate

<step name="quality_gate">
**Run full validation before archiving milestone:**

\`\`\`bash
python3 ~/.claude/templates/validation/orchestrator.py all
\`\`\`

### Requirements

| Tier | Requirement | Blocking |
|------|-------------|----------|
| 1 | 100% pass | YES |
| 2 | Documented exceptions | NO |
| 3 | Metrics recorded | NO |

### If Tier 1 < 100%

**BLOCK milestone completion:**
1. List failing validators
2. Show failure count and details
3. Require one of:
   - Fix the issues
   - Explicit override with documented reason

**Override syntax:**
```
/gsd:complete-milestone --force --reason="Tier 1 override: [reason]"
```
Overrides are logged in milestone archive for audit.

### If Tier 1 = 100%

Proceed with milestone archiving.
Record Tier 2 warnings and Tier 3 metrics in archive.
</step>
```

**Tests:**
- `test_complete_milestone_runs_all_tiers`: All tiers executed
- `test_complete_milestone_blocks_on_tier1_fail`: Cannot archive with failures
- `test_complete_milestone_allows_override`: --force with reason works
- `test_complete_milestone_logs_override`: Override logged in archive
- `test_complete_milestone_records_metrics`: Tier 3 metrics in archive

### Task 4: Create Integration Test Suite

**File:** `tests/integration/test_gsd_validation_integration.py`

**Tests covering the workflow integration:**
```python
class TestGSDValidationIntegration:
    """Integration tests for GSD + ValidationOrchestrator."""

    def test_execute_plan_full_flow(self):
        """Test execute-plan with validation."""
        pass

    def test_verify_work_full_flow(self):
        """Test verify-work with pre-UAT validation."""
        pass

    def test_complete_milestone_quality_gate(self):
        """Test milestone quality gate enforcement."""
        pass

    def test_validation_disabled_skips_all(self):
        """Test VALIDATION_ENABLED=false behavior."""
        pass

    def test_orchestrator_error_failopen(self):
        """Test graceful handling of orchestrator errors."""
        pass
```

## Acceptance Criteria

- [ ] execute-plan.md calls orchestrator with tier 1
- [ ] execute-plan blocks on tier 1 failures
- [ ] verify-work.md calls orchestrator with tier 1 and 2
- [ ] verify-work shows warnings for tier 2
- [ ] complete-milestone.md runs all tiers
- [ ] complete-milestone blocks on tier 1 < 100%
- [ ] Override mechanism works with logging
- [ ] 25 tests pass (10 + 10 + 5)
- [ ] VALIDATION_ENABLED flag respected

## Files Modified

- `~/.claude/get-shit-done/workflows/execute-plan.md`
- `~/.claude/get-shit-done/workflows/verify-work.md`
- `~/.claude/get-shit-done/workflows/complete-milestone.md`
- `tests/integration/test_gsd_validation_integration.py` (new)

## Estimated Effort

- Task 1: 45 min
- Task 2: 45 min
- Task 3: 30 min
- Task 4: 30 min
- **Total: ~2.5 hours**
