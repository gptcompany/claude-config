# Plan 16-04: E2E Integration Tests & Documentation

## Objective

Create comprehensive E2E tests and update documentation:
- Full pipeline tests (execute-plan → verify-work → complete-milestone)
- Failure and recovery scenarios
- Updated SSOT documentation

## Prerequisites

- Plans 16-01, 16-02, 16-03 complete
- All unit tests passing
- Integration accessible

## Tasks

### Task 1: Full Pipeline E2E Tests (10 tests)

**File:** `tests/e2e/test_gsd_validation_pipeline.py`

```python
"""
E2E tests for GSD + Validation integration.

These tests verify the complete workflow:
1. execute-plan runs validation
2. verify-work shows validation results
3. complete-milestone enforces quality gate
"""

import pytest
import subprocess
import os
import json

class TestGSDValidationPipeline:
    """Full pipeline E2E tests."""

    @pytest.fixture
    def test_project(self, tmp_path):
        """Create a test project with validation config."""
        project = tmp_path / "test-project"
        project.mkdir()

        # Create validation config
        config_dir = project / ".claude" / "validation"
        config_dir.mkdir(parents=True)

        config = {
            "project_name": "test-project",
            "domain": "general",
            "dimensions": {
                "code_quality": {"tier": 1, "enabled": True},
                "type_safety": {"tier": 1, "enabled": True}
            }
        }
        (config_dir / "config.json").write_text(json.dumps(config))

        return project

    def test_execute_plan_with_passing_validation(self, test_project):
        """Test execute-plan when all validation passes."""
        # Create valid Python file
        (test_project / "main.py").write_text("def hello(): return 'world'")

        # Run orchestrator
        result = subprocess.run(
            ["python3", os.path.expanduser("~/.claude/templates/validation/orchestrator.py"), "1"],
            cwd=test_project,
            capture_output=True
        )

        assert result.returncode == 0

    def test_execute_plan_with_failing_validation(self, test_project):
        """Test execute-plan when Tier 1 fails."""
        # Create file with issues
        (test_project / "bad.py").write_text("import os\nos.system(input())")  # Security issue

        result = subprocess.run(
            ["python3", os.path.expanduser("~/.claude/templates/validation/orchestrator.py"), "1"],
            cwd=test_project,
            capture_output=True
        )

        # Should fail (exit code 1)
        assert result.returncode == 1

    def test_verify_work_shows_tier1_and_tier2(self, test_project):
        """Test verify-work runs both Tier 1 and Tier 2."""
        # This test verifies both tiers are called
        pass

    def test_verify_work_skips_uat_on_failure(self, test_project):
        """Test verify-work doesn't proceed to UAT if Tier 1 fails."""
        pass

    def test_complete_milestone_blocks_on_failure(self, test_project):
        """Test milestone completion blocked when Tier 1 < 100%."""
        pass

    def test_complete_milestone_allows_override(self, test_project):
        """Test --force with reason allows completion."""
        pass

    def test_agent_spawn_on_tier2_failure(self, test_project):
        """Test agent spawned when Tier 2 fails."""
        pass

    def test_swarm_parallel_for_tier3(self, test_project):
        """Test Tier 3 runs in parallel via swarm."""
        pass

    def test_session_checkpoint_created(self, test_project):
        """Test session checkpoint saved during phase."""
        pass

    def test_session_recovery_on_resume(self, test_project):
        """Test session restored when resuming interrupted phase."""
        pass
```

### Task 2: Failure Scenario Tests (5 tests)

**File:** `tests/e2e/test_failure_scenarios.py`

```python
"""
Tests for failure scenarios and edge cases.
"""

class TestFailureScenarios:
    """Test error handling and recovery."""

    def test_orchestrator_missing_graceful(self):
        """Test graceful handling when orchestrator.py not found."""
        pass

    def test_validator_timeout_handled(self):
        """Test timeout handling for slow validators."""
        pass

    def test_swarm_failure_fallback(self):
        """Test fallback to sequential when swarm fails."""
        pass

    def test_mcp_unavailable_continues(self):
        """Test workflow continues when MCP tools unavailable."""
        pass

    def test_partial_validation_result(self):
        """Test handling when some validators fail to run."""
        pass
```

### Task 3: Recovery Tests (5 tests)

**File:** `tests/e2e/test_recovery.py`

```python
"""
Tests for crash recovery and session restore.
"""

class TestRecovery:
    """Test crash recovery mechanisms."""

    def test_resume_finds_incomplete_session(self):
        """Test resume detects incomplete phase."""
        pass

    def test_resume_restores_correct_state(self):
        """Test session restore loads correct checkpoint."""
        pass

    def test_resume_continues_from_checkpoint(self):
        """Test execution continues from interrupted plan."""
        pass

    def test_resume_without_checkpoint_starts_fresh(self):
        """Test fresh start when no checkpoint exists."""
        pass

    def test_multiple_checkpoints_uses_latest(self):
        """Test most recent checkpoint used for restore."""
        pass
```

### Task 4: Update Documentation (SSOT)

**File:** `~/.claude/docs/VALIDATION.md`

**Add section:**
```markdown
## GSD Integration (v5.0)

### Automatic Validation in GSD Workflows

ValidationOrchestrator is automatically called by GSD workflows:

| Workflow | Tiers Run | Blocking |
|----------|-----------|----------|
| `/gsd:execute-plan` | Tier 1 | Yes - blocks on failure |
| `/gsd:verify-work` | Tier 1, 2 | Tier 1 blocks, Tier 2 warns |
| `/gsd:complete-milestone` | All | Tier 1 blocks (override available) |

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `VALIDATION_ENABLED` | true | Enable/disable all validation |
| `VALIDATION_AGENT_SPAWN` | true | Enable agent spawning on Tier 2 |
| `VALIDATION_SWARM` | true | Enable parallel Tier 3 via swarm |

### Session Checkpoints

Validation state is checkpointed via claude-flow:
- Before phase: `session_save({project}-phase{N}-start)`
- After phase: `session_save({project}-phase{N}-done)`
- On resume: `session_restore` if incomplete session found

### Override Mechanism

For milestone completion with Tier 1 failures:
```bash
/gsd:complete-milestone --force --reason="[documented reason]"
```
Overrides are logged in milestone archive.
```

**File:** `~/.claude/docs/HOOKS-CATALOG.md`

**Add entry:**
```markdown
### claudeflow-sync.js

**Type:** PostToolUse
**Triggers:** Task tool
**Purpose:** Sync GSD state to claude-flow memory
**Behavior:**
- Updates memory_store with task progress
- Non-blocking (5s timeout)
- Only syncs GSD-related tasks

**Configuration:**
```json
{
  "matcher": "Task",
  "hooks": [{
    "type": "command",
    "command": "node ~/.claude/scripts/hooks/metrics/claudeflow-sync.js"
  }]
}
```
```

## Acceptance Criteria

- [ ] 10 full pipeline E2E tests
- [ ] 5 failure scenario tests
- [ ] 5 recovery tests
- [ ] VALIDATION.md updated with GSD integration
- [ ] HOOKS-CATALOG.md updated with claudeflow-sync
- [ ] 20 tests pass

## Files Created/Modified

- `tests/e2e/test_gsd_validation_pipeline.py` (new)
- `tests/e2e/test_failure_scenarios.py` (new)
- `tests/e2e/test_recovery.py` (new)
- `~/.claude/docs/VALIDATION.md`
- `~/.claude/docs/HOOKS-CATALOG.md`

## Estimated Effort

- Task 1: 1 hour
- Task 2: 30 min
- Task 3: 30 min
- Task 4: 30 min
- **Total: ~2.5 hours**
