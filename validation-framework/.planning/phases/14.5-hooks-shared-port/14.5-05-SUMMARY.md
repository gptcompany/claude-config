---
plan: 14.5-05
status: complete
duration: ~20 minutes
files_created: 5
tests_passing: 19
loc_total: 1747
---

# Plan 14.5-05 Summary: Port Productivity Hooks

## Objective
Port productivity hooks from Python (claude-hooks-shared) to Node.js - formatting, TDD enforcement, checkpointing, and complexity analysis.

## Tasks Completed

### Task 1: auto-format.js (238 LOC)
**Path**: `~/.claude/scripts/hooks/productivity/auto-format.js`

**Hook type**: PostToolUse (for Write, Edit, MultiEdit)

**Behavior**:
- Detects code file changes (.js, .ts, .tsx, .jsx, .mjs, .cjs)
- Runs prettier if available (via npx)
- Runs eslint --fix if available (via npx)
- Reports formatting applied via hookSpecificOutput
- Skips node_modules/, dist/, build/, etc.

**Output format**:
```json
{
  "hookSpecificOutput": {
    "hookEventName": "PostToolUse",
    "message": "Auto-formatted filename.js (prettier + eslint)"
  }
}
```

### Task 2: tdd-guard.js (382 LOC)
**Path**: `~/.claude/scripts/hooks/productivity/tdd-guard.js`

**Hook type**: PreToolUse (for Write, Edit, MultiEdit)

**Behavior**:
- Tracks if tests exist for modified production files
- Checks test file naming conventions (*.test.js, test_*.js, etc.)
- Warns if implementation changed without corresponding test
- Logs TDD compliance metrics to ~/.claude/metrics/tdd_compliance.jsonl

**Guard modes** (configured via ~/.claude/tdd-config.json):
- `strict`: Block changes without tests (exit 1)
- `warn`: Suggest tests (default)
- `off`: Disabled

**Configuration example**:
```json
{
  "mode": "warn",
  "productionPaths": ["src/", "lib/", "app/"],
  "skipPaths": ["tests/", "docs/", "config/"]
}
```

**Output format**:
```json
{
  "hookSpecificOutput": {
    "hookEventName": "PreToolUse",
    "decision": "warn",
    "message": "TDD Warning: No test file found for `util.js`..."
  }
}
```

### Task 3: task-checkpoint.js (360 LOC)
**Path**: `~/.claude/scripts/hooks/productivity/task-checkpoint.js`

**Hook type**: PostToolUse

**Behavior**:
- Tracks task progress during execution
- Auto-checkpoints after N successful tool calls (default: 5)
- Saves checkpoint to ~/.claude/checkpoints/
- Tracks files modified, tool calls, git state

**Checkpoint data saved**:
- Task ID and timestamp
- Project name and branch
- Files modified during session
- Last 10 tool calls
- Git changes summary

**Output format**:
```json
{
  "hookSpecificOutput": {
    "hookEventName": "PostToolUse",
    "message": "Checkpoint created: checkpoint-project-2026-01-24T11-00-00-000Z (5 files, 120 lines)"
  }
}
```

### Task 4: auto-simplify.js (361 LOC)
**Path**: `~/.claude/scripts/hooks/productivity/auto-simplify.js`

**Hook type**: PostToolUse (for Write, Edit, MultiEdit)

**Behavior**:
- Analyzes code complexity indicators after edits
- Detects: function length > 50, nesting > 4, params > 5
- File-level: lines > 300, functions > 15
- Suggests simplification when thresholds exceeded

**Complexity thresholds**:
| Metric | Threshold |
|--------|-----------|
| Function length | 50 lines |
| Nesting depth | 4 levels |
| Parameters | 5 |
| File lines | 300 |
| Functions per file | 15 |

**Output format**:
```json
{
  "hookSpecificOutput": {
    "hookEventName": "PostToolUse",
    "message": "Code Complexity Notice for 'file.js':\n  - Function 'foo' has 65 lines (max: 50)\nConsider refactoring..."
  }
}
```

### Task 5: productivity.test.js (406 LOC)
**Path**: `~/.claude/scripts/hooks/productivity/productivity.test.js`

**Test suites**:
- auto-format: 4 tests
- tdd-guard: 4 tests
- task-checkpoint: 4 tests
- auto-simplify: 5 tests
- Integration: 2 tests

**Result**: 19 tests passing, 0 failures

```bash
$ node --test ~/.claude/scripts/hooks/productivity/productivity.test.js
# tests 19
# suites 5
# pass 19
# fail 0
```

## Verification Checklist

- [x] All 4 productivity hooks exist and run without error
- [x] auto-format runs on code files (prettier/eslint when available)
- [x] tdd-guard checks for tests and warns appropriately
- [x] task-checkpoint creates checkpoints after N tool calls
- [x] auto-simplify analyzes complexity and reports issues
- [x] 19 tests pass (exceeds 12 minimum requirement)

## Metrics

| Metric | Value |
|--------|-------|
| Total LOC | 1,747 |
| Hooks created | 4 |
| Tests | 19 |
| Test suites | 5 |
| Pass rate | 100% |

## File Locations

```
~/.claude/scripts/hooks/productivity/
├── auto-format.js       # 238 LOC - Run prettier/eslint on code files
├── tdd-guard.js         # 382 LOC - Enforce TDD discipline
├── task-checkpoint.js   # 360 LOC - Create progress checkpoints
├── auto-simplify.js     # 361 LOC - Analyze code complexity
└── productivity.test.js # 406 LOC - Unit tests
```

## Dependencies

All hooks use Node.js built-in modules:
- `fs`, `path`, `os` - File system
- `child_process` - Git/npm commands

Optional external tools (detected at runtime):
- `prettier` - Code formatting
- `eslint` - Linting and auto-fix

## Configuration Files

| File | Purpose |
|------|---------|
| `~/.claude/tdd-config.json` | TDD guard mode and paths |
| `~/.claude/checkpoints/` | Checkpoint storage directory |
| `~/.claude/metrics/tdd_compliance.jsonl` | TDD compliance logs |

## Usage Examples

### Hook registration in settings.json
```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Write|Edit|MultiEdit",
        "hooks": [
          "~/.claude/scripts/hooks/productivity/auto-format.js",
          "~/.claude/scripts/hooks/productivity/auto-simplify.js",
          "~/.claude/scripts/hooks/productivity/task-checkpoint.js"
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Write|Edit|MultiEdit",
        "hooks": [
          "~/.claude/scripts/hooks/productivity/tdd-guard.js"
        ]
      }
    ]
  }
}
```

## Ported From

| Node.js | Python Original |
|---------|-----------------|
| auto-format.js | /media/sam/1TB/claude-hooks-shared/hooks/productivity/auto-format.py (130 LOC) |
| tdd-guard.js | /media/sam/1TB/claude-hooks-shared/hooks/productivity/tdd-guard-check.py (256 LOC) |
| task-checkpoint.js | /media/sam/1TB/claude-hooks-shared/hooks/productivity/task-auto-checkpoint.py (179 LOC) |
| auto-simplify.js | /media/sam/1TB/claude-hooks-shared/hooks/productivity/auto-simplify-check.py (136 LOC) |

## Ready for Integration

Productivity hooks can now be registered in Claude Code hooks configuration:
```javascript
const autoFormat = require('~/.claude/scripts/hooks/productivity/auto-format');
const tddGuard = require('~/.claude/scripts/hooks/productivity/tdd-guard');
const taskCheckpoint = require('~/.claude/scripts/hooks/productivity/task-checkpoint');
const autoSimplify = require('~/.claude/scripts/hooks/productivity/auto-simplify');
```
