---
phase: 14.5-hooks-shared-port
plan: 07
type: execute
wave: 4
depends_on: ["14.5-03", "14.5-06"]
files_modified:
  - ~/.claude/scripts/hooks/ux/tips-injector.js
  - ~/.claude/scripts/hooks/ux/session-insights.js
  - ~/.claude/scripts/hooks/control/ralph-loop.js
  - ~/.claude/scripts/hooks/control/hive-manager.js
  - ~/.claude/hooks/hooks.json
autonomous: true
---

<objective>
Port UX and control hooks, update hooks.json configuration.

Purpose: User experience and advanced control features
Output: 4 hook scripts + updated hooks.json (~600 LOC)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14.5-hooks-shared-port/14.5-RESEARCH.md
@.planning/phases/14.5-hooks-shared-port/14.5-01-SUMMARY.md
@.planning/phases/14.5-hooks-shared-port/14.5-03-SUMMARY.md
@.planning/phases/14.5-hooks-shared-port/14.5-06-SUMMARY.md

# Python sources to port:
# /media/sam/1TB/claude-hooks-shared/hooks/ux/tips-auto-inject.py (234 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/ux/session_insights_writer.py (110 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/control/ralph-loop.py (345 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/swarm/hive_manager.py (289 LOC)

# Uses:
# ~/.claude/scripts/lib/utils.js
# ~/.claude/scripts/lib/tips-engine.js
# ~/.claude/scripts/lib/mcp-client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ux directory and tips-injector.js</name>
  <files>~/.claude/scripts/hooks/ux/tips-injector.js</files>
  <action>
1. Create directory: `mkdir -p ~/.claude/scripts/hooks/ux`
2. Port tips-auto-inject.py
3. Hook behavior (UserPromptSubmit):
   - Load tips from tips-engine
   - Match tips to current context
   - Inject top 2 most relevant tips
4. Use tips-engine.js for tip generation
5. Return `{"additionalContext": "Tips: [tip1], [tip2]"}`
  </action>
  <verify>echo '{}' | node ~/.claude/scripts/hooks/ux/tips-injector.js</verify>
  <done>tips-injector.js injects relevant tips</done>
</task>

<task type="auto">
  <name>Task 2: Create session-insights.js</name>
  <files>~/.claude/scripts/hooks/ux/session-insights.js</files>
  <action>
1. Port session_insights_writer.py
2. Hook behavior (Stop - runs LAST):
   - Aggregate data from:
     - context-preservation → context_stats.json
     - session-analyzer → last_session_stats.json
   - Produce unified session_insights.json (SSOT)
3. SSOT structure:
   - session_id, ended_at
   - context: {tokens_used, percentage, status}
   - tips: []
   - summary: {duration_min, tool_calls, errors}
   - git: {uncommitted, lines_added, lines_removed}
4. Read by session-start-tracker on next session
  </action>
  <verify>echo '{"session_id":"test"}' | node ~/.claude/scripts/hooks/ux/session-insights.js</verify>
  <done>session-insights.js creates SSOT for next session</done>
</task>

<task type="auto">
  <name>Task 3: Create control directory and ralph-loop.js</name>
  <files>~/.claude/scripts/hooks/control/ralph-loop.js</files>
  <action>
1. Create directory: `mkdir -p ~/.claude/scripts/hooks/control`
2. Port ralph-loop.py (345 LOC - complex)
3. Ralph mode: iterative debugging with circuit breakers
   - Track iteration count
   - Detect repeated patterns (same error 3x = stuck)
   - Auto-break after max iterations
   - Log iteration state
4. Entry via user command or auto-detection
5. Save state to ~/.claude/ralph/session-state.json
  </action>
  <verify>echo '{}' | node ~/.claude/scripts/hooks/control/ralph-loop.js</verify>
  <done>ralph-loop.js provides iterative debugging mode</done>
</task>

<task type="auto">
  <name>Task 4: Create hive-manager.js</name>
  <files>~/.claude/scripts/hooks/control/hive-manager.js</files>
  <action>
1. Port hive_manager.py
2. Multi-agent coordination (PostToolUse for Task):
   - Track spawned agents
   - Monitor agent status
   - Detect stuck/failed agents
   - Coordinate shared resources
3. Use file-coordination.js for file locking
4. Save hive state to ~/.claude/hive/state.json
5. Return status on agent completion
  </action>
  <verify>echo '{}' | node ~/.claude/scripts/hooks/control/hive-manager.js</verify>
  <done>hive-manager.js coordinates multi-agent work</done>
</task>

<task type="auto">
  <name>Task 5: Update hooks.json with all new hooks</name>
  <files>~/.claude/hooks/hooks.json</files>
  <action>
1. Read existing hooks.json
2. Add all Phase 14.5 hooks:
   - Safety hooks (PreToolUse)
   - Intelligence hooks (UserPromptSubmit, Stop)
   - Quality hooks (PostToolUse)
   - Productivity hooks (PostToolUse)
   - Metrics hooks (PostToolUse)
   - Coordination hooks (PreToolUse)
   - UX hooks (UserPromptSubmit, Stop)
   - Control hooks (various)
3. Organize by event type
4. Validate JSON syntax
  </action>
  <verify>jq . ~/.claude/hooks/hooks.json</verify>
  <done>hooks.json contains all Phase 14.5 hooks</done>
</task>

<task type="auto">
  <name>Task 6: Create UX/control tests</name>
  <files>~/.claude/scripts/hooks/ux/ux.test.js</files>
  <action>
1. Test each hook:
   - tips-injector: tip matching, injection limiting
   - session-insights: SSOT aggregation
   - ralph-loop: iteration tracking, circuit breaker
   - hive-manager: agent coordination
2. Minimum 12 tests (3 per hook)
  </action>
  <verify>node --test ~/.claude/scripts/hooks/ux/ux.test.js</verify>
  <done>All UX/control tests pass</done>
</task>

<task type="auto">
  <name>Task 7: Integration test - full hook chain</name>
  <files>~/.claude/scripts/hooks/integration.test.js</files>
  <action>
1. Test complete hook chain:
   - Session start → tips injection → intelligence hooks
   - Tool use → safety check → productivity hooks → quality hooks
   - Session end → analyzer → insights → SSOT
2. Verify hooks don't block each other
3. Verify state persists across hooks
4. Minimum 8 integration tests
  </action>
  <verify>node --test ~/.claude/scripts/hooks/integration.test.js</verify>
  <done>Integration tests verify full hook chain</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 4 new hooks exist and run without error
- [ ] hooks.json updated with all Phase 14.5 hooks
- [ ] tips-injector injects relevant tips
- [ ] session-insights creates SSOT
- [ ] ralph-loop tracks iterations
- [ ] hive-manager coordinates agents
- [ ] 20+ tests pass (unit + integration)
</verification>

<success_criteria>
- 4 UX/control hooks ported to Node.js
- hooks.json updated with ~40 hook bindings
- Integration tests verify hook chain
- 20+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/14.5-hooks-shared-port/14.5-07-SUMMARY.md`
</output>
