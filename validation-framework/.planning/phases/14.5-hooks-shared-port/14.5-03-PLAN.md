---
phase: 14.5-hooks-shared-port
plan: 03
type: execute
wave: 2
depends_on: ["14.5-01"]
files_modified:
  - ~/.claude/scripts/hooks/intelligence/session-start-tracker.js
  - ~/.claude/scripts/hooks/intelligence/session-analyzer.js
  - ~/.claude/scripts/hooks/intelligence/meta-learning.js
  - ~/.claude/scripts/hooks/intelligence/lesson-injector.js
autonomous: true
---

<objective>
Port intelligence hooks - session tracking, analysis, and learning.

Purpose: Smart session context and continuous learning
Output: 4 intelligence hook scripts (~1200 LOC)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14.5-hooks-shared-port/14.5-RESEARCH.md
@.planning/phases/14.5-hooks-shared-port/14.5-01-SUMMARY.md

# Python sources to port:
# /media/sam/1TB/claude-hooks-shared/hooks/intelligence/session_start_tracker.py (296 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/intelligence/session_analyzer.py (456 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/intelligence/meta_learning.py (312 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/intelligence/lesson_injector.py (245 LOC)

# Uses:
# ~/.claude/scripts/lib/utils.js
# ~/.claude/scripts/lib/git-utils.js
# ~/.claude/scripts/lib/metrics.js
# ~/.claude/scripts/lib/mcp-client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create intelligence directory and session-start-tracker.js</name>
  <files>~/.claude/scripts/hooks/intelligence/session-start-tracker.js</files>
  <action>
1. Create directory: `mkdir -p ~/.claude/scripts/hooks/intelligence`
2. Port session_start_tracker.py
3. MERGE with ECC's package manager detection from session-start.js
4. Hook behavior (UserPromptSubmit):
   - Detect new session vs continuation (30 min timeout)
   - Track git state: commit, branch, repo root
   - Inject previous session insights (from SSOT)
   - Detect package manager, show prompt if not configured
   - Track prompt count
5. Save session state to metrics
6. Return `{"additionalContext": "..."}` for context injection
  </action>
  <verify>echo '{}' | node ~/.claude/scripts/hooks/intelligence/session-start-tracker.js</verify>
  <done>session-start-tracker.js detects sessions and injects context</done>
</task>

<task type="auto">
  <name>Task 2: Create session-analyzer.js</name>
  <files>~/.claude/scripts/hooks/intelligence/session-analyzer.js</files>
  <action>
1. Port session_analyzer.py (456 LOC - largest hook)
2. Hook behavior (Stop):
   - Analyze uncommitted git changes (lines, files, categories)
   - Parse session metrics (tool calls, errors, error rate)
   - Get commits made during session
   - Generate contextual suggestions based on thresholds:
     - Priority 1: /undo:checkpoint if high error rate
     - Priority 2: /health if multiple config changes
     - Priority 3: /review if significant uncommitted changes
     - Priority 4: /context if long session
3. Save stats for next session injection
4. Return `{"systemMessage": "formatted stats"}`
  </action>
  <verify>echo '{"session":{"tool_calls":10,"errors":2}}' | node ~/.claude/scripts/hooks/intelligence/session-analyzer.js</verify>
  <done>session-analyzer.js analyzes sessions and generates suggestions</done>
</task>

<task type="auto">
  <name>Task 3: Create meta-learning.js</name>
  <files>~/.claude/scripts/hooks/intelligence/meta-learning.js</files>
  <action>
1. Port meta_learning.py
2. Hook behavior (Stop):
   - Extract patterns from session:
     - high_rework: >3 edits on same file
     - high_error: >25% error rate
     - quality_drop: declining quality trend
   - Calculate confidence scores
   - Store patterns via mcp-client for SONA learning
3. Load trajectory data, session analysis, file edit counts
4. Pattern structure: {type, confidence, metadata}
  </action>
  <verify>echo '{}' | node ~/.claude/scripts/hooks/intelligence/meta-learning.js</verify>
  <done>meta-learning.js extracts and stores patterns</done>
</task>

<task type="auto">
  <name>Task 4: Create lesson-injector.js</name>
  <files>~/.claude/scripts/hooks/intelligence/lesson-injector.js</files>
  <action>
1. Port lesson_injector.py
2. Hook behavior (UserPromptSubmit):
   - Load learned lessons from ~/.claude/lessons/
   - Match lessons to current context (file types, commands)
   - Inject relevant lessons into context
3. Lesson structure: {trigger, lesson, confidence, lastUsed}
4. Maximum 3 lessons per injection to avoid context bloat
5. Return `{"additionalContext": "Lessons: ..."}`
  </action>
  <verify>echo '{}' | node ~/.claude/scripts/hooks/intelligence/lesson-injector.js</verify>
  <done>lesson-injector.js injects relevant lessons</done>
</task>

<task type="auto">
  <name>Task 5: Create intelligence tests</name>
  <files>~/.claude/scripts/hooks/intelligence/intelligence.test.js</files>
  <action>
1. Test each intelligence hook:
   - session-start-tracker: new session detection, context injection
   - session-analyzer: suggestion generation, stats formatting
   - meta-learning: pattern extraction, confidence calculation
   - lesson-injector: lesson matching, injection limiting
2. Minimum 20 tests (5 per hook)
  </action>
  <verify>node --test ~/.claude/scripts/hooks/intelligence/intelligence.test.js</verify>
  <done>All intelligence tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 4 intelligence hooks exist and run without error
- [ ] session-start-tracker detects new sessions
- [ ] session-analyzer generates suggestions
- [ ] meta-learning extracts patterns
- [ ] lesson-injector injects context
- [ ] 20+ tests pass
</verification>

<success_criteria>
- 4 intelligence hooks ported to Node.js
- Session tracking works correctly
- Pattern extraction produces valid patterns
- 20+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/14.5-hooks-shared-port/14.5-03-SUMMARY.md`
</output>
