---
phase: 14.5-hooks-shared-port
plan: 02
type: execute
wave: 1
depends_on: ["14.5-01"]
files_modified:
  - ~/.claude/scripts/hooks/safety/git-safety-check.js
  - ~/.claude/scripts/hooks/safety/smart-safety-check.js
  - ~/.claude/scripts/hooks/safety/port-conflict-check.js
  - ~/.claude/scripts/hooks/safety/ci-batch-check.js
autonomous: true
---

<objective>
Port safety hooks - CRITICAL for preventing destructive operations.

Purpose: Guard rails for git, ports, and CI operations
Output: 4 safety hook scripts (~600 LOC)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14.5-hooks-shared-port/14.5-RESEARCH.md
@.planning/phases/14.5-hooks-shared-port/14.5-01-SUMMARY.md

# Python sources to port:
# /media/sam/1TB/claude-hooks-shared/hooks/safety/git-safety-check.py (198 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/safety/smart-safety-check.py (267 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/safety/port-conflict-check.py (89 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/safety/ci-batch-check.py (156 LOC)

# Uses:
# ~/.claude/scripts/lib/utils.js
# ~/.claude/scripts/lib/git-utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create safety directory and git-safety-check.js</name>
  <files>~/.claude/scripts/hooks/safety/git-safety-check.js</files>
  <action>
1. Create directory: `mkdir -p ~/.claude/scripts/hooks/safety`
2. Port git-safety-check.py
3. Hook behavior (PreToolUse for Bash):
   - Parse command from tool_input
   - Block destructive git commands:
     - `git push --force` (especially to main/master)
     - `git reset --hard`
     - `git clean -f`
     - `git checkout .` (discards all changes)
     - `git branch -D` (force delete)
   - Return `{"decision": "block", "reason": "..."}` for blocked
   - Return `{}` to allow
4. Exception: allow if user explicitly confirms
  </action>
  <verify>echo '{"tool_name":"Bash","tool_input":{"command":"git status"}}' | node ~/.claude/scripts/hooks/safety/git-safety-check.js</verify>
  <done>git-safety-check.js blocks destructive commands, allows safe ones</done>
</task>

<task type="auto">
  <name>Task 2: Create smart-safety-check.js</name>
  <files>~/.claude/scripts/hooks/safety/smart-safety-check.js</files>
  <action>
1. Port smart-safety-check.py
2. Multi-pattern safety validation (PreToolUse for Bash):
   - Block `rm -rf /` or dangerous rm patterns
   - Block `sudo` unless whitelisted
   - Block `chmod 777`
   - Block secrets in command (grep for API_KEY, TOKEN, etc)
   - Warn on `curl | bash` patterns
3. Return appropriate decision:
   - `{"decision": "block", "reason": "..."}`
   - `{"decision": "warn", "message": "..."}`
   - `{}`
4. Configurable via ~/.claude/safety-config.json
  </action>
  <verify>echo '{"tool_name":"Bash","tool_input":{"command":"ls -la"}}' | node ~/.claude/scripts/hooks/safety/smart-safety-check.js</verify>
  <done>smart-safety-check.js blocks dangerous patterns</done>
</task>

<task type="auto">
  <name>Task 3: Create port-conflict-check.js</name>
  <files>~/.claude/scripts/hooks/safety/port-conflict-check.js</files>
  <action>
1. Port port-conflict-check.py
2. Hook behavior (PreToolUse for Bash):
   - Detect commands that start servers (npm run dev, python -m http.server, etc)
   - Check if target port is in use: `lsof -i :PORT` or `netstat`
   - Warn if port conflict detected
3. Parse common port patterns:
   - `--port N`, `-p N`, `:N` patterns
   - Default ports for common commands
4. Return `{"decision": "warn", "message": "Port XXXX already in use"}`
  </action>
  <verify>echo '{"tool_name":"Bash","tool_input":{"command":"npm run dev"}}' | node ~/.claude/scripts/hooks/safety/port-conflict-check.js</verify>
  <done>port-conflict-check.js detects port conflicts</done>
</task>

<task type="auto">
  <name>Task 4: Create ci-batch-check.js</name>
  <files>~/.claude/scripts/hooks/safety/ci-batch-check.js</files>
  <action>
1. Port ci-batch-check.py
2. Hook behavior (PreToolUse for Bash):
   - Detect CI-affecting batch operations
   - Block/warn on:
     - Multiple `git push` in single session without PR review
     - Repeated force-pushes
     - Mass file deletions before commit
3. Track operations in session state file
4. Thresholds configurable via ~/.claude/ci-config.json
  </action>
  <verify>echo '{"tool_name":"Bash","tool_input":{"command":"git push origin feature"}}' | node ~/.claude/scripts/hooks/safety/ci-batch-check.js</verify>
  <done>ci-batch-check.js tracks and guards CI operations</done>
</task>

<task type="auto">
  <name>Task 5: Create safety tests</name>
  <files>~/.claude/scripts/hooks/safety/safety.test.js</files>
  <action>
1. Test each safety hook:
   - git-safety: blocks force push, allows status
   - smart-safety: blocks rm -rf, allows safe commands
   - port-conflict: detects port usage patterns
   - ci-batch: tracks push count
2. Minimum 16 tests (4 per hook)
  </action>
  <verify>node --test ~/.claude/scripts/hooks/safety/safety.test.js</verify>
  <done>All safety tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 4 safety hooks exist and run without error
- [ ] git-safety blocks destructive commands
- [ ] smart-safety blocks dangerous patterns
- [ ] port-conflict detects port usage
- [ ] ci-batch tracks operations
- [ ] 16+ tests pass
</verification>

<success_criteria>
- 4 safety hooks ported to Node.js
- All hooks block/warn appropriately
- No false positives on safe commands
- 16+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/14.5-hooks-shared-port/14.5-02-SUMMARY.md`
</output>
