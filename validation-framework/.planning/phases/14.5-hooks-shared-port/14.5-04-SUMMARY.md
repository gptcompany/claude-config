---
plan: 14.5-04
status: complete
duration: ~35 minutes
files_created: 6
tests_passing: 24
loc_total: 2349
---

# Plan 14.5-04 Summary: Port Quality Hooks

## Objective
Port quality hooks from Python claude-hooks-shared to Node.js - CI, PR, and documentation quality.

## Tasks Completed

### Task 1: ci-autofix.js (355 LOC)
**Path**: `~/.claude/scripts/hooks/quality/ci-autofix.js`

**Hook Type**: PostToolUse (Bash when command contains CI/test commands)

**Functions implemented**:
- `isCiCommand(command)` - Detect pytest, npm test, cargo test, etc.
- `hasFailure(output)` - Detect failure patterns (FAILED, Error:, etc.)
- `extractErrorContext(output, command)` - Parse error details
- `generateFixInstruction(context)` - Create actionable fix guidance
- `getRetryState()` / `saveRetryState()` - Persist retry count
- Retry logic: up to 3 attempts with exponential backoff

**Verification**:
```bash
$ echo '{"tool_name":"Bash","tool_input":{"command":"pytest"},"tool_result":"FAILED"}' | node ~/.claude/scripts/hooks/quality/ci-autofix.js
{"continue":true,"systemMessage":"CI failure detected (attempt 1/3)..."}
```

### Task 2: plan-validator.js (263 LOC)
**Path**: `~/.claude/scripts/hooks/quality/plan-validator.js`

**Hook Type**: PostToolUse (Write when file = *-PLAN.md or /plans/*.md)

**Functions implemented**:
- `parseFrontmatter(content)` - Extract YAML frontmatter
- `extractTasks(content)` - Parse <task> blocks
- `validatePlan(content)` - Check structure and PMW issues
- `isPlanFile(filePath)` - Detect plan files

**PMW Checks**:
- COMPLEXITY: >3 classes in code blocks
- PERF: Subprocess calls without caching
- DATA: Assumed JSON files that may not exist
- SIZE: >200 LOC in plan
- SCOPE: >10 files to modify

**Verification**:
```bash
$ echo '{"tool_name":"Write","tool_input":{"file_path":"test-PLAN.md","content":"# No frontmatter"}}' | node ~/.claude/scripts/hooks/quality/plan-validator.js
{"systemMessage":"Plan validation...Issues: Missing YAML frontmatter..."}
```

### Task 3: pr-readiness.js (498 LOC)
**Path**: `~/.claude/scripts/hooks/quality/pr-readiness.js`

**Hook Type**: PreToolUse (Bash when command = gh pr create)

**Functions implemented**:
- `getGitDiffStats()` - Lines changed vs base branch
- `checkPhaseCompletion()` - Parse tasks.md for completion %
- `checkTestsPassing()` - Check pytest/jest cache for results
- `checkCoverage()` - Parse coverage.json files
- `checkCleanWorkingDir()` - Verify no uncommitted changes
- `calculateEnsembleScore(criteria)` - Weighted scoring
- `formatOutput(criteria, ensemble)` - Visual breakdown

**Weights**:
- Git Diff: 10%
- Phase Complete: 25%
- Tests Green: 30%
- Coverage: 20%
- Clean Working Dir: 15%

**Verification**:
```bash
$ echo '{"tool_name":"Bash","tool_input":{"command":"gh pr create"}}' | node ~/.claude/scripts/hooks/quality/pr-readiness.js
{"systemMessage":"[NOT READY] PR READINESS: Score: 59/100..."}
```

### Task 4: architecture-validator.js (351 LOC)
**Path**: `~/.claude/scripts/hooks/quality/architecture-validator.js`

**Hook Type**: PostToolUse (Write/Edit for src/, lib/, components/, etc.)

**Functions implemented**:
- `isArchitectureRelevant(filePath)` - Check if file affects architecture
- `findArchitectureFile(projectDir)` - Locate ARCHITECTURE.md
- `extractComponents(content, filePath)` - Parse classes, functions, interfaces
- `isComponentDocumented(component, architectureContent)` - Check existing docs
- `categorizeFile(filePath)` - Classify into API, Services, Hooks, etc.
- `generateSuggestion(components, filePath, architectureFile)` - Create update suggestion

**Component Patterns Detected**:
- JavaScript/TypeScript: class, function, const_function, interface, type
- Python: class, def
- Rust: struct, impl

**Verification**:
```bash
$ echo '{"tool_name":"Write","tool_input":{"file_path":"src/new-component.js","content":"export class MyService {}"}}' | node ~/.claude/scripts/hooks/quality/architecture-validator.js
{"systemMessage":"## Architecture Update Suggested...New components: MyService (class)"}
```

### Task 5: readme-generator.js (403 LOC)
**Path**: `~/.claude/scripts/hooks/quality/readme-generator.js`

**Hook Type**: PostToolUse (Write/Edit for package.json, src/, etc.)

**Functions implemented**:
- `isReadmeRelevant(filePath)` - Check if file triggers README review
- `findReadmeFile(projectDir)` - Locate README.md
- `getCommitsSinceReadmeChange()` - Rate limit checks
- `analyzeReadme(content)` - Detect existing sections
- `detectNeededUpdates(filePath, readmeContent)` - Find missing/outdated sections
- `extractPackageInfo(projectDir)` - Parse package.json/pyproject.toml
- `generateSuggestion(filePath, updates, readmeFile, packageInfo)` - Create suggestion

**Sections Tracked**:
- Installation (package.json, requirements.txt)
- Usage (src/, lib/)
- Configuration (.env.example, config/)
- API (api/, routes/)
- Development (Makefile, Dockerfile)

**Verification**:
```bash
$ echo '{"tool_name":"Edit","tool_input":{"file_path":"package.json"}}' | node ~/.claude/scripts/hooks/quality/readme-generator.js
# Silent output if recently checked
```

### Task 6: quality.test.js (479 LOC)
**Path**: `~/.claude/scripts/hooks/quality/quality.test.js`

**Test suites**:
- `ci-autofix` - 4 tests
- `plan-validator` - 4 tests
- `pr-readiness` - 4 tests
- `architecture-validator` - 4 tests
- `readme-generator` - 5 tests
- `integration` - 3 tests

**Result**: 24 tests passing, 0 failures

```bash
$ node --test ~/.claude/scripts/hooks/quality/quality.test.js
# tests 24
# suites 6
# pass 24
# fail 0
```

## Verification Checklist

- [x] All 5 quality hooks exist and run without error
- [x] ci-autofix detects failures and suggests retries
- [x] plan-validator validates structure and PMW checks
- [x] pr-readiness checks prerequisites with ensemble scoring
- [x] architecture-validator detects new components
- [x] readme-generator suggests documentation updates
- [x] 24 tests pass (exceeds 15 minimum)

## Metrics

| Metric | Value |
|--------|-------|
| Total LOC | 2,349 |
| Hooks | 5 |
| Tests | 24 |
| Test suites | 6 |
| Pass rate | 100% |

## File Locations

```
~/.claude/scripts/hooks/quality/
├── ci-autofix.js            # 355 LOC - CI failure detection and retry
├── plan-validator.js        # 263 LOC - GSD plan structure validation
├── pr-readiness.js          # 498 LOC - PR prerequisite checking
├── architecture-validator.js # 351 LOC - Component detection
├── readme-generator.js       # 403 LOC - README update suggestions
└── quality.test.js          # 479 LOC - Unit tests
```

## Dependencies

All hooks use these shared libraries:
- `~/.claude/scripts/lib/utils.js` - Core utilities
- `~/.claude/scripts/lib/git-utils.js` - Git operations

## Hook Registration

These hooks should be registered in `~/.claude/scripts/hooks/hooks.json`:

```json
{
  "hooks": [
    {
      "name": "ci-autofix",
      "type": "PostToolUse",
      "matcher": {"toolName": "Bash"},
      "script": "~/.claude/scripts/hooks/quality/ci-autofix.js"
    },
    {
      "name": "plan-validator",
      "type": "PostToolUse",
      "matcher": {"toolName": "Write"},
      "script": "~/.claude/scripts/hooks/quality/plan-validator.js"
    },
    {
      "name": "pr-readiness",
      "type": "PreToolUse",
      "matcher": {"toolName": "Bash"},
      "script": "~/.claude/scripts/hooks/quality/pr-readiness.js"
    },
    {
      "name": "architecture-validator",
      "type": "PostToolUse",
      "matcher": {"toolName": ["Write", "Edit"]},
      "script": "~/.claude/scripts/hooks/quality/architecture-validator.js"
    },
    {
      "name": "readme-generator",
      "type": "PostToolUse",
      "matcher": {"toolName": ["Write", "Edit"]},
      "script": "~/.claude/scripts/hooks/quality/readme-generator.js"
    }
  ]
}
```

## Ready for Next Plan

Plan 14.5-05 (Safety Hooks) can now be executed.
