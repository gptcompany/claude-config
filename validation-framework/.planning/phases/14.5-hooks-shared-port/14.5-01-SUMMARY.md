---
plan: 14.5-01
status: complete
duration: ~25 minutes
files_created: 5
tests_passing: 48
loc_total: 2681
---

# Plan 14.5-01 Summary: Create Shared Node.js Libraries

## Objective
Create shared Node.js libraries that hooks will depend on, porting functionality from Python claude-hooks-shared.

## Tasks Completed

### Task 1: mcp-client.js (387 LOC)
**Path**: `~/.claude/scripts/lib/mcp-client.js`

**Functions implemented**:
- `getProjectName()` - Gets project name from env or git repo
- `getTimestamp()` - Returns ISO timestamp
- `memoryStore(key, value, namespace)` - Store to ~/.claude-flow/memory/store.json
- `memoryRetrieve(key, namespace)` - Retrieve from memory
- `memoryList(namespace)` - List all keys
- `memoryDelete(key, namespace)` - Delete key
- `memorySearch(prefix)` - Search by prefix
- `patternStore(pattern, type, confidence, metadata)` - Store learning pattern
- `patternSearch(query, type, minConfidence, limit)` - Search patterns
- `getProjectPatterns(limit)` - Get patterns for current project

**Verification**:
```bash
$ node -e "const m = require('$HOME/.claude/scripts/lib/mcp-client'); console.log(m.getProjectName())"
lib
```

### Task 2: git-utils.js (471 LOC)
**Path**: `~/.claude/scripts/lib/git-utils.js`

**Functions implemented**:
- `runGitCommand(args, timeout, cwd)` - Safe git execution with timeout
- `isGitRepo()` - Check if in git repo
- `getCurrentCommit(short)` - HEAD commit hash
- `getCurrentBranch()` - Current branch name
- `getRepoRoot()` - Git root directory
- `getUncommittedChanges()` - {hasChanges, linesAdded, linesDeleted, files, staged, unstaged, untracked}
- `getSessionCommits(startCommit)` - Commits since startCommit
- `getCommitCount(start, end)` - Count commits between refs
- `categorizeFile(path)` - 'code'|'test'|'config'|'docs'|'other'
- `getCommitFiles(commit)` - Files changed in commit
- `getFileDiff(filePath, staged)` - Get file diff
- `getBlame(filePath, line)` - Blame info
- `getRemoteUrl(remote)` - Remote URL
- `getBranches()` - Local branches

**Verification**:
```bash
$ node -e "const g = require('$HOME/.claude/scripts/lib/git-utils'); console.log(g.getCurrentBranch())"
main
```

### Task 3: metrics.js (635 LOC)
**Path**: `~/.claude/scripts/lib/metrics.js`

**LOCAL storage** (`~/.claude/metrics/`):
- `saveMetric(name, value, tags)` - Append to metrics.jsonl
- `loadMetric(name, limit)` - Load metric history
- `saveSessionState(state)` - Save session_state.json
- `loadSessionState()` - Load session state
- `clearSessionState()` - Delete session state
- `saveContextStats(stats)` - Save context_stats.json
- `loadContextStats()` - Load context stats

**QuestDB ILP export** (port 9009):
- `exportToQuestDB(table, values, tags)` - Async ILP send
- `exportBatchToQuestDB(table, rows)` - Batch export
- `buildIlpLine(table, tags, fields, timestamp)` - Build ILP format

**QuestDB REST query** (port 9000):
- `queryQuestDB(sql, timeout)` - Execute SQL query
- `checkQuestDBHealth()` - Health check

**Dual-write helpers**:
- `recordSession(data)` - Record session (local + QuestDB)
- `recordToolUsage(data)` - Record tool usage
- `recordHookInvocation(data)` - Record hook invocation
- `recordTipOutcome(data)` - Record tip outcome

**Verification**:
```bash
$ node -e "const m = require('$HOME/.claude/scripts/lib/metrics'); m.saveMetric('test', 42, {}); console.log(m.loadMetric('test', 1));"
[ { timestamp: '2026-01-24T10:59:11.395Z', name: 'test', value: 42, tags: {} } ]
```

### Task 4: tips-engine.js (663 LOC)
**Path**: `~/.claude/scripts/lib/tips-engine.js`

**Functions implemented**:
- `loadTips(category)` - Load tips from category file
- `saveTips(category, tips)` - Save tips to category file
- `generateTips(sessionData, historical)` - Analyze session and generate tips
- `scoreTip(tip, context)` - Calculate relevance score (0-1)
- `formatTips(tips, maxCount, coldStart)` - Format tips for display
- `saveTipsForNextSession(tips, sessionId, project)` - Persist for injection
- `loadNextSessionTips()` - Load saved tips
- `clearNextSessionTips()` - Clear after injection
- `recordTipHistory(tip, outcome)` - Record to history.jsonl
- `tipsToDict(tips, sessionId, project, historical)` - JSON serializable format
- `selectBestCommand(category, historical, failedCommands)` - Pick best command
- `calculateConfidence(ruleName, session, historical)` - Confidence scoring

**Pattern Rules**:
- `high_error_rate` - DORA threshold + z-score
- `stuck_in_loop` - >5 iterations
- `high_rework` - >30% rework rate
- `no_tests` - File edits without tests
- `large_change_size` - >400 lines
- `too_many_files` - >10 files
- `high_churn_single_file` - Same file edited 5+ times
- `low_test_pass_rate` - <60% pass rate
- `long_session` - >1 hour

**Verification**:
```bash
$ node -e "const t = require('$HOME/.claude/scripts/lib/tips-engine'); console.log(t.formatTips([]))"
(empty string - correct for no tips)
```

### Task 5: Unit Tests (525 LOC)
**Path**: `~/.claude/scripts/lib/core-libs.test.js`

**Test suites**:
- `mcp-client` - 9 tests
- `git-utils` - 11 tests
- `metrics` - 7 tests
- `tips-engine` - 19 tests
- `integration` - 2 tests

**Result**: 48 tests passing, 0 failures

```bash
$ node --test ~/.claude/scripts/lib/core-libs.test.js
# tests 48
# suites 5
# pass 48
# fail 0
```

## Verification Checklist

- [x] All 4 library files exist and load without error
- [x] Each library exports documented functions
- [x] Tests pass (48 tests, exceeds 20 minimum)
- [x] Libraries work on Linux (tested on Ubuntu 22.04)

## Metrics

| Metric | Value |
|--------|-------|
| Total LOC | 2,681 |
| Libraries | 4 |
| Functions exported | 47 |
| Tests | 48 |
| Test suites | 5 |
| Pass rate | 100% |

## File Locations

```
~/.claude/scripts/lib/
├── mcp-client.js      # 387 LOC - Memory/pattern storage
├── git-utils.js       # 471 LOC - Git operations
├── metrics.js         # 635 LOC - Metrics with QuestDB
├── tips-engine.js     # 663 LOC - Tips generation
└── core-libs.test.js  # 525 LOC - Unit tests
```

## Dependencies

All libraries use Node.js built-in modules only:
- `fs`, `path`, `os` - File system
- `child_process` - Git commands
- `net` - QuestDB ILP socket
- `http` - QuestDB REST API

## Ready for Next Plan

Plan 14.5-02 (Session Hooks) can now use these libraries:
```javascript
const { memoryStore, memoryRetrieve, getProjectName } = require('./mcp-client');
const { getCurrentCommit, getUncommittedChanges } = require('./git-utils');
const { saveSessionState, recordSession } = require('./metrics');
const { generateTips, formatTips, saveTipsForNextSession } = require('./tips-engine');
```
