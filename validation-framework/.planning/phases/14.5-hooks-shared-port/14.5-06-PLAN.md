---
phase: 14.5-hooks-shared-port
plan: 06
type: execute
wave: 3
depends_on: ["14.5-01"]
files_modified:
  - ~/.claude/scripts/hooks/metrics/dora-tracker.js
  - ~/.claude/scripts/hooks/metrics/quality-score.js
  - ~/.claude/scripts/hooks/metrics/claudeflow-sync.js
  - ~/.claude/scripts/hooks/coordination/file-coordination.js
  - ~/.claude/scripts/hooks/coordination/task-coordination.js
autonomous: true
---

<objective>
Port metrics and coordination hooks - DORA tracking and multi-agent coordination.

Purpose: Metrics collection and multi-agent file/task locking
Output: 5 hook scripts (~700 LOC)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14.5-hooks-shared-port/14.5-RESEARCH.md
@.planning/phases/14.5-hooks-shared-port/14.5-01-SUMMARY.md

# Python sources to port:
# /media/sam/1TB/claude-hooks-shared/hooks/metrics/dora-tracker.py (234 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/metrics/quality-score-tracker.py (267 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/metrics/claudeflow-sync.py (189 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/coordination/file_claim.py (167 LOC)
# /media/sam/1TB/claude-hooks-shared/hooks/coordination/task_claim.py (178 LOC)

# Uses:
# ~/.claude/scripts/lib/utils.js
# ~/.claude/scripts/lib/metrics.js
# ~/.claude/scripts/lib/mcp-client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create metrics directory and dora-tracker.js</name>
  <files>~/.claude/scripts/hooks/metrics/dora-tracker.js</files>
  <action>
1. Create directory: `mkdir -p ~/.claude/scripts/hooks/metrics`
2. Port dora-tracker.py
3. Track DORA metrics (PostToolUse for git commands):
   - Deployment Frequency: track git push/merge events
   - Lead Time: time from first commit to merge
   - Change Failure Rate: track rollbacks
   - Mean Time to Recovery: time to fix failures
4. Save metrics to ~/.claude/metrics/dora/
5. Format: {metric, value, timestamp, project}
  </action>
  <verify>echo '{"tool_name":"Bash","tool_input":{"command":"git push"}}' | node ~/.claude/scripts/hooks/metrics/dora-tracker.js</verify>
  <done>dora-tracker.js tracks DORA metrics</done>
</task>

<task type="auto">
  <name>Task 2: Create quality-score.js</name>
  <files>~/.claude/scripts/hooks/metrics/quality-score.js</files>
  <action>
1. Port quality-score-tracker.py
2. Track quality metrics (PostToolUse):
   - Test coverage changes
   - Error rate
   - Code complexity delta
   - Documentation ratio
3. Calculate composite quality score (0-100)
4. Save to ~/.claude/metrics/quality/
5. Return `{"systemMessage": "Quality score: [N]"}` on significant changes
  </action>
  <verify>echo '{"tool_name":"Bash","tool_output":"Tests: 45/45 passed"}' | node ~/.claude/scripts/hooks/metrics/quality-score.js</verify>
  <done>quality-score.js tracks quality metrics</done>
</task>

<task type="auto">
  <name>Task 3: Create claudeflow-sync.js</name>
  <files>~/.claude/scripts/hooks/metrics/claudeflow-sync.js</files>
  <action>
1. Port claudeflow-sync.py
2. Sync state with claude-flow (PostToolUse):
   - Save session state to claude-flow memory
   - Track agent spawns
   - Sync task progress
3. Use mcp-client.js for storage
4. Enable crash recovery by persisting state
  </action>
  <verify>echo '{}' | node ~/.claude/scripts/hooks/metrics/claudeflow-sync.js</verify>
  <done>claudeflow-sync.js syncs with claude-flow</done>
</task>

<task type="auto">
  <name>Task 4: Create coordination directory and file-coordination.js</name>
  <files>~/.claude/scripts/hooks/coordination/file-coordination.js</files>
  <action>
1. Create directory: `mkdir -p ~/.claude/scripts/hooks/coordination`
2. Combine file_claim.py and file_release.py
3. Hook behavior (PreToolUse for Edit/Write):
   - Check if file is claimed by another agent
   - Claim file if available
   - Auto-release after successful edit
4. Claims stored in ~/.claude/coordination/claims.json
5. Format: {file, agent, timestamp, expiry}
6. Block if claimed by another agent
  </action>
  <verify>echo '{"tool_name":"Edit","tool_input":{"file_path":"src/shared.js"}}' | node ~/.claude/scripts/hooks/coordination/file-coordination.js</verify>
  <done>file-coordination.js manages file locking</done>
</task>

<task type="auto">
  <name>Task 5: Create task-coordination.js</name>
  <files>~/.claude/scripts/hooks/coordination/task-coordination.js</files>
  <action>
1. Combine task_claim.py and task_release.py
2. Hook behavior:
   - Track task assignments across agents
   - Prevent duplicate work
   - Auto-release stale claims (>1 hour)
3. Claims stored in ~/.claude/coordination/task-claims.json
4. Integrate with TaskList tool
  </action>
  <verify>echo '{}' | node ~/.claude/scripts/hooks/coordination/task-coordination.js</verify>
  <done>task-coordination.js manages task locking</done>
</task>

<task type="auto">
  <name>Task 6: Create metrics/coordination tests</name>
  <files>~/.claude/scripts/hooks/metrics/metrics.test.js</files>
  <action>
1. Test each hook:
   - dora-tracker: metric calculation
   - quality-score: score calculation
   - claudeflow-sync: state persistence
   - file-coordination: claim/release cycle
   - task-coordination: task locking
2. Minimum 15 tests (3 per hook)
  </action>
  <verify>node --test ~/.claude/scripts/hooks/metrics/metrics.test.js</verify>
  <done>All metrics/coordination tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 5 hooks exist and run without error
- [ ] DORA metrics are tracked
- [ ] Quality score is calculated
- [ ] File coordination prevents conflicts
- [ ] Task coordination prevents duplicates
- [ ] 15+ tests pass
</verification>

<success_criteria>
- 5 hooks ported to Node.js
- Multi-agent coordination works
- Metrics are persisted correctly
- 15+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/14.5-hooks-shared-port/14.5-06-SUMMARY.md`
</output>
