---
phase: 14.5-hooks-shared-port
plan: 01
type: execute
wave: 1
depends_on: ["14-05"]
files_modified:
  - ~/.claude/scripts/lib/mcp-client.js
  - ~/.claude/scripts/lib/git-utils.js
  - ~/.claude/scripts/lib/metrics.js
  - ~/.claude/scripts/lib/tips-engine.js
autonomous: true
---

<objective>
Create shared Node.js libraries that hooks will depend on.

Purpose: Foundation libraries for all hooks in Phase 14.5
Output: 4 library files (~800 LOC)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14.5-hooks-shared-port/14.5-RESEARCH.md

# Python sources to port:
# /media/sam/1TB/claude-hooks-shared/hooks/core/mcp_client.py (189 LOC)
# /media/sam/1TB/claude-hooks-shared/scripts/questdb_client.py (189 LOC)
# /media/sam/1TB/claude-hooks-shared/scripts/tips_engine.py (312 LOC)

# Uses existing:
# ~/.claude/scripts/lib/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mcp-client.js</name>
  <files>~/.claude/scripts/lib/mcp-client.js</files>
  <action>
1. Port `/media/sam/1TB/claude-hooks-shared/hooks/core/mcp_client.py`
2. Implement:
   - `getProjectName()` - current directory name
   - `getTimestamp()` - ISO timestamp
   - `memoryStore(key, value, namespace)` - store to ~/.claude-flow/memory/
   - `memoryRetrieve(key, namespace)` - retrieve from memory
   - `patternStore(pattern, type, confidence, metadata)` - store learning pattern
3. Use JSON file storage at `~/.claude-flow/memory/store.json`
4. Export all functions
5. Handle errors gracefully (don't throw, return null/false)
  </action>
  <verify>node -e "const m = require('$HOME/.claude/scripts/lib/mcp-client'); console.log(m.getProjectName())"</verify>
  <done>mcp-client.js exports all functions and loads without error</done>
</task>

<task type="auto">
  <name>Task 2: Create git-utils.js</name>
  <files>~/.claude/scripts/lib/git-utils.js</files>
  <action>
1. Create Git utility library for hooks
2. Implement:
   - `getCurrentCommit()` - HEAD commit hash
   - `getCurrentBranch()` - current branch name
   - `getRepoRoot()` - git root directory
   - `getUncommittedChanges()` - {hasChanges, linesAdded, linesDeleted, files}
   - `getSessionCommits(startCommit)` - commits since startCommit
   - `categorizeFile(path)` - 'code'|'test'|'config'|'other'
   - `runGitCommand(args, timeout)` - execute git command safely
3. Use child_process.execSync with timeout
4. Graceful error handling (return null on failure)
  </action>
  <verify>node -e "const g = require('$HOME/.claude/scripts/lib/git-utils'); console.log(g.getCurrentBranch())"</verify>
  <done>git-utils.js exports all functions and works in git repo</done>
</task>

<task type="auto">
  <name>Task 3: Create metrics.js with QuestDB integration</name>
  <files>~/.claude/scripts/lib/metrics.js</files>
  <action>
1. Port QuestDB client functionality from questdb_client.py
2. Implement LOCAL storage:
   - `METRICS_DIR` - `~/.claude/metrics/`
   - `saveMetric(name, value, tags)` - save to metrics JSON
   - `loadMetric(name)` - load metric value
   - `saveSessionState(state)` - save to session_state.json
   - `loadSessionState()` - load session state
   - `saveContextStats(stats)` - save context stats
   - `loadContextStats()` - load context stats

3. Implement QuestDB EXPORT (ILP protocol port 9009):
   - `exportToQuestDB(table, values, tags)` - send via ILP
   - `QUESTDB_HOST` - localhost
   - `QUESTDB_ILP_PORT` - 9009
   - Uses net.Socket for ILP line protocol
   - Format: `table,tag=value field=value timestamp`

4. Implement QuestDB QUERY (REST API port 9000):
   - `queryQuestDB(sql, timeout)` - REST query
   - `QUESTDB_HTTP_PORT` - 9000
   - Returns parsed JSON results

5. Tables exported:
   - `claude_sessions` - session metrics
   - `claude_tool_usage` - tool call stats
   - `claude_hook_invocations` - hook debug data
   - `claude_tip_outcomes` - tip effectiveness

6. Dual-write strategy:
   - Always save to local JSON (offline-first)
   - Async export to QuestDB (best-effort, no block on failure)

7. Create directories if needed
8. Return null on read errors, log but don't throw on export errors
  </action>
  <verify>node -e "const m = require('$HOME/.claude/scripts/lib/metrics'); m.saveMetric('test', 42, {})"</verify>
  <done>metrics.js supports local storage + QuestDB export</done>
</task>

<task type="auto">
  <name>Task 4: Create tips-engine.js</name>
  <files>~/.claude/scripts/lib/tips-engine.js</files>
  <action>
1. Port `/media/sam/1TB/claude-hooks-shared/scripts/tips_engine.py`
2. Implement:
   - `TIPS_DIR` - `~/.claude/tips/`
   - `loadTips(category)` - load tips from category file
   - `generateTips(sessionData)` - analyze session and generate tips
   - `scoreTip(tip, context)` - calculate relevance score (0-1)
   - `formatTips(tips, maxCount)` - format top N tips for display
   - `saveTipsForNextSession(tips)` - persist for session start injection
3. Tips structure: {command, trigger, priority, confidence, category}
4. Categories: 'errors', 'config', 'uncommitted', 'long', 'rework'
  </action>
  <verify>node -e "const t = require('$HOME/.claude/scripts/lib/tips-engine'); console.log(t.formatTips([]))"</verify>
  <done>tips-engine.js can generate and format tips</done>
</task>

<task type="auto">
  <name>Task 5: Create unit tests</name>
  <files>~/.claude/scripts/lib/core-libs.test.js</files>
  <action>
1. Create test file using Node.js built-in test runner
2. Test each library:
   - mcp-client: getProjectName, memoryStore/retrieve
   - git-utils: getCurrentBranch, categorizeFile
   - metrics: save/load cycle
   - tips-engine: scoreTip, formatTips
3. Use temp directories for file operations
4. Minimum 20 tests
  </action>
  <verify>node --test ~/.claude/scripts/lib/core-libs.test.js</verify>
  <done>All tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 4 library files exist and load without error
- [ ] Each library exports documented functions
- [ ] Tests pass (20+ tests)
- [ ] Libraries work on Linux (tested)
</verification>

<success_criteria>
- mcp-client.js: Memory store/retrieve, pattern storage
- git-utils.js: All git operations work
- metrics.js: Metrics save/load cycle works
- tips-engine.js: Tip generation and formatting work
- 20+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/14.5-hooks-shared-port/14.5-01-SUMMARY.md`
</output>
