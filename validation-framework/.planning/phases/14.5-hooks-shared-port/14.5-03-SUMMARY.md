---
plan: 14.5-03
status: complete
duration: ~20 minutes
files_created: 5
tests_passing: 32
loc_total: 1776
---

# Plan 14.5-03 Summary: Port Intelligence Hooks

## Objective
Port intelligence hooks from Python claude-hooks-shared to Node.js - session tracking, analysis, and learning.

## Tasks Completed

### Task 1: session-start-tracker.js (341 LOC)
**Path**: `~/.claude/scripts/hooks/intelligence/session-start-tracker.js`

**Hook**: UserPromptSubmit

**Features**:
- Detect new session vs continuation (30 min timeout)
- Track git state: commit, branch, repo root
- Inject previous session insights (from SSOT)
- Track prompt count
- Merged with ECC session-start.js functionality

**Functions**:
- `isNewSession()` - Check if new session based on timeout/repo
- `saveState(isNew)` - Save/update session state
- `getPreviousSessionStats()` - Load stats if recent (<24h)
- `clearPreviousSessionStats()` - One-time injection cleanup
- `getPreviousInsights()` - Load SSOT insights with compact formatting
- `clearPreviousInsights()` - Prevent repeated injection

**Output format**:
```json
{"additionalContext": "[prev: 31 calls, 9 err, uncommitted +156/-1] [tracking: main@21635072]"}
```

**Verification**:
```bash
$ echo '{}' | node ~/.claude/scripts/hooks/intelligence/session-start-tracker.js
{"additionalContext":"[prev: 31 calls, 9 err, uncommitted +156/-1, 4 tips...] [tracking: main@21635072]"}
```

### Task 2: session-analyzer.js (362 LOC)
**Path**: `~/.claude/scripts/hooks/intelligence/session-analyzer.js`

**Hook**: Stop

**Features**:
- Analyze uncommitted git changes (lines, files, categories)
- Parse session metrics (tool calls, errors, error rate)
- Get commits made during session
- Generate contextual suggestions based on thresholds
- Save stats for next session injection

**Thresholds**:
| Threshold | Value | Description |
|-----------|-------|-------------|
| THRESHOLD_ERROR_RATE | 0.25 | >25% triggers /undo:checkpoint |
| THRESHOLD_MIN_ERRORS | 5 | Min errors for suggestion |
| THRESHOLD_LINES_CHANGED | 50 | Lines for /review suggestion |
| THRESHOLD_CONFIG_FILES | 2 | Config changes for /health |
| THRESHOLD_LONG_SESSION | 60 | Tool calls for /context |
| THRESHOLD_MIN_TOOL_CALLS | 5 | Min for any suggestion |

**Suggestion Priorities**:
1. `/undo:checkpoint` - High error rate (safety)
2. `/health` - Multiple config changes (safety)
3. `/review` - Significant uncommitted changes (quality)
4. `/context` - Long session (convenience)

**Output format**:
```json
{"systemMessage": "[uncommitted: +100/-20, 2 code, 1 test] [session: 15 calls, 2 errors] [commits: 1] [suggest: /health, /review]"}
```

**Verification**:
```bash
$ echo '{"session":{"tool_calls":10,"errors":2}}' | node ~/.claude/scripts/hooks/intelligence/session-analyzer.js
{"systemMessage":"[uncommitted: +1/-1] [session: 10 calls, 2 errors]"}
```

### Task 3: meta-learning.js (372 LOC)
**Path**: `~/.claude/scripts/hooks/intelligence/meta-learning.js`

**Hook**: Stop

**Features**:
- Extract patterns from session data
- Calculate confidence scores based on severity
- Store patterns via mcp-client for SONA learning

**Pattern Types**:
| Pattern | Trigger | Threshold |
|---------|---------|-----------|
| `high_rework` | >3 edits on same file | THRESHOLD_REWORK_EDITS = 3 |
| `high_error` | >25% error rate | THRESHOLD_ERROR_RATE = 0.25 |
| `quality_drop` | Declining quality trend | THRESHOLD_QUALITY_DROP = 0.15 |

**Confidence Calculation**:
```javascript
// Base confidence: 0.5
// Bonus: up to 0.5 based on severity
// high_rework: bonus = min(0.5, excess_edits * 0.15)
// high_error: bonus = min(0.5, excess_rate * 1.5)
// quality_drop: bonus = min(0.5, excess_drop * 2)
```

**Functions**:
- `loadTrajectoryData(project)` - Load trajectory from memory
- `loadSessionAnalysis()` - Load session analyzer output
- `loadFileEditCounts()` - Load file edit counts
- `loadQualityScores()` - Extract quality from trajectory
- `calculateConfidence(type, data)` - Confidence scoring
- `extractReworkPattern(counts)` - Extract rework pattern
- `extractErrorPattern(analysis)` - Extract error pattern
- `extractQualityDropPattern(scores)` - Extract quality pattern
- `extractPatterns(...)` - Extract all patterns
- `storePatterns(patterns)` - Store via mcp-client

**Verification**:
```bash
$ echo '{}' | node ~/.claude/scripts/hooks/intelligence/meta-learning.js
{}
```

### Task 4: lesson-injector.js (291 LOC)
**Path**: `~/.claude/scripts/hooks/intelligence/lesson-injector.js`

**Hook**: UserPromptSubmit

**Features**:
- Load learned lessons from pattern storage
- Match lessons to current context (keywords, file types)
- Inject relevant lessons into context
- Maximum 3 lessons to avoid context bloat

**Confidence Formatting**:
| Confidence | Format |
|------------|--------|
| HIGH (>0.8) | `- {lesson}` |
| MEDIUM (0.5-0.8) | `- Consider: {lesson}` |
| LOW (<0.5) | Skipped |

**Functions**:
- `extractContext(hookInput)` - Get prompt and project
- `loadLocalLessons()` - Load from ~/.claude/lessons/
- `formatLesson(pattern)` - Format based on confidence
- `matchLessonsToContext(lessons, prompt)` - Score and sort
- `processHook(hookInput)` - Main processing

**Output format**:
```json
{"additionalContext": "[Lessons from past sessions]\n- Always run tests after editing\n- Consider: Use TDD for complex features"}
```

**Verification**:
```bash
$ echo '{}' | node ~/.claude/scripts/hooks/intelligence/lesson-injector.js
{}
```

### Task 5: Intelligence Tests (410 LOC)
**Path**: `~/.claude/scripts/hooks/intelligence/intelligence.test.js`

**Test Suites**:
| Suite | Tests | Coverage |
|-------|-------|----------|
| session-start-tracker | 5 | Constants, functions, graceful handling |
| session-analyzer | 6 | Thresholds, metrics parsing, suggestions, formatting |
| meta-learning | 8 | Confidence calc, pattern extraction, thresholds |
| lesson-injector | 8 | Context extraction, formatting, matching |
| integration | 5 | Cross-hook consistency |

**Result**: 32 tests passing, 0 failures

```bash
$ node --test ~/.claude/scripts/hooks/intelligence/intelligence.test.js
# tests 32
# suites 5
# pass 32
# fail 0
```

## Verification Checklist

- [x] All 4 intelligence hooks exist and run without error
- [x] session-start-tracker detects new sessions and injects context
- [x] session-analyzer generates suggestions based on thresholds
- [x] meta-learning extracts patterns and calculates confidence
- [x] lesson-injector injects context-relevant lessons
- [x] 32 tests pass (exceeds 20 minimum)

## Metrics

| Metric | Value |
|--------|-------|
| Total LOC | 1,776 |
| Hooks | 4 |
| Tests | 32 |
| Test suites | 5 |
| Pass rate | 100% |

## File Locations

```
~/.claude/scripts/hooks/intelligence/
├── session-start-tracker.js  # 341 LOC - UserPromptSubmit hook
├── session-analyzer.js       # 362 LOC - Stop hook
├── meta-learning.js          # 372 LOC - Stop hook
├── lesson-injector.js        # 291 LOC - UserPromptSubmit hook
└── intelligence.test.js      # 410 LOC - Unit tests
```

## Dependencies

All hooks use the shared libraries from Plan 14.5-01:
- `../../lib/utils.js` - File I/O, stdin parsing
- `../../lib/git-utils.js` - Git operations
- `../../lib/metrics.js` - Session state, metrics
- `../../lib/mcp-client.js` - Memory and pattern storage

## Hook Integration

These hooks integrate with the Claude Code hook system:

**UserPromptSubmit** (runs on every prompt):
1. `session-start-tracker.js` - Injects session context
2. `lesson-injector.js` - Injects relevant lessons

**Stop** (runs when session ends):
1. `session-analyzer.js` - Saves stats for next session
2. `meta-learning.js` - Extracts and stores learning patterns

## Python Source Comparison

| Python Source | Python LOC | JS Port | JS LOC |
|---------------|------------|---------|--------|
| session_start_tracker.py | 296 | session-start-tracker.js | 341 |
| session_analyzer.py | 456 | session-analyzer.js | 362 |
| meta_learning.py | 312 | meta-learning.js | 372 |
| lesson_injector.py | 245 | lesson-injector.js | 291 |
| **Total** | **1,309** | **Total** | **1,366** |

Note: JS ports are similar in size, with slight increases due to JSDoc comments and explicit error handling.

## Ready for Phase 14.5-04

The intelligence hooks are now complete and can be integrated with the hooks.json configuration for automatic invocation.
