# Plan 14.5-06 Summary: Port Metrics and Coordination Hooks

**Status:** COMPLETED
**Date:** 2026-01-24
**Duration:** ~25 minutes

## Objective

Port metrics and coordination hooks from Python to Node.js for DORA tracking and multi-agent file/task coordination.

## Files Created

### Metrics Hooks (~1,500 LOC)

| File | Lines | Purpose |
|------|-------|---------|
| `~/.claude/scripts/hooks/metrics/dora-tracker.js` | 434 | DORA metrics: cycle time, rework rate, deployments |
| `~/.claude/scripts/hooks/metrics/quality-score.js` | 373 | Quality score: pytest/ruff/mypy parsing, 0-100 score |
| `~/.claude/scripts/hooks/metrics/claudeflow-sync.js` | 357 | Claude-flow state sync, crash recovery |

### Coordination Hooks (~650 LOC)

| File | Lines | Purpose |
|------|-------|---------|
| `~/.claude/scripts/hooks/coordination/file-coordination.js` | 278 | File claim/release for multi-agent editing |
| `~/.claude/scripts/hooks/coordination/task-coordination.js` | 318 | Task claim/release, duplicate prevention |

### Tests

| File | Lines | Tests |
|------|-------|-------|
| `~/.claude/scripts/hooks/metrics/metrics.test.js` | 338 | 19 tests (all passing) |

**Total:** ~2,600 LOC (5 hooks + 1 test file)

## Implementation Details

### dora-tracker.js

- **Hook type:** PostToolUse
- **Triggers:** Write/Edit/MultiEdit, Bash (pytest), Task, TodoWrite
- **Metrics tracked:**
  - Cycle time: task start to completion
  - Rework rate: file edits within 24h
  - Task iterations: edits per task
  - Error rate: tool failures
  - Deployment frequency: git push/merge
- **Storage:** `~/.claude/metrics/dora/daily.jsonl`
- **Alerts:** High error rate (>15%), high rework rate (>30%)

### quality-score.js

- **Hook type:** PostToolUse (Bash only)
- **Triggers:** pytest, ruff, mypy, bandit, speckit, gsd
- **Weight distribution:**
  - code: 25% (ruff + mypy)
  - test: 30% (coverage + pass rate)
  - data: 25% (pandera/schema)
  - framework: 20% (speckit/gsd)
- **Output:** Composite score 0-100
- **Alerts:** System message if score < 70

### claudeflow-sync.js

- **Hook type:** PostToolUse
- **Triggers:** Task, TodoWrite, Skill
- **Features:**
  - Sync state to claude-flow memory
  - Track agent spawns
  - Track task progress
  - Enable crash recovery
- **Periodic sync:** Every 10 tool calls

### file-coordination.js

- **Hook type:** PreToolUse
- **Triggers:** Write, Edit, MultiEdit
- **Features:**
  - Claim files before editing
  - Block if claimed by another agent
  - Auto-expire claims (5 minutes)
  - Release after edit
- **Storage:** `~/.claude/coordination/claims.json`

### task-coordination.js

- **Hook type:** PreToolUse, SubagentStop
- **Triggers:** Task tool
- **Features:**
  - Claim tasks for visibility
  - Prevent duplicate work (detection only)
  - Auto-release stale claims (1 hour)
  - Broadcast task completion
- **Storage:** `~/.claude/coordination/task-claims.json`

## Verification

### Test Results

```
# tests 19
# suites 5
# pass 19
# fail 0
```

### Hook Execution Tests

```bash
# dora-tracker: tracks deployment
echo '{"tool_name":"Bash","tool_input":{"command":"git push"}}' | node dora-tracker.js
# Output: {}

# quality-score: calculates score
echo '{"tool_name":"Bash","tool_output":"45 passed","tool_input":{"command":"pytest"}}' | node quality-score.js
# Output: {"status":"tracked","totalScore":60,"scores":{"test":60},...}

# claudeflow-sync: syncs state
echo '{"tool_name":"Task","tool_input":{"description":"Test"}}' | node claudeflow-sync.js
# Output: {"synced":true,"syncCount":1,"agentSpawns":1,...}

# file-coordination: claims file
echo '{"tool_name":"Edit","tool_input":{"file_path":"src/file.js"}}' | node file-coordination.js
# Output: {}

# task-coordination: tracks task
echo '{"tool_name":"Task","tool_input":{"description":"Test"}}' | node task-coordination.js
# Output: {}
```

## Dependencies

Uses core libraries from Plan 14.5-01:
- `~/.claude/scripts/lib/metrics.js` - QuestDB export
- `~/.claude/scripts/lib/mcp-client.js` - Memory storage
- `~/.claude/scripts/lib/utils.js` - Common utilities

## Storage Locations

```
~/.claude/
├── metrics/
│   ├── dora/
│   │   ├── daily.jsonl          # DORA metrics log
│   │   ├── file_edits.json      # Rework tracking
│   │   └── session_state.json   # Session state
│   └── quality/
│       ├── scores.jsonl         # Quality scores log
│       └── latest_score.json    # Latest score
├── coordination/
│   ├── claims.json              # File claims
│   ├── task-claims.json         # Task claims
│   ├── active_task_claims.json  # Session tasks
│   └── coordination.log         # Coordination log
└── claude-flow/
    └── sync_state.json          # Claude-flow sync state
```

## Success Criteria

- [x] 5 hooks ported to Node.js
- [x] Multi-agent coordination works (file/task claims)
- [x] Metrics are persisted correctly
- [x] 15+ tests passing (19 tests)
- [x] All hooks execute without errors

## Notes

- Hooks use the same JSON stdin/stdout protocol as Python versions
- File coordination blocks edits if file is claimed by another agent
- Task coordination is informational only (never blocks)
- QuestDB export is best-effort (graceful degradation)
- All hooks fail-open on errors (return empty JSON)
