---
phase: 27-autonomous-loop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
---

<objective>
Create the autonomous coding loop controller for OpenClaw main agent. The controller receives a spec/task, executes it, validates results via orchestrator.py, iterates with ralph_loop.py if needed, and escalates to Matrix on failure.

Purpose: Enable 24/7 autonomous coding with quality gates — agent commits only validated code.
Output: Working autonomous loop deployed to agent workspace, tested E2E.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-autonomous-loop/27-RESEARCH.md
@.planning/phases/26-quality-gates/26-01-SUMMARY.md

Key facts from research:
- orchestrator.py CLI: `python3 orchestrator.py [tier] [--files ...]`, exit 0=pass, 1=fail
- ralph_loop.py CLI: `python3 ralph_loop.py --files "f1,f2" --project name`, exit 0=pass, 1=blocked, 2=threshold
- ralph_loop has budget limits: max_budget_usd=$20, max_iterations configurable
- Agent workspace: /home/node/clawd/ with .githooks/ already deployed (Phase 26)
- Matrix room: !GQeiGgJenxtCKbaxDL:matrix.lan (bambam)
- Synapse API for programmatic messages
- exec-approvals: python3, git already in allowlist
- OpenClaw agent CLI: `docker exec openclaw-gateway node /app/dist/entry.js agent --agent main --message "..." --json`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create autonomous loop controller and deploy to agent workspace</name>
  <files>None created locally — deployed to gateway container</files>
  <action>
    1. Create `autonomous_loop.py` (~150-200 LOC) that implements state machine:
       ```
       SPEC_RECEIVED → EXECUTING → VALIDATING → (ITERATING | ESCALATING | COMPLETE)
       ```

    2. Controller logic:
       - Receives spec/task description as CLI argument
       - Executes task via agent (delegates to OpenClaw agent turn)
       - After execution, gets list of changed files via `git diff --name-only HEAD~1`
       - Runs `python3 ~/.claude/templates/validation/orchestrator.py 1 --files $CHANGED`
       - If Tier 1 passes → run Tier 2: `python3 orchestrator.py 2`
       - If Tier 2 passes → state=COMPLETE, exit 0
       - If any tier fails → run ralph_loop: `python3 ralph_loop.py --files $CHANGED --project clawd`
       - If ralph passes → state=COMPLETE, exit 0
       - If ralph fails (exit 1 or 2) → state=ESCALATING

    3. Escalation: Send Matrix message via curl to Synapse API:
       ```bash
       curl -s -X PUT "http://192.168.1.100:8008/_matrix/client/v3/rooms/!GQeiGgJenxtCKbaxDL:matrix.lan/send/m.room.message/$(date +%s)" \
         -H "Authorization: Bearer $MATRIX_TOKEN" \
         -H "Content-Type: application/json" \
         -d '{"msgtype":"m.text","body":"BLOCKED: Autonomous loop failed after max iterations.\nSpec: $SPEC\nLast error: $ERROR\nAction needed: manual review"}'
       ```

    4. State persistence: Write JSON state to `/home/node/clawd/.autonomous-state.json`:
       ```json
       {"state": "COMPLETE", "spec": "...", "iterations": 2, "last_score": 0.85, "timestamp": "..."}
       ```

    5. Budget/safety limits (hardcoded, conservative):
       - max_iterations: 3 (ralph loop has its own internal limit too)
       - timeout per iteration: 300s
       - If any subprocess returns exit code 2 (error), escalate immediately

    6. Deploy to agent workspace:
       ```bash
       # Write script to container
       ssh 192.168.1.100 'docker exec -i openclaw-gateway sh -c "cat > /home/node/clawd/.autonomous-loop.py"' < autonomous_loop.py
       chmod via docker exec
       ```

    NOTE: Keep it simple. This is a coordinator script, not a framework. Use subprocess.run() for all tool invocations. No imports beyond stdlib (subprocess, json, sys, time, os).

    NOTE: Do NOT use the OpenClaw agent CLI for execution — the loop IS what runs inside the agent session. The loop coordinates validation after the agent has made changes. The agent's session hook or cron triggers the loop post-task.
  </action>
  <verify>
    - File exists in container: `ssh 192.168.1.100 'docker exec openclaw-gateway ls -la /home/node/clawd/.autonomous-loop.py'`
    - Script parses without error: `ssh 192.168.1.100 'docker exec openclaw-gateway python3 -c "import py_compile; py_compile.compile(\"/home/node/clawd/.autonomous-loop.py\")"'`
    - Dry run with no changes (should exit 0): `ssh 192.168.1.100 'docker exec openclaw-gateway sh -c "cd /home/node/clawd && python3 .autonomous-loop.py --dry-run"'`
  </verify>
  <done>autonomous_loop.py deployed to agent workspace, parses cleanly, dry-run exits 0.</done>
</task>

<task type="auto">
  <name>Task 2: Test autonomous loop E2E via agent</name>
  <files>None (verification only)</files>
  <action>
    1. Test the loop in validation-only mode (no actual coding, just validation of current state):
       ```bash
       ssh 192.168.1.100 'docker exec openclaw-gateway sh -c "cd /home/node/clawd && python3 .autonomous-loop.py --validate-only"'
       ```
       Expected: runs orchestrator on current workspace, reports pass/fail, exits.

    2. Test escalation path (force failure):
       ```bash
       ssh 192.168.1.100 'docker exec openclaw-gateway sh -c "cd /home/node/clawd && python3 .autonomous-loop.py --test-escalation"'
       ```
       Expected: sends test message to Matrix room, exits 0.
       Verify message arrived: check Matrix room via API.

    3. Test state persistence:
       ```bash
       ssh 192.168.1.100 'docker exec openclaw-gateway cat /home/node/clawd/.autonomous-state.json'
       ```
       Expected: valid JSON with state, timestamp.

    4. Document test results:
       - Validation-only mode: pass/fail
       - Escalation test: message sent yes/no
       - State file: valid JSON yes/no
       - Any errors or missing dependencies
  </action>
  <verify>
    - Validation-only exits cleanly (0 or 1, not 2)
    - State file exists and contains valid JSON
    - Escalation test sends message (or documents Matrix token not available — acceptable for now)
  </verify>
  <done>Autonomous loop tested E2E, results documented, state persistence confirmed.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] autonomous_loop.py exists in /home/node/clawd/ with +x
- [ ] Script compiles without Python syntax errors
- [ ] Dry-run mode works (exit 0)
- [ ] Validation-only mode runs orchestrator successfully
- [ ] State file written and readable
- [ ] Escalation tested (or documented as pending Matrix token)
</verification>

<success_criteria>

- Autonomous loop controller deployed and executable
- State machine works: SPEC → VALIDATE → ITERATE/ESCALATE → COMPLETE
- State persisted to disk (survives container restart if volume mounted)
- Escalation sends Matrix message on failure
- Budget limits enforced (max 3 iterations)
- All tests documented in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/27-autonomous-loop/27-01-SUMMARY.md`
</output>
