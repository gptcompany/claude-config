---
phase: 26-quality-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
---

<objective>
Create git quality gate hooks for OpenClaw agent workspaces: pre-commit runs Tier 1 (quick) validation on staged files, pre-push runs Tier 1+2. Audit exec-approvals to confirm agent can execute validation.

Purpose: Prevent low-quality code from being committed/pushed by OpenClaw agents operating autonomously.
Output: Working git hooks verified in agent workspace, exec-approvals audit documented, SUMMARY.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-quality-gates/26-RESEARCH.md
@.planning/phases/22-agent-config/22-01-SUMMARY.md

Key facts from research:
- orchestrator.py CLI: `python3 orchestrator.py [tier] [--files ...]`
- Exit codes: 0=pass, 1=fail
- exec-approvals already has python3 in allowlist
- Agent workspaces: /home/node/clawd-{name}/ (4 agents)
- core.hooksPath approach for versionable hooks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git hook scripts and deploy to agent workspace</name>
  <files>None created locally â€” hooks deployed to gateway container</files>
  <action>
    1. Create pre-commit hook that:
       - Gets staged Python/JS/TS files via `git diff --cached --name-only --diff-filter=ACM`
       - If any found, runs `python3 ~/.claude/templates/validation/orchestrator.py quick --files $STAGED`
       - Exits with orchestrator exit code (0=allow commit, 1=block)
       - If no relevant files staged, exits 0 (allow)

    2. Create pre-push hook that:
       - Runs `python3 ~/.claude/templates/validation/orchestrator.py 2`
       - Exits with orchestrator exit code

    3. Deploy hooks to main agent workspace on gateway container:
       ```bash
       # Create .githooks/ in main agent workspace
       ssh 192.168.1.100 'docker exec openclaw-gateway mkdir -p /home/node/clawd/.githooks'

       # Write pre-commit hook
       ssh 192.168.1.100 'docker exec openclaw-gateway sh -c "cat > /home/node/clawd/.githooks/pre-commit << '\''HOOK'\''
       #!/bin/bash
       STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E \"\\.(py|ts|js|tsx|jsx)$\" || true)
       if [ -n \"$STAGED\" ]; then
           python3 ~/.claude/templates/validation/orchestrator.py quick --files $STAGED
           exit $?
       fi
       exit 0
       HOOK
       chmod +x /home/node/clawd/.githooks/pre-commit"'

       # Write pre-push hook
       ssh 192.168.1.100 'docker exec openclaw-gateway sh -c "cat > /home/node/clawd/.githooks/pre-push << '\''HOOK'\''
       #!/bin/bash
       python3 ~/.claude/templates/validation/orchestrator.py 2
       exit $?
       HOOK
       chmod +x /home/node/clawd/.githooks/pre-push"'

       # Set core.hooksPath in main workspace
       ssh 192.168.1.100 'docker exec openclaw-gateway sh -c "cd /home/node/clawd && git config core.hooksPath .githooks/"'
       ```

    4. Verify hooks are installed:
       ```bash
       ssh 192.168.1.100 'docker exec openclaw-gateway ls -la /home/node/clawd/.githooks/'
       ssh 192.168.1.100 'docker exec openclaw-gateway sh -c "cd /home/node/clawd && git config core.hooksPath"'
       ```

    NOTE: Deploy ONLY to main agent workspace (/home/node/clawd). Other agent workspaces (nautilus, utxoracle, n8n) work on different repos that may not have the validation framework. Extending to them is future work.
  </action>
  <verify>
    - ls shows pre-commit and pre-push in .githooks/ with +x permission
    - git config core.hooksPath returns .githooks/
    - pre-commit hook runs without error on empty staged set (exit 0)
  </verify>
  <done>Git hooks deployed to main agent workspace, core.hooksPath configured.</done>
</task>

<task type="auto">
  <name>Task 2: Audit exec-approvals and test hook execution</name>
  <files>None (verification only)</files>
  <action>
    1. Audit exec-approvals for validation capability:
       ```bash
       # Check python3 is in allowlist
       ssh 192.168.1.100 'docker exec openclaw-gateway cat /home/node/.openclaw/exec-approvals.json' 2>/dev/null | python3 -c "import sys,json; d=json.load(sys.stdin); print('python3 allowed:', 'python3' in str(d))"

       # Check git is in allowlist (needed for git diff in hooks)
       ssh 192.168.1.100 'docker exec openclaw-gateway cat /home/node/.openclaw/exec-approvals.json' 2>/dev/null | python3 -c "import sys,json; d=json.load(sys.stdin); print('git allowed:', 'git' in str(d))"
       ```

    2. Test pre-commit hook execution via agent:
       ```bash
       ssh 192.168.1.100 'docker exec openclaw-gateway node /app/dist/entry.js agent \
         --agent main --session-id quality-gate-test-$(date +%s) \
         --message "In your workspace, check if .githooks/pre-commit exists and run it manually with: bash .githooks/pre-commit. Report the exit code." \
         --json --timeout 120'
       ```

    3. Document audit results:
       - python3 in allowlist: yes/no
       - git in allowlist: yes/no
       - orchestrator.py accessible: yes/no
       - Hook execution test: pass/fail
       - Any missing permissions or paths
  </action>
  <verify>
    - exec-approvals audit shows python3 and git in allowlist
    - Agent can execute hook script (exit 0 on no staged files)
  </verify>
  <done>exec-approvals audited, hooks tested via agent, all permissions confirmed.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pre-commit hook exists in /home/node/clawd/.githooks/ with +x
- [ ] pre-push hook exists in /home/node/clawd/.githooks/ with +x
- [ ] core.hooksPath set to .githooks/
- [ ] exec-approvals has python3 and git in allowlist
- [ ] Hook executes without error from agent context
</verification>

<success_criteria>

- Git hooks installed and executable in main agent workspace
- core.hooksPath configured
- exec-approvals audit confirms agent can run validation
- Hook tested via agent (manual or automated)
- Results documented in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/26-quality-gates/26-01-SUMMARY.md`
</output>
