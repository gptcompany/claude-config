---
phase: 15-skills-port
plan: 01
type: execute
wave: 1
depends_on: ["14.6-04"]
files_modified:
  - ~/.claude/scripts/hooks/skills/tdd/tdd-state.js
  - ~/.claude/scripts/hooks/skills/tdd/tdd-enforcer.js
  - ~/.claude/scripts/hooks/skills/tdd/set-state.js
  - ~/.claude/commands/tdd/red.md
  - ~/.claude/commands/tdd/green.md
  - ~/.claude/commands/tdd/refactor.md
  - ~/.claude/commands/tdd/exit.md
  - ~/.claude/commands/tdd/status.md
  - ~/.claude/hooks.json
autonomous: true
---

<objective>
Port TDD-workflow skill with enforcement-first design.

Purpose: Create session state machine (IDLE→RED→GREEN→REFACTOR) with PreToolUse enforcement that blocks Write/Edit operations based on current TDD phase.
Output: TDD state library (~200 LOC), enforcer hook (~150 LOC), 5 command files, hooks.json binding, 30+ tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-skills-port/15-RESEARCH.md
@.planning/phases/15-skills-port/15-CONTEXT.md

# Existing TDD infrastructure (to integrate with):
@~/.claude/scripts/hooks/productivity/tdd-guard.js

# ECC source reference:
# /media/sam/1TB/everything-claude-code/skills/tdd-workflow/SKILL.md
# /media/sam/1TB/everything-claude-code/commands/tdd.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TDD State Manager</name>
  <files>~/.claude/scripts/hooks/skills/tdd/tdd-state.js</files>
  <action>
Create TDD session state manager (~200 LOC):

**Constants:**
```javascript
const STATE_PATH = path.join(os.homedir(), '.claude', 'state', 'tdd-session.json');
const PHASES = { IDLE: 'IDLE', RED: 'RED', GREEN: 'GREEN', REFACTOR: 'REFACTOR' };
const STATE_TTL_MS = 2 * 60 * 60 * 1000; // 2 hours
```

**Phase Rules:**
```javascript
const PHASE_RULES = {
  RED: {
    allowWrite: (file) => isTestFile(file) || isFixtureFile(file),
    blockReason: 'RED phase: Write tests first. Implementation files blocked.',
  },
  GREEN: {
    allowWrite: (file) => !isTestFile(file) || isFixtureFile(file),
    blockReason: 'GREEN phase: Implement to pass tests. New test files blocked.',
  },
  REFACTOR: {
    allowWrite: () => true,
    requireTestsPass: true,
    blockReason: null,
  },
};
```

**Functions to implement:**
1. `ensureStateDir()` - create ~/.claude/state/ if needed
2. `getState()` - read state, return IDLE if missing/expired/different session
3. `setState(phase, metadata)` - write state with sessionId, timestamp
4. `clearState()` - delete state file (for /tdd:exit)
5. `isStateExpired(state)` - check TTL
6. `isCurrentSession(state)` - check CLAUDE_SESSION_ID
7. `isTestFile(filePath)` - detect *.test.*, *.spec.*, test_*, conftest.py
8. `isFixtureFile(filePath)` - detect fixtures, __mocks__, testdata
9. `checkPhaseCompliance(filePath, toolName)` - main enforcement check

**Return format for checkPhaseCompliance:**
```javascript
{ allowed: boolean, reason: string|null, phase: string }
```

Export all functions for testing.
  </action>
  <verify>node -e "const s = require('$HOME/.claude/scripts/hooks/skills/tdd/tdd-state'); console.log(s.getState())"</verify>
  <done>tdd-state.js exports all functions, getState returns {phase: 'IDLE'}</done>
</task>

<task type="auto">
  <name>Task 2: Create TDD Enforcer Hook</name>
  <files>~/.claude/scripts/hooks/skills/tdd/tdd-enforcer.js</files>
  <action>
Create PreToolUse enforcement hook (~150 LOC):

**Hook structure:**
```javascript
#!/usr/bin/env node
const { getState, checkPhaseCompliance, PHASES } = require('./tdd-state');

async function readStdinJson() {
  // Standard stdin reading pattern from existing hooks
}

async function main() {
  const input = await readStdinJson();
  const { tool_name, tool_input } = input;

  // Only enforce on Write, Edit, MultiEdit
  if (!['Write', 'Edit', 'MultiEdit'].includes(tool_name)) {
    console.log(JSON.stringify({ decision: 'allow' }));
    return;
  }

  const filePath = tool_input.file_path;
  const { allowed, reason, phase } = checkPhaseCompliance(filePath, tool_name);

  if (!allowed) {
    console.log(JSON.stringify({
      hookSpecificOutput: {
        hookEventName: 'PreToolUse',
        decision: 'block',
        reason: formatBlockMessage(reason, phase, filePath),
      },
    }));
    return;
  }

  console.log(JSON.stringify({ decision: 'allow' }));
}

function formatBlockMessage(reason, phase, filePath) {
  return `
TDD ENFORCEMENT BLOCK
━━━━━━━━━━━━━━━━━━━━━
Phase: ${phase}
File: ${filePath}
Reason: ${reason}

Commands:
  /tdd:status   - Show current TDD state
  /tdd:exit     - Exit TDD mode (allows all writes)
  /tdd:green    - Transition to GREEN (if tests fail)
  /tdd:refactor - Transition to REFACTOR (if tests pass)
`.trim();
}

main().catch(console.error);
```

Make executable with shebang.
  </action>
  <verify>echo '{"tool_name":"Write","tool_input":{"file_path":"src/main.js"}}' | node ~/.claude/scripts/hooks/skills/tdd/tdd-enforcer.js</verify>
  <done>tdd-enforcer.js blocks/allows based on TDD state (returns allow in IDLE)</done>
</task>

<task type="auto">
  <name>Task 3: Create State Transition CLI</name>
  <files>~/.claude/scripts/hooks/skills/tdd/set-state.js</files>
  <action>
Create CLI for setting TDD state (~80 LOC):

```javascript
#!/usr/bin/env node
const { setState, clearState, getState, PHASES } = require('./tdd-state');

const action = process.argv[2];
const arg = process.argv[3];

switch (action) {
  case 'set':
    if (!PHASES[arg]) {
      console.error(`Invalid phase: ${arg}. Valid: ${Object.keys(PHASES).join(', ')}`);
      process.exit(1);
    }
    const state = setState(arg);
    console.log(`TDD phase set to: ${arg}`);
    console.log(JSON.stringify(state, null, 2));
    break;

  case 'clear':
    clearState();
    console.log('TDD state cleared. Enforcement disabled.');
    break;

  case 'get':
    const current = getState();
    console.log(JSON.stringify(current, null, 2));
    break;

  default:
    console.log('Usage: set-state.js <set|clear|get> [phase]');
    console.log('Phases: IDLE, RED, GREEN, REFACTOR');
}
```

Make executable.
  </action>
  <verify>node ~/.claude/scripts/hooks/skills/tdd/set-state.js get</verify>
  <done>set-state.js CLI works for set/clear/get operations</done>
</task>

<task type="auto">
  <name>Task 4: Create TDD Commands</name>
  <files>~/.claude/commands/tdd/red.md, ~/.claude/commands/tdd/green.md, ~/.claude/commands/tdd/refactor.md, ~/.claude/commands/tdd/exit.md, ~/.claude/commands/tdd/status.md</files>
  <action>
Create 5 TDD command files with state transitions:

**red.md:**
```markdown
# TDD Red Phase

## On Invocation
\`\`\`bash
node ~/.claude/scripts/hooks/skills/tdd/set-state.js set RED
\`\`\`

## Instructions
You are now in TDD RED phase. Your task is to write **failing tests**.

### Rules (ENFORCED)
- ✅ ALLOWED: Write test files (*.test.js, *.spec.ts, test_*.py, conftest.py)
- ✅ ALLOWED: Write test fixtures and mocks
- ❌ BLOCKED: Write implementation files

### Workflow
1. Identify the behavior to implement
2. Write a test that describes the expected behavior
3. Run the test — it MUST fail
4. When test fails, transition: `/tdd:green`

### Verification
Before transitioning to GREEN, run tests and confirm failure:
\`\`\`bash
npm test  # or pytest, etc.
\`\`\`
```

**green.md:**
```markdown
# TDD Green Phase

## On Invocation
\`\`\`bash
node ~/.claude/scripts/hooks/skills/tdd/set-state.js set GREEN
\`\`\`

## Instructions
You are now in TDD GREEN phase. Your task is to make tests **pass**.

### Rules (ENFORCED)
- ✅ ALLOWED: Write implementation files
- ✅ ALLOWED: Modify existing test fixtures
- ❌ BLOCKED: Add new test files (use /tdd:red for that)

### Workflow
1. Write minimum code to make the failing test pass
2. Run tests — they MUST pass
3. When tests pass, transition: `/tdd:refactor`

### Verification
Before transitioning to REFACTOR, run tests and confirm passing:
\`\`\`bash
npm test  # All tests green
\`\`\`
```

**refactor.md:**
```markdown
# TDD Refactor Phase

## On Invocation
\`\`\`bash
node ~/.claude/scripts/hooks/skills/tdd/set-state.js set REFACTOR
\`\`\`

## Instructions
You are now in TDD REFACTOR phase. Improve code quality while keeping tests green.

### Rules
- ✅ ALLOWED: All file modifications
- ⚠️ REQUIRED: Run tests after each change

### Workflow
1. Identify code smells or improvements
2. Make one refactoring change
3. Run tests — they MUST still pass
4. Repeat until satisfied
5. For new feature, return to: `/tdd:red`
6. When done, exit: `/tdd:exit`
```

**exit.md:**
```markdown
# Exit TDD Mode

## On Invocation
\`\`\`bash
node ~/.claude/scripts/hooks/skills/tdd/set-state.js clear
\`\`\`

## Result
TDD enforcement disabled. All file writes allowed.

To restart TDD workflow: `/tdd:red`
```

**status.md:**
```markdown
# TDD Status

## On Invocation
\`\`\`bash
node ~/.claude/scripts/hooks/skills/tdd/set-state.js get
\`\`\`

## Shows
- Current TDD phase
- Session ID
- Time since phase started
- What operations are allowed/blocked
```
  </action>
  <verify>ls -la ~/.claude/commands/tdd/</verify>
  <done>5 command files created: red.md, green.md, refactor.md, exit.md, status.md</done>
</task>

<task type="auto">
  <name>Task 5: Add Hook Binding to hooks.json</name>
  <files>~/.claude/hooks.json</files>
  <action>
Add tdd-enforcer to hooks.json in the PreToolUse section:

```json
{
  "hooks": [
    // ... existing hooks ...
    {
      "name": "tdd-enforcer",
      "event": "PreToolUse",
      "script": "node ~/.claude/scripts/hooks/skills/tdd/tdd-enforcer.js",
      "description": "Enforce TDD phase rules (RED=tests only, GREEN=impl only)",
      "timeout": 5000,
      "enabled": true,
      "priority": 50
    }
  ]
}
```

Place at priority 50 (after safety hooks at 10-30, before quality hooks at 70-90).
  </action>
  <verify>grep -A5 "tdd-enforcer" ~/.claude/hooks.json</verify>
  <done>tdd-enforcer hook registered in hooks.json</done>
</task>

<task type="auto">
  <name>Task 6: Create Unit and Integration Tests</name>
  <files>~/.claude/scripts/hooks/skills/tdd/tdd-state.test.js</files>
  <action>
Create comprehensive test suite (~30 tests):

**State management tests (10 tests):**
1. getState returns IDLE when no file
2. setState creates file with correct structure
3. setState includes sessionId
4. clearState removes file
5. isStateExpired returns true after TTL
6. isCurrentSession returns false for different session
7. State persists across getState calls
8. Invalid phase rejected by setState

**File detection tests (10 tests):**
1. isTestFile detects *.test.js
2. isTestFile detects *.spec.ts
3. isTestFile detects test_*.py
4. isTestFile detects conftest.py
5. isTestFile rejects src/main.js
6. isFixtureFile detects __mocks__
7. isFixtureFile detects fixtures/
8. isFixtureFile detects testdata/

**Phase compliance tests (10 tests):**
1. RED phase blocks implementation file write
2. RED phase allows test file write
3. GREEN phase blocks new test file
4. GREEN phase allows implementation file
5. REFACTOR allows all files
6. IDLE allows all files
7. Fixture files always allowed
8. Non-Write tools always allowed

**Integration tests (5 tests):**
1. Full RED→GREEN→REFACTOR cycle
2. State survives process restart (within session)
3. State clears on different session
4. Hook blocking returns correct format
5. Hook with expired state returns allow

Use Node.js test runner with temp directories.
  </action>
  <verify>node --test ~/.claude/scripts/hooks/skills/tdd/tdd-state.test.js</verify>
  <done>35 tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] tdd-state.js exists and exports all functions
- [ ] tdd-enforcer.js hooks into PreToolUse
- [ ] set-state.js CLI works for set/get/clear
- [ ] 5 command files in ~/.claude/commands/tdd/
- [ ] hooks.json updated with tdd-enforcer binding
- [ ] 35 tests pass
- [ ] Manual test: set RED phase, try Write to src/main.js → blocked
- [ ] Manual test: set RED phase, try Write to test/main.test.js → allowed
</verification>

<success_criteria>
- TDD state machine tracks IDLE→RED→GREEN→REFACTOR
- PreToolUse enforcer blocks non-compliant writes
- Commands set state transitions
- Session isolation prevents cross-session state
- 2-hour TTL prevents stuck states
- 35+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/15-skills-port/15-01-SUMMARY.md`
</output>
