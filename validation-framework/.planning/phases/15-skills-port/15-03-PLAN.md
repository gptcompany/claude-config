---
phase: 15-skills-port
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - ~/.claude/scripts/hooks/skills/standards/coding-standards.js
  - ~/.claude/scripts/hooks/skills/standards/patterns.js
  - ~/.claude/commands/standards/check.md
  - ~/.claude/commands/standards/config.md
  - ~/.claude/hooks.json
autonomous: true
---

<objective>
Port coding-standards skill with AST-based pattern enforcement.

Purpose: Create PreToolUse hook that enforces coding standards via ESLint/pattern analysis before writes are allowed.
Output: Standards enforcer hook (~250 LOC), patterns library (~150 LOC), 2 commands, hooks.json binding, 25+ tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-skills-port/15-RESEARCH.md

# ECC source reference:
# /media/sam/1TB/everything-claude-code/skills/coding-standards/SKILL.md

# Existing quality hooks:
@~/.claude/scripts/hooks/quality/auto-format.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Patterns Library</name>
  <files>~/.claude/scripts/hooks/skills/standards/patterns.js</files>
  <action>
Create coding patterns detection library (~150 LOC):

```javascript
const ANTI_PATTERNS = {
  javascript: [
    {
      name: 'console-log-in-prod',
      pattern: /console\.(log|debug|info)\(/,
      severity: 'warn',
      message: 'console.log detected - remove or use logger',
      exclude: ['*.test.js', '*.spec.js', 'debug/*'],
    },
    {
      name: 'any-type',
      pattern: /:\s*any\b/,
      severity: 'warn',
      message: 'Avoid `any` type - use specific types',
      exclude: ['*.d.ts'],
    },
    {
      name: 'hardcoded-secret',
      pattern: /(password|secret|api_key|token)\s*[:=]\s*['"][^'"]+['"]/i,
      severity: 'error',
      message: 'Possible hardcoded secret detected',
    },
    {
      name: 'todo-without-issue',
      pattern: /\/\/\s*TODO(?!:?\s*#\d+)/i,
      severity: 'info',
      message: 'TODO without issue reference',
    },
  ],
  python: [
    {
      name: 'print-in-prod',
      pattern: /\bprint\(/,
      severity: 'warn',
      message: 'print() detected - use logging module',
      exclude: ['test_*.py', '*_test.py'],
    },
    {
      name: 'bare-except',
      pattern: /except\s*:/,
      severity: 'error',
      message: 'Bare except clause - specify exception type',
    },
    {
      name: 'star-import',
      pattern: /from\s+\S+\s+import\s+\*/,
      severity: 'warn',
      message: 'Star import - use explicit imports',
    },
  ],
};

function detectFileType(filePath) {
  if (filePath.endsWith('.js') || filePath.endsWith('.ts') || filePath.endsWith('.jsx') || filePath.endsWith('.tsx')) {
    return 'javascript';
  }
  if (filePath.endsWith('.py')) return 'python';
  return null;
}

function shouldExclude(pattern, filePath) {
  if (!pattern.exclude) return false;
  return pattern.exclude.some(glob => minimatch(filePath, glob));
}

function checkPatterns(content, filePath) {
  const fileType = detectFileType(filePath);
  if (!fileType) return { passed: true, issues: [] };

  const patterns = ANTI_PATTERNS[fileType] || [];
  const issues = [];

  for (const pattern of patterns) {
    if (shouldExclude(pattern, filePath)) continue;

    const lines = content.split('\n');
    for (let i = 0; i < lines.length; i++) {
      if (pattern.pattern.test(lines[i])) {
        issues.push({
          name: pattern.name,
          line: i + 1,
          severity: pattern.severity,
          message: pattern.message,
          content: lines[i].trim().substring(0, 60),
        });
      }
    }
  }

  return {
    passed: !issues.some(i => i.severity === 'error'),
    issues,
  };
}

module.exports = { ANTI_PATTERNS, detectFileType, checkPatterns };
```
  </action>
  <verify>node -e "const p = require('$HOME/.claude/scripts/hooks/skills/standards/patterns'); console.log(Object.keys(p.ANTI_PATTERNS))"</verify>
  <done>patterns.js exports anti-patterns for js/python with line detection</done>
</task>

<task type="auto">
  <name>Task 2: Create Standards Enforcer Hook</name>
  <files>~/.claude/scripts/hooks/skills/standards/coding-standards.js</files>
  <action>
Create PreToolUse coding standards hook (~250 LOC):

```javascript
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const { checkPatterns, detectFileType } = require('./patterns');

const CONFIG_PATH = path.join(process.env.HOME, '.claude', 'standards-config.json');
const DEFAULT_CONFIG = {
  enabled: true,
  mode: 'warn', // 'warn' | 'block' | 'off'
  excludePaths: ['node_modules', 'dist', 'build', '.git', 'vendor', 'venv'],
};

function loadConfig() {
  try {
    return { ...DEFAULT_CONFIG, ...JSON.parse(fs.readFileSync(CONFIG_PATH, 'utf8')) };
  } catch {
    return DEFAULT_CONFIG;
  }
}

async function readStdinJson() {
  return new Promise((resolve) => {
    let data = '';
    process.stdin.on('data', chunk => data += chunk);
    process.stdin.on('end', () => resolve(JSON.parse(data)));
  });
}

async function main() {
  const config = loadConfig();
  if (!config.enabled || config.mode === 'off') {
    console.log(JSON.stringify({ decision: 'allow' }));
    return;
  }

  const input = await readStdinJson();
  const { tool_name, tool_input } = input;

  // Only check Write and Edit
  if (!['Write', 'Edit'].includes(tool_name)) {
    console.log(JSON.stringify({ decision: 'allow' }));
    return;
  }

  const filePath = tool_input.file_path;

  // Check exclude paths
  if (config.excludePaths.some(p => filePath.includes(p))) {
    console.log(JSON.stringify({ decision: 'allow' }));
    return;
  }

  // Get content to check
  let content = '';
  if (tool_name === 'Write') {
    content = tool_input.content;
  } else if (tool_name === 'Edit') {
    // For Edit, check the new_string
    content = tool_input.new_string;
  }

  const { passed, issues } = checkPatterns(content, filePath);

  if (issues.length === 0) {
    console.log(JSON.stringify({ decision: 'allow' }));
    return;
  }

  // Format issues
  const issueText = formatIssues(issues, filePath);

  if (!passed && config.mode === 'block') {
    console.log(JSON.stringify({
      hookSpecificOutput: {
        hookEventName: 'PreToolUse',
        decision: 'block',
        reason: `CODING STANDARDS VIOLATION\n\n${issueText}\n\nFix the error-level issues to proceed.`,
      },
    }));
    return;
  }

  // Warn mode or passed with warnings
  console.log(JSON.stringify({
    decision: 'allow',
    message: `âš ï¸ Standards check:\n${issueText}`,
  }));
}

function formatIssues(issues, filePath) {
  const byLevel = { error: [], warn: [], info: [] };
  issues.forEach(i => byLevel[i.severity].push(i));

  let text = `File: ${filePath}\n`;

  if (byLevel.error.length > 0) {
    text += '\nâŒ ERRORS (must fix):\n';
    byLevel.error.forEach(i => {
      text += `  L${i.line}: ${i.message}\n    ${i.content}\n`;
    });
  }

  if (byLevel.warn.length > 0) {
    text += '\nâš ï¸ WARNINGS:\n';
    byLevel.warn.forEach(i => {
      text += `  L${i.line}: ${i.message}\n`;
    });
  }

  if (byLevel.info.length > 0) {
    text += '\nðŸ’¡ INFO:\n';
    byLevel.info.forEach(i => {
      text += `  L${i.line}: ${i.message}\n`;
    });
  }

  return text;
}

main().catch(console.error);
```

Make executable.
  </action>
  <verify>echo '{"tool_name":"Write","tool_input":{"file_path":"test.js","content":"console.log(x)"}}' | node ~/.claude/scripts/hooks/skills/standards/coding-standards.js</verify>
  <done>coding-standards.js detects anti-patterns and warns/blocks</done>
</task>

<task type="auto">
  <name>Task 3: Create Standards Commands</name>
  <files>~/.claude/commands/standards/check.md, ~/.claude/commands/standards/config.md</files>
  <action>
Create 2 standards commands:

**check.md:**
```markdown
# Check Coding Standards

Manually check a file or directory against coding standards.

## Usage
Specify a file path to check.

## On Invocation
\`\`\`bash
# Check specified file
node ~/.claude/scripts/hooks/skills/standards/check-file.js "$FILE_PATH"
\`\`\`

## Checks Performed
- **JavaScript/TypeScript:**
  - console.log in production code
  - `any` type usage
  - Hardcoded secrets
  - TODOs without issue links

- **Python:**
  - print() statements
  - Bare except clauses
  - Star imports

## Output
Lists all issues found with line numbers and severity.
```

**config.md:**
```markdown
# Configure Coding Standards

Manage coding standards enforcement settings.

## Options
- **mode:** `warn` (default), `block`, or `off`
- **excludePaths:** Paths to ignore

## Configuration File
`~/.claude/standards-config.json`

## Example
\`\`\`json
{
  "enabled": true,
  "mode": "block",
  "excludePaths": ["node_modules", "dist", "vendor"]
}
\`\`\`

## Modes
- **warn:** Show warnings but allow writes
- **block:** Block writes with error-level issues
- **off:** Disable standards checking

## To Enable Block Mode
\`\`\`bash
echo '{"enabled":true,"mode":"block"}' > ~/.claude/standards-config.json
\`\`\`
```
  </action>
  <verify>ls -la ~/.claude/commands/standards/</verify>
  <done>2 command files created: check.md, config.md</done>
</task>

<task type="auto">
  <name>Task 4: Add Hook Binding</name>
  <files>~/.claude/hooks.json</files>
  <action>
Add coding-standards hook to hooks.json:

```json
{
  "name": "coding-standards",
  "event": "PreToolUse",
  "script": "node ~/.claude/scripts/hooks/skills/standards/coding-standards.js",
  "description": "Enforce coding standards via pattern detection",
  "timeout": 5000,
  "enabled": true,
  "priority": 60
}
```

Priority 60 = after tdd-enforcer (50), before quality hooks (70+).
  </action>
  <verify>grep -A5 "coding-standards" ~/.claude/hooks.json</verify>
  <done>coding-standards hook registered in hooks.json</done>
</task>

<task type="auto">
  <name>Task 5: Create Tests</name>
  <files>~/.claude/scripts/hooks/skills/standards/standards.test.js</files>
  <action>
Create test suite (~25 tests):

**Pattern detection tests (12 tests):**
1. Detects console.log in JS
2. Ignores console.log in test files
3. Detects `any` type in TS
4. Ignores `any` in .d.ts files
5. Detects hardcoded secrets
6. Detects TODO without issue
7. Detects print() in Python
8. Ignores print() in test files
9. Detects bare except
10. Detects star imports
11. Returns line numbers correctly
12. detectFileType works for all extensions

**Hook behavior tests (8 tests):**
1. Allows when disabled
2. Allows excluded paths
3. Allows non-Write tools
4. Warns on warn mode with issues
5. Blocks on block mode with errors
6. Allows on block mode with only warnings
7. Config loading works
8. Default config used when missing

**Integration tests (5 tests):**
1. Full Write with clean code passes
2. Full Write with console.log warns
3. Full Edit with secret blocks
4. Multi-issue file shows all issues
5. Config mode change takes effect

Use temp files and mock stdin.
  </action>
  <verify>node --test ~/.claude/scripts/hooks/skills/standards/standards.test.js</verify>
  <done>25 tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] patterns.js exports anti-patterns for js/python
- [ ] coding-standards.js PreToolUse hook works
- [ ] /standards:check command works
- [ ] /standards:config command documents settings
- [ ] hooks.json updated with coding-standards binding
- [ ] 25 tests pass
- [ ] Manual test: Write file with console.log â†’ warning shown
- [ ] Manual test: Set block mode, write file with secret â†’ blocked
</verification>

<success_criteria>
- Pattern-based anti-pattern detection
- Configurable enforcement mode (warn/block/off)
- Multi-language support (JS, Python)
- Line-level issue reporting
- Exclude paths for generated code
- 25+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/15-skills-port/15-03-SUMMARY.md`
</output>
