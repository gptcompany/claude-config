---
phase: 15-skills-port
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - ~/.claude/scripts/hooks/skills/verification/verification-runner.js
  - ~/.claude/scripts/hooks/skills/verification/phases.js
  - ~/.claude/commands/verify/loop.md
  - ~/.claude/commands/verify/quick.md
autonomous: true
---

<objective>
Port verification-loop skill with 6-phase sequential validation.

Purpose: Create sequential verification runner (build→typecheck→lint→test→security→diff) with fail-fast logic and rich output formatting.
Output: Verification runner (~300 LOC), phases config (~100 LOC), 2 commands, 25+ tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-skills-port/15-RESEARCH.md

# ECC source reference:
# /media/sam/1TB/everything-claude-code/skills/verification-loop/SKILL.md

# Existing infrastructure:
@~/.claude/scripts/hooks/quality/ci-autofix.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phases Configuration</name>
  <files>~/.claude/scripts/hooks/skills/verification/phases.js</files>
  <action>
Create verification phases configuration (~100 LOC):

```javascript
const PHASES = [
  {
    name: 'build',
    displayName: 'Build',
    commands: {
      npm: 'npm run build 2>&1',
      yarn: 'yarn build 2>&1',
      pnpm: 'pnpm build 2>&1',
      make: 'make build 2>&1',
      cargo: 'cargo build 2>&1',
      go: 'go build ./... 2>&1',
      python: 'python -m py_compile $(find . -name "*.py" -not -path "./venv/*") 2>&1',
    },
    failFast: true,
    timeout: 120000,
    outputLimit: 50,
  },
  {
    name: 'typecheck',
    displayName: 'Type Check',
    commands: {
      typescript: 'npx tsc --noEmit 2>&1',
      mypy: 'mypy . 2>&1',
      pyright: 'pyright 2>&1',
    },
    failFast: true,
    timeout: 60000,
    outputLimit: 30,
  },
  {
    name: 'lint',
    displayName: 'Lint',
    commands: {
      eslint: 'npm run lint 2>&1 | head -30',
      ruff: 'ruff check . 2>&1 | head -30',
      golangci: 'golangci-lint run 2>&1 | head -30',
      clippy: 'cargo clippy 2>&1 | head -30',
    },
    failFast: false,
    timeout: 60000,
    outputLimit: 30,
  },
  {
    name: 'test',
    displayName: 'Tests',
    commands: {
      npm: 'npm test 2>&1 | tail -50',
      jest: 'npx jest --passWithNoTests 2>&1 | tail -50',
      pytest: 'pytest -v 2>&1 | tail -50',
      go: 'go test ./... 2>&1 | tail -50',
      cargo: 'cargo test 2>&1 | tail -50',
    },
    failFast: true,
    timeout: 180000,
    outputLimit: 50,
  },
  {
    name: 'security',
    displayName: 'Security',
    commands: {
      npm: 'npm audit --audit-level=high 2>&1 | head -20',
      snyk: 'snyk test 2>&1 | head -20',
      trivy: 'trivy fs . 2>&1 | head -20',
      bandit: 'bandit -r . 2>&1 | head -20',
    },
    failFast: false,
    timeout: 60000,
    outputLimit: 20,
  },
  {
    name: 'diff',
    displayName: 'Changes',
    commands: {
      git: 'git diff --stat && git diff --cached --stat',
    },
    failFast: false,
    timeout: 10000,
    outputLimit: 30,
  },
];

function detectProjectType() {
  // Detect based on package.json, Cargo.toml, go.mod, pyproject.toml, etc.
}

function getPhaseCommand(phase, projectType) {
  // Return appropriate command for project type
}

module.exports = { PHASES, detectProjectType, getPhaseCommand };
```
  </action>
  <verify>node -e "const p = require('$HOME/.claude/scripts/hooks/skills/verification/phases'); console.log(p.PHASES.length)"</verify>
  <done>phases.js exports 6 phases with multi-language support</done>
</task>

<task type="auto">
  <name>Task 2: Create Verification Runner</name>
  <files>~/.claude/scripts/hooks/skills/verification/verification-runner.js</files>
  <action>
Create sequential verification runner (~300 LOC):

```javascript
#!/usr/bin/env node
const { execSync } = require('child_process');
const { PHASES, detectProjectType, getPhaseCommand } = require('./phases');

class VerificationRunner {
  constructor(options = {}) {
    this.projectType = options.projectType || detectProjectType();
    this.skipPhases = options.skip || [];
    this.verbose = options.verbose || false;
    this.results = [];
  }

  async runPhase(phase) {
    if (this.skipPhases.includes(phase.name)) {
      return { name: phase.name, status: 'skipped', output: '' };
    }

    const command = getPhaseCommand(phase, this.projectType);
    if (!command) {
      return { name: phase.name, status: 'skipped', output: 'No command for project type' };
    }

    const startTime = Date.now();
    try {
      const output = execSync(command, {
        encoding: 'utf8',
        timeout: phase.timeout,
        stdio: ['pipe', 'pipe', 'pipe'],
        maxBuffer: 10 * 1024 * 1024,
      });
      return {
        name: phase.name,
        status: 'pass',
        output: this.truncateOutput(output, phase.outputLimit),
        duration: Date.now() - startTime,
      };
    } catch (err) {
      return {
        name: phase.name,
        status: 'fail',
        output: this.truncateOutput(err.stdout || err.message, phase.outputLimit),
        duration: Date.now() - startTime,
        exitCode: err.status,
      };
    }
  }

  truncateOutput(output, limit) {
    const lines = output.split('\n');
    if (lines.length <= limit) return output;
    return lines.slice(0, limit).join('\n') + `\n... (${lines.length - limit} more lines)`;
  }

  async run() {
    console.log(this.formatHeader());

    for (const phase of PHASES) {
      process.stderr.write(`[${phase.displayName}] Running...`);
      const result = await this.runPhase(phase);
      this.results.push(result);

      process.stderr.write(`\r${this.formatPhaseResult(result)}\n`);

      if (result.status === 'fail' && phase.failFast) {
        console.log(this.formatFailure(result));
        return { status: 'BLOCKED', failedAt: phase.name, results: this.results };
      }
    }

    return { status: 'READY', results: this.results };
  }

  formatHeader() {
    return `
╔═══════════════════════════════════════════╗
║     VERIFICATION LOOP (${this.projectType})     ║
╚═══════════════════════════════════════════╝
`;
  }

  formatPhaseResult(result) {
    const icon = result.status === 'pass' ? '✓' : result.status === 'fail' ? '✗' : '○';
    const color = result.status === 'pass' ? '\x1b[32m' : result.status === 'fail' ? '\x1b[31m' : '\x1b[33m';
    return `${color}[${icon}] ${result.name}\x1b[0m (${result.duration || 0}ms)`;
  }

  formatFailure(result) {
    return `
━━━ FAILED: ${result.name} ━━━
${result.output}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;
  }

  formatSummary() {
    const passed = this.results.filter(r => r.status === 'pass').length;
    const failed = this.results.filter(r => r.status === 'fail').length;
    const skipped = this.results.filter(r => r.status === 'skipped').length;
    return `
Summary: ${passed} passed, ${failed} failed, ${skipped} skipped
`;
  }
}

// CLI interface
if (require.main === module) {
  const args = process.argv.slice(2);
  const options = {
    skip: args.filter(a => a.startsWith('--skip=')).map(a => a.split('=')[1]),
    verbose: args.includes('--verbose'),
  };

  const runner = new VerificationRunner(options);
  runner.run().then(result => {
    console.log(runner.formatSummary());
    process.exit(result.status === 'READY' ? 0 : 1);
  });
}

module.exports = { VerificationRunner };
```
  </action>
  <verify>node ~/.claude/scripts/hooks/skills/verification/verification-runner.js --help 2>&1 || true</verify>
  <done>verification-runner.js runs 6-phase verification with fail-fast</done>
</task>

<task type="auto">
  <name>Task 3: Create Verify Commands</name>
  <files>~/.claude/commands/verify/loop.md, ~/.claude/commands/verify/quick.md</files>
  <action>
Create 2 verification commands:

**loop.md (full verification):**
```markdown
# Full Verification Loop

Run complete 6-phase verification:
1. Build
2. Type Check
3. Lint
4. Tests
5. Security
6. Diff

## On Invocation
\`\`\`bash
node ~/.claude/scripts/hooks/skills/verification/verification-runner.js
\`\`\`

## Behavior
- Runs phases sequentially
- Stops on first fail-fast failure (build, typecheck, test)
- Reports all issues for non-fail-fast phases (lint, security)
- Shows git diff summary at end

## Options
- `--skip=<phase>` - Skip a phase (e.g., --skip=security)
- `--verbose` - Show full output

## Output
Returns structured result:
- READY: All phases passed, code is ready
- BLOCKED: Failed at specific phase, fix needed
```

**quick.md (fast verification):**
```markdown
# Quick Verification

Run fast verification (skip slow phases):

## On Invocation
\`\`\`bash
node ~/.claude/scripts/hooks/skills/verification/verification-runner.js --skip=security
\`\`\`

## Phases Run
1. ✓ Build
2. ✓ Type Check
3. ✓ Lint
4. ✓ Tests
5. ○ Security (skipped)
6. ✓ Diff

## When to Use
- During development iteration
- Before commits (fast feedback)
- When security scan is slow

For full verification before PR: `/verify:loop`
```
  </action>
  <verify>ls -la ~/.claude/commands/verify/</verify>
  <done>2 command files created: loop.md, quick.md</done>
</task>

<task type="auto">
  <name>Task 4: Create Tests</name>
  <files>~/.claude/scripts/hooks/skills/verification/verification.test.js</files>
  <action>
Create test suite (~25 tests):

**Phase configuration tests (8 tests):**
1. PHASES has 6 entries
2. Each phase has required fields
3. detectProjectType identifies npm project
4. detectProjectType identifies Python project
5. getPhaseCommand returns correct command
6. getPhaseCommand returns null for unknown type
7. failFast is true for build/typecheck/test
8. failFast is false for lint/security/diff

**Runner tests (12 tests):**
1. Runner initializes with defaults
2. Runner detects project type
3. runPhase returns pass on success
4. runPhase returns fail on error
5. runPhase respects timeout
6. truncateOutput limits lines
7. Run stops on fail-fast failure
8. Run continues on non-fail-fast failure
9. Skip option works
10. Results array populated correctly
11. formatSummary shows correct counts
12. Exit code is 0 for READY, 1 for BLOCKED

**Integration tests (5 tests):**
1. Full run in test directory
2. Skip all phases runs cleanly
3. Verbose mode shows more output
4. Multiple skip options work
5. Handles missing commands gracefully

Use mock commands for consistent testing.
  </action>
  <verify>node --test ~/.claude/scripts/hooks/skills/verification/verification.test.js</verify>
  <done>25 tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] phases.js exports 6 phases with language detection
- [ ] verification-runner.js runs sequentially with fail-fast
- [ ] /verify:loop command works
- [ ] /verify:quick skips security phase
- [ ] 25 tests pass
- [ ] Manual test: Run in npm project → correct phases detected
</verification>

<success_criteria>
- 6-phase sequential verification
- Fail-fast on critical phases (build, typecheck, test)
- Multi-language support (npm, python, go, rust)
- Rich terminal output with colors
- 25+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/15-skills-port/15-02-SUMMARY.md`
</output>
