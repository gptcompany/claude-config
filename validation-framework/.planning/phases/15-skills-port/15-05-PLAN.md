---
phase: 15-skills-port
plan: 05
type: execute
wave: 3
depends_on: ["15-01", "15-02", "15-03", "15-04"]
files_modified:
  - ~/.claude/scripts/hooks/skills/gsd-triggers.js
  - ~/.claude/commands/gsd/execute-plan.md
  - ~/.claude/commands/gsd/verify-work.md
  - ~/.claude/hooks.json
autonomous: true
---

<objective>
Integrate skills with GSD workflow triggers.

Purpose: Wire TDD, verification, standards, and eval skills into GSD workflow events so they activate automatically at the right times.
Output: GSD triggers hook (~200 LOC), 2 updated commands, hooks.json bindings, 15+ tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-skills-port/15-RESEARCH.md

# GSD workflows:
@~/.claude/commands/gsd/execute-plan.md
@~/.claude/commands/gsd/verify-work.md

# Skills from earlier plans:
# ~/.claude/scripts/hooks/skills/tdd/tdd-state.js
# ~/.claude/scripts/hooks/skills/verification/verification-runner.js
# ~/.claude/scripts/hooks/skills/standards/coding-standards.js
# ~/.claude/scripts/hooks/skills/eval/eval-harness.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSD Triggers Hook</name>
  <files>~/.claude/scripts/hooks/skills/gsd-triggers.js</files>
  <action>
Create PostToolUse hook that triggers skills based on GSD events (~200 LOC):

```javascript
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const { getState, setState, PHASES } = require('./tdd/tdd-state');
const { VerificationRunner } = require('./verification/verification-runner');
const { EvalHarness } = require('./eval/eval-harness');

const TRIGGERS = {
  // When a PLAN.md file is written â†’ suggest TDD workflow
  'plan-created': {
    match: (filePath) => filePath.includes('PLAN.md'),
    action: 'suggest-tdd',
  },

  // When test file written â†’ track as eval attempt
  'test-written': {
    match: (filePath) => isTestFile(filePath),
    action: 'track-eval',
  },

  // When implementation file written in TDD mode â†’ run tests
  'impl-written': {
    match: (filePath, state) => state.phase === PHASES.GREEN && !isTestFile(filePath),
    action: 'run-tests',
  },

  // When SUMMARY.md created â†’ run verification
  'plan-complete': {
    match: (filePath) => filePath.includes('SUMMARY.md'),
    action: 'run-verification',
  },
};

function isTestFile(filePath) {
  return /\.(test|spec)\.(js|ts|jsx|tsx)$/.test(filePath) ||
         /test_.*\.py$/.test(filePath) ||
         /_test\.py$/.test(filePath);
}

async function readStdinJson() {
  return new Promise((resolve) => {
    let data = '';
    process.stdin.on('data', chunk => data += chunk);
    process.stdin.on('end', () => resolve(JSON.parse(data)));
  });
}

async function main() {
  const input = await readStdinJson();
  const { tool_name, tool_input, tool_result } = input;

  // Only trigger on successful Write/Edit
  if (!['Write', 'Edit'].includes(tool_name)) {
    console.log(JSON.stringify({}));
    return;
  }

  if (tool_result?.error) {
    console.log(JSON.stringify({}));
    return;
  }

  const filePath = tool_input.file_path;
  const state = getState();

  // Check each trigger
  for (const [name, trigger] of Object.entries(TRIGGERS)) {
    if (trigger.match(filePath, state)) {
      await handleTrigger(name, trigger.action, filePath, state);
      break; // Only one trigger per event
    }
  }

  console.log(JSON.stringify({}));
}

async function handleTrigger(name, action, filePath, state) {
  const messages = [];

  switch (action) {
    case 'suggest-tdd':
      if (state.phase === PHASES.IDLE) {
        messages.push('ðŸ’¡ New plan detected. Consider starting TDD workflow: /tdd:red');
      }
      break;

    case 'track-eval':
      // Record as eval attempt if in TDD mode
      if (state.phase !== PHASES.IDLE) {
        const harness = new EvalHarness({ attempt: 1 });
        // Don't run, just log that test was written
        messages.push(`ðŸ“ Test written: ${path.basename(filePath)}`);
      }
      break;

    case 'run-tests':
      // Auto-run tests when implementation written in GREEN phase
      try {
        const harness = new EvalHarness({ attempt: 1 });
        const result = await harness.run();
        if (result.run.passed) {
          messages.push('âœ… Tests passing! Ready to: /tdd:refactor');
        } else {
          messages.push(`âŒ Tests failing: ${result.run.testsFailed} failed. Keep implementing.`);
        }
      } catch {
        messages.push('âš ï¸ Could not run tests automatically');
      }
      break;

    case 'run-verification':
      messages.push('ðŸ“‹ Plan complete. Running verification loop...');
      try {
        const runner = new VerificationRunner({ skip: ['security'] }); // Quick verify
        const result = await runner.run();
        if (result.status === 'READY') {
          messages.push('âœ… Verification passed!');
        } else {
          messages.push(`âŒ Verification failed at: ${result.failedAt}`);
        }
      } catch {
        messages.push('âš ï¸ Could not run verification automatically');
      }
      break;
  }

  if (messages.length > 0) {
    // Output as hook message
    console.error(messages.join('\n'));
  }
}

main().catch(console.error);
```

Make executable.
  </action>
  <verify>echo '{"tool_name":"Write","tool_input":{"file_path":"test.test.js"},"tool_result":{}}' | node ~/.claude/scripts/hooks/skills/gsd-triggers.js 2>&1</verify>
  <done>gsd-triggers.js triggers skills on GSD events</done>
</task>

<task type="auto">
  <name>Task 2: Update execute-plan.md Command</name>
  <files>~/.claude/commands/gsd/execute-plan.md</files>
  <action>
Update execute-plan.md to integrate TDD workflow:

Add section at the beginning of the execution instructions:

```markdown
## Pre-Execution Setup

Before executing tasks, initialize the appropriate workflow:

### For Implementation Tasks
\`\`\`bash
# Start TDD workflow
node ~/.claude/scripts/hooks/skills/tdd/set-state.js set RED
\`\`\`

This enables:
- âœ… Test-first enforcement (blocked until tests exist)
- âœ… Automatic test running on implementation
- âœ… Pass@k metrics tracking

### For Non-Implementation Tasks
Skip TDD workflow (documentation, configuration, etc.)

## During Execution

The following skills activate automatically:
- **TDD Enforcer**: Blocks implementation without tests
- **Coding Standards**: Warns on anti-patterns
- **Eval Harness**: Tracks test success rates

## Post-Execution

After completing all tasks:
\`\`\`bash
# Exit TDD mode
node ~/.claude/scripts/hooks/skills/tdd/set-state.js clear

# Run full verification
node ~/.claude/scripts/hooks/skills/verification/verification-runner.js
\`\`\`
```

Keep existing content, just add these sections.
  </action>
  <verify>grep -A5 "Pre-Execution Setup" ~/.claude/commands/gsd/execute-plan.md</verify>
  <done>execute-plan.md includes TDD and verification integration</done>
</task>

<task type="auto">
  <name>Task 3: Update verify-work.md Command</name>
  <files>~/.claude/commands/gsd/verify-work.md</files>
  <action>
Update verify-work.md to use verification loop:

Add section for automated verification:

```markdown
## Automated Verification

Before UAT, run the 6-phase verification loop:

\`\`\`bash
node ~/.claude/scripts/hooks/skills/verification/verification-runner.js
\`\`\`

### Phases Checked
1. âœ“ Build - Compiles without errors
2. âœ“ Type Check - No type errors
3. âœ“ Lint - No lint violations
4. âœ“ Tests - All tests pass
5. âœ“ Security - No high vulnerabilities
6. âœ“ Diff - Review changes

### Pass Requirements
- Tier 1 (fail-fast): Build, Type Check, Tests
- Tier 2 (warnings): Lint, Security

### Eval Metrics
Check test success rates:
\`\`\`bash
node ~/.claude/scripts/hooks/skills/eval/eval-harness.js --summary
\`\`\`

## Manual UAT

After automated verification passes, proceed with manual UAT...
```

Keep existing UAT content below.
  </action>
  <verify>grep -A5 "Automated Verification" ~/.claude/commands/gsd/verify-work.md</verify>
  <done>verify-work.md includes verification loop integration</done>
</task>

<task type="auto">
  <name>Task 4: Add Hook Bindings</name>
  <files>~/.claude/hooks.json</files>
  <action>
Add gsd-triggers hook to hooks.json:

```json
{
  "name": "gsd-triggers",
  "event": "PostToolUse",
  "script": "node ~/.claude/scripts/hooks/skills/gsd-triggers.js",
  "description": "Trigger skills based on GSD workflow events",
  "timeout": 10000,
  "enabled": true,
  "priority": 80
}
```

Priority 80 = after quality hooks, responds to completed actions.
  </action>
  <verify>grep -A5 "gsd-triggers" ~/.claude/hooks.json</verify>
  <done>gsd-triggers hook registered in hooks.json</done>
</task>

<task type="auto">
  <name>Task 5: Create Tests</name>
  <files>~/.claude/scripts/hooks/skills/gsd-triggers.test.js</files>
  <action>
Create test suite (~15 tests):

**Trigger matching tests (6 tests):**
1. plan-created matches PLAN.md
2. test-written matches *.test.js
3. test-written matches test_*.py
4. impl-written matches in GREEN phase
5. impl-written doesn't match in IDLE
6. plan-complete matches SUMMARY.md

**Action tests (6 tests):**
1. suggest-tdd outputs message in IDLE
2. suggest-tdd silent when already in TDD
3. track-eval logs test file
4. run-tests executes in GREEN phase
5. run-verification executes on SUMMARY
6. Actions handle errors gracefully

**Integration tests (3 tests):**
1. Full PLAN.md write suggests TDD
2. Full test file write tracks eval
3. Full SUMMARY.md triggers verification

Use mock stdin and capture stderr for messages.
  </action>
  <verify>node --test ~/.claude/scripts/hooks/skills/gsd-triggers.test.js</verify>
  <done>15 tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gsd-triggers.js PostToolUse hook works
- [ ] execute-plan.md updated with TDD integration
- [ ] verify-work.md updated with verification loop
- [ ] hooks.json includes gsd-triggers binding
- [ ] 15 tests pass
- [ ] Manual test: Write PLAN.md â†’ TDD suggestion shown
- [ ] Manual test: Complete plan â†’ verification runs
</verification>

<success_criteria>
- GSD workflows automatically trigger skills
- TDD workflow suggested on new plans
- Verification runs on plan completion
- Eval metrics tracked during execution
- Graceful handling of missing dependencies
- 15+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/15-skills-port/15-05-SUMMARY.md`
</output>
