---
phase: 04-trading-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/templates/validation/trading/test_paper_trading.py.j2
  - ~/.claude/templates/validation/trading/test_risk_limits.py.j2
  - ~/.claude/templates/validation/trading/analysis-templates.yaml.j2
autonomous: true
---

<objective>
Create trading domain extension templates for validation pipeline.

Purpose: Enable trading projects (nautilus_dev) to validate paper trading execution, risk limits enforcement, and Argo Rollouts canary analysis with VaR/drawdown triggers.
Output: Three Jinja2 templates in ~/.claude/templates/validation/trading/
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference patterns:
- ~/.claude/templates/validation/smoke/test_imports.py.j2 (pytest template structure)
- ~/.claude/templates/validation/config.schema.json (config variables: domain, rollback_triggers)
- /media/sam/1TB/nautilus_dev/k8s/rollouts/analysis-templates.yaml (Argo AnalysisTemplate structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_paper_trading.py.j2 (EXT-TRADING-01)</name>
  <files>~/.claude/templates/validation/trading/test_paper_trading.py.j2</files>
  <action>
Create pytest template for paper trading validation:

1. File header with project_name, domain Jinja2 variables
2. TestPaperTradingExecution class with @pytest.mark.trading decorator:
   - test_order_submission: Verify orders submit without error
   - test_order_fill_simulation: Verify simulated fills return expected structure
   - test_position_tracking: Verify positions update after fills
   - test_balance_updates: Verify balance reflects P&L after trades
3. TestPaperTradingEdgeCases class:
   - test_insufficient_balance: Verify rejection when balance insufficient
   - test_invalid_symbol: Verify rejection for unknown symbols
   - test_zero_quantity: Verify rejection for zero/negative quantity
4. Use conftest fixture pattern (paper_trading_client) for test setup
5. Template variables from config.json: project_name, domain (should be "trading")
6. Add conditional block: only generate tests if domain == "trading"

Follow existing smoke template patterns (see test_imports.py.j2 for structure).
  </action>
  <verify>python3 -c "from jinja2 import Template; Template(open('$HOME/.claude/templates/validation/trading/test_paper_trading.py.j2').read())"</verify>
  <done>Template parses without Jinja2 syntax errors, contains all test classes</done>
</task>

<task type="auto">
  <name>Task 2: Create test_risk_limits.py.j2 (EXT-TRADING-02)</name>
  <files>~/.claude/templates/validation/trading/test_risk_limits.py.j2</files>
  <action>
Create pytest template for risk limit enforcement tests:

1. File header with project_name, domain Jinja2 variables
2. TestRiskLimits class with @pytest.mark.trading decorator:
   - test_max_position_size: Verify position size limits enforced
   - test_max_drawdown_threshold: Verify drawdown triggers halt
   - test_var_threshold: Verify VaR limit triggers risk reduction
   - test_daily_loss_limit: Verify daily P&L limit enforced
3. TestRiskLimitConfiguration class:
   - test_limits_from_config: Verify limits load from config correctly
   - test_limit_update_propagation: Verify runtime limit updates apply
4. TestCircuitBreaker class:
   - test_circuit_breaker_triggers: Verify circuit breaker activates on threshold
   - test_circuit_breaker_recovery: Verify recovery after cooldown
5. Use conftest fixture pattern (risk_manager) for test setup
6. Template variables: project_name, domain, rollback_triggers (for thresholds)
7. Add conditional: only generate if domain == "trading"

Reference config.schema.json rollback_triggers structure for threshold values.
  </action>
  <verify>python3 -c "from jinja2 import Template; Template(open('$HOME/.claude/templates/validation/trading/test_risk_limits.py.j2').read())"</verify>
  <done>Template parses without Jinja2 syntax errors, contains all risk test classes</done>
</task>

<task type="auto">
  <name>Task 3: Create analysis-templates.yaml.j2 (EXT-TRADING-03)</name>
  <files>~/.claude/templates/validation/trading/analysis-templates.yaml.j2</files>
  <action>
Create Argo Rollouts AnalysisTemplate Jinja2 template:

1. YAML header comment with template info
2. Generate AnalysisTemplate for each rollback_trigger in config:
   {% for trigger in rollback_triggers %}
   - apiVersion: argoproj.io/v1alpha1
   - kind: AnalysisTemplate
   - metadata.name: {{ project_name }}-{{ trigger.metric | replace('_', '-') }}
   - metadata.namespace: {{ k8s.namespace | default('default') }}
   - spec.metrics with Prometheus provider:
     - interval: 1m
     - count: 10
     - successCondition based on trigger.operator and trigger.threshold
     - failureLimit: 3 (default, stricter for VaR/drawdown)
     - provider.prometheus.address: http://prometheus.monitoring.svc.cluster.local:9090
     - provider.prometheus.query: generates PromQL based on trigger.metric
   {% endfor %}

3. Include pre-built templates for common trading metrics:
   - trading-success-rate (error_rate < 5%)
   - trading-latency (latency_p99_ms < 100)
   - trading-var (var_pct < threshold from config)
   - trading-drawdown (drawdown_pct < threshold from config)

4. Reference nautilus_dev analysis-templates.yaml for PromQL patterns
5. Use Jinja2 conditionals for optional metrics based on config

Template variables: project_name, k8s.namespace, rollback_triggers array
  </action>
  <verify>python3 -c "from jinja2 import Template; Template(open('$HOME/.claude/templates/validation/trading/analysis-templates.yaml.j2').read())"</verify>
  <done>Template parses without Jinja2 syntax errors, generates valid Argo AnalysisTemplate YAML</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All three .j2 files exist in ~/.claude/templates/validation/trading/
- [ ] All templates parse without Jinja2 syntax errors
- [ ] Templates reference correct config variables (project_name, domain, rollback_triggers)
- [ ] pytest templates follow existing smoke/ patterns
- [ ] analysis-templates.yaml follows Argo AnalysisTemplate spec
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No Jinja2 syntax errors
- Templates integrate with existing config.schema.json structure
</success_criteria>

<output>
After completion, create `.planning/phases/04-trading-extension/04-01-SUMMARY.md`
</output>
