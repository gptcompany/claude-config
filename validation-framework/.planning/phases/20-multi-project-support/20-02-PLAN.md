---
phase: 20-multi-project-support
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - ~/.claude/templates/validation/monorepo.py
  - ~/.claude/templates/validation/tests/test_monorepo.py
autonomous: true
---

<objective>
Implement monorepo package discovery via directory convention.

Purpose: Auto-detect packages in monorepos by scanning for `.claude/validation/config.json` in subdirectories, enabling validation across all packages with a single command.

Output: `monorepo.py` module with discovery logic, 10 tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-multi-project-support/20-CONTEXT.md
@.planning/phases/20-multi-project-support/20-01-SUMMARY.md

@~/.claude/templates/validation/config_loader.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create monorepo.py module</name>
  <files>~/.claude/templates/validation/monorepo.py</files>
  <action>
Create new module with:

1. `IGNORE_DIRS = {'.git', 'node_modules', '__pycache__', '.venv', 'venv', 'dist', 'build', '.next', '.nuxt'}`

2. `PackageInfo` dataclass:
   ```python
   @dataclass
   class PackageInfo:
       name: str           # Directory name
       path: Path          # Absolute path to package root
       config_path: Path   # Path to config.json
       config: dict        # Loaded (merged) config
   ```

3. `is_ignored(path: Path) -> bool`:
   - Check if path matches IGNORE_DIRS
   - Optionally check .gitignore if present (simple patterns only)

4. `discover_packages(root: Path | None = None, max_depth: int = 3) -> list[PackageInfo]`:
   - If root is None, use cwd
   - Recursively scan for `.claude/validation/config.json`
   - Respect max_depth to avoid deep traversal
   - Skip ignored directories
   - For each found config, use `load_config()` from config_loader
   - Return list of PackageInfo sorted by path

5. `is_monorepo(root: Path | None = None) -> bool`:
   - Return True if >1 package discovered
  </action>
  <verify>cd ~/.claude/templates/validation && python -c "from monorepo import discover_packages; print(discover_packages())"</verify>
  <done>monorepo.py exists with discovery logic</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests</name>
  <files>~/.claude/templates/validation/tests/test_monorepo.py</files>
  <action>
Create test file with 10 tests:

1. `test_discover_single_project` - single package found at root
2. `test_discover_monorepo` - multiple packages found
3. `test_ignore_node_modules` - node_modules skipped
4. `test_ignore_pycache` - __pycache__ skipped
5. `test_ignore_git` - .git skipped
6. `test_max_depth_respected` - deep packages not found if beyond max_depth
7. `test_is_monorepo_true` - returns True for multi-package
8. `test_is_monorepo_false` - returns False for single package
9. `test_package_info_has_merged_config` - config includes global merge
10. `test_empty_directory` - returns empty list gracefully

Use tmp_path fixture to create test directory structures.
  </action>
  <verify>cd ~/.claude/templates/validation && pytest tests/test_monorepo.py -v</verify>
  <done>10 tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Add CLI entry point for discovery</name>
  <files>~/.claude/templates/validation/monorepo.py</files>
  <action>
Add `if __name__ == "__main__"` block:

```python
if __name__ == "__main__":
    import sys
    root = Path(sys.argv[1]) if len(sys.argv) > 1 else None
    packages = discover_packages(root)

    if not packages:
        print("No packages found")
        sys.exit(0)

    print(f"Found {len(packages)} package(s):")
    for pkg in packages:
        print(f"  - {pkg.name}: {pkg.path}")
```

This allows: `python monorepo.py /path/to/monorepo`
  </action>
  <verify>cd ~/.claude/templates/validation && python monorepo.py .</verify>
  <done>CLI entry point works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_monorepo.py -v` - 10 tests pass
- [ ] `python monorepo.py .` - shows package list or "No packages found"
- [ ] Create temp monorepo structure, verify discovery works
</verification>

<success_criteria>
- monorepo.py created with discovery logic
- PackageInfo dataclass with merged config
- 10 tests pass
- CLI entry point functional
</success_criteria>

<output>
After completion, create `.planning/phases/20-multi-project-support/20-02-SUMMARY.md`
</output>
