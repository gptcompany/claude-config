---
phase: 03-local-k8s
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - ~/.claude/templates/validation/k8s/mock-prometheus.yaml.j2
  - ~/.claude/templates/validation/k8s/test-rollout-local.sh.j2
  - ~/.claude/templates/validation/ci/local-k8s-test.yml.j2
autonomous: true
---

<objective>
Create mock Prometheus, rollout test script, and CI workflow for local K8s validation.

Purpose: Complete the local K8s testing story with mock metrics, a test runner, and CI integration.
Output: Three Jinja2 templates (2 in k8s/, 1 in ci/)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-local-k8s/03-01-SUMMARY.md

Reference patterns:
- /media/sam/1TB/nautilus_dev/k8s/rollouts/analysis-templates.yaml (Argo analysis)
- ~/.claude/templates/validation/config.schema.json (rollback_triggers structure)
- ~/.claude/templates/validation/ci/smoke-tests.yml.j2 (CI workflow pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock-prometheus.yaml.j2 (K8S-05)</name>
  <files>~/.claude/templates/validation/k8s/mock-prometheus.yaml.j2</files>
  <action>
Create mock Prometheus deployment for local testing:

1. Namespace: monitoring (created if not exists)
2. ConfigMap with static metrics file:
   - Name: mock-metrics
   - Data contains metrics in Prometheus exposition format:
     {% for trigger in rollback_triggers %}
     # Mock metric for {{ trigger.metric }}
     {{ trigger.metric }}{service="{{ project_name }}"} {{ trigger.threshold * 0.5 }}
     {% endfor %}
     # Default healthy metrics
     error_rate{service="{{ project_name }}"} 0.01
     latency_p99_ms{service="{{ project_name }}"} 50
3. Deployment:
   - Name: mock-prometheus
   - Image: prom/prometheus:v2.48.0
   - Mount ConfigMap at /etc/prometheus/targets/
   - Args: --config.file=/etc/prometheus/prometheus.yml --web.enable-lifecycle
4. Service:
   - Port 9090 exposed as ClusterIP
   - Also NodePort 30090 for local access
5. Prometheus config ConfigMap:
   - Global scrape interval: 15s
   - Static configs pointing to mock metrics file

Template variables:
- {{ project_name }} — metric labels
- {{ rollback_triggers }} — array from config.json for metric generation
  </action>
  <verify>
python3 -c "
import jinja2
env = jinja2.Environment()
template = env.from_string(open('$HOME/.claude/templates/validation/k8s/mock-prometheus.yaml.j2').read())
print('Template valid')
"
  </verify>
  <done>mock-prometheus.yaml.j2 exists, generates metrics from rollback_triggers config</done>
</task>

<task type="auto">
  <name>Task 2: Create test-rollout-local.sh.j2 (K8S-03)</name>
  <files>~/.claude/templates/validation/k8s/test-rollout-local.sh.j2</files>
  <action>
Create canary rollout test script:

1. Shebang: #!/usr/bin/env bash
2. set -euo pipefail
3. Variables:
   - NAMESPACE="{{ k8s.namespace | default('default') }}"
   - ROLLOUT_NAME="{{ project_name }}-rollout"
   - TIMEOUT="{{ k8s.rollout_timeout | default('10m') }}"
4. Pre-flight:
   - Check argo-rollouts plugin: kubectl argo rollouts version
   - Check cluster accessible: kubectl cluster-info
5. Apply test rollout (if not exists):
   - Create minimal Rollout resource for testing
   - Use nginx:alpine as test image
   - Canary steps: 5% → 25% → 100%
6. Trigger rollout:
   - kubectl argo rollouts set image $ROLLOUT_NAME nginx=nginx:1.25-alpine -n $NAMESPACE
7. Monitor rollout:
   - kubectl argo rollouts status $ROLLOUT_NAME -n $NAMESPACE --timeout=$TIMEOUT
8. Verify analysis passed:
   - Check AnalysisRun status: kubectl get analysisrun -n $NAMESPACE -l rollout=$ROLLOUT_NAME
9. Print results and cleanup option
  </action>
  <verify>
python3 -c "
import jinja2
env = jinja2.Environment()
template = env.from_string(open('$HOME/.claude/templates/validation/k8s/test-rollout-local.sh.j2').read())
print('Template valid')
"
  </verify>
  <done>test-rollout-local.sh.j2 exists, tests canary progression 5%→25%→100%</done>
</task>

<task type="auto">
  <name>Task 3: Create local-k8s-test.yml.j2 (CI-03)</name>
  <files>~/.claude/templates/validation/ci/local-k8s-test.yml.j2</files>
  <action>
Create GitHub Actions workflow for local K8s testing:

1. Workflow name: "Local K8s Validation"
2. Triggers:
   - workflow_dispatch (manual only — local K8s tests are expensive)
   - Optional inputs: skip_teardown (boolean, default false)
3. Single job "local-k8s" with:
   - runs-on: ubuntu-latest
   - timeout-minutes: {{ k8s.ci_timeout_minutes | default(30) }}
4. Steps:
   a. Checkout: actions/checkout@v4
   b. Install k3d:
      - curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
   c. Install kubectl:
      - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      - chmod +x kubectl && sudo mv kubectl /usr/local/bin/
   d. Install Argo Rollouts kubectl plugin:
      - curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
      - chmod +x kubectl-argo-rollouts-linux-amd64 && sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
   e. Setup cluster:
      - chmod +x k8s/setup-local-cluster.sh
      - ./k8s/setup-local-cluster.sh
   f. Apply mock Prometheus:
      - kubectl apply -f k8s/mock-prometheus.yaml
   g. Run rollout test:
      - chmod +x k8s/test-rollout-local.sh
      - ./k8s/test-rollout-local.sh
   h. Teardown (conditional):
      - if: ${{ '{{' }} inputs.skip_teardown != true ${{ '}}' }}
      - chmod +x k8s/teardown.sh
      - ./k8s/teardown.sh

Use proper Jinja2 escaping for GitHub Actions: ${{ '{{' }} and ${{ '}}' }}
  </action>
  <verify>
python3 -c "
import jinja2
env = jinja2.Environment()
template = env.from_string(open('$HOME/.claude/templates/validation/ci/local-k8s-test.yml.j2').read())
print('Template valid')
"
  </verify>
  <done>local-k8s-test.yml.j2 exists, manual trigger, installs k3d in CI</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All three .j2 files exist (2 in k8s/, 1 in ci/)
- [ ] Templates parse without Jinja2 syntax errors
- [ ] CI workflow uses proper GitHub Actions variable escaping
- [ ] Mock Prometheus generates metrics from rollback_triggers
- [ ] Test script monitors canary progression
</verification>

<success_criteria>
- All tasks completed
- Mock Prometheus template uses config.json rollback_triggers
- Test script validates 5%→25%→100% canary steps
- CI workflow is manual-trigger only (workflow_dispatch)
- No Jinja2 syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-local-k8s/03-02-SUMMARY.md`
</output>
