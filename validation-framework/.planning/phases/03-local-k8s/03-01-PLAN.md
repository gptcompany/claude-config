---
phase: 03-local-k8s
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/templates/validation/k8s/k3d-config.yaml.j2
  - ~/.claude/templates/validation/k8s/setup-local-cluster.sh.j2
  - ~/.claude/templates/validation/k8s/teardown.sh.j2
autonomous: true
---

<objective>
Create k3d cluster configuration and lifecycle scripts for local Kubernetes testing.

Purpose: Enable projects to spin up a lightweight local K8s cluster for testing Argo Rollouts canary deployments before pushing to production.
Output: Three Jinja2 templates in ~/.claude/templates/validation/k8s/
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference patterns:
- /media/sam/1TB/nautilus_dev/k8s/rollouts/trading-service.yaml (Argo Rollout example)
- ~/.claude/templates/validation/config.schema.json (k8s config structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create k3d-config.yaml.j2 (K8S-01)</name>
  <files>~/.claude/templates/validation/k8s/k3d-config.yaml.j2</files>
  <action>
Create k3d cluster configuration template:

1. apiVersion: k3d.io/v1alpha5
2. kind: Simple
3. metadata.name: {{ project_name }}-local
4. servers: 1 (single control plane)
5. agents: {{ k8s.agents | default(2) }} (worker nodes)
6. image: rancher/k3s:v1.28.5-k3s1 (stable version)
7. ports:
   - port: 80:80 (ingress HTTP)
   - port: 443:443 (ingress HTTPS)
   - port: 9090:9090 (Prometheus metrics)
8. options:
   - k3s: ["--disable=traefik"] (we use nginx-ingress)
9. registries:
   - create: true (local registry for testing)
   - name: registry.localhost
   - port: 5000

Template variables from config.json:
- {{ project_name }} — cluster naming
- {{ k8s.namespace | default("default") }} — target namespace
- {{ k8s.agents | default(2) }} — number of worker nodes
  </action>
  <verify>
python3 -c "
import jinja2
env = jinja2.Environment()
template = env.from_string(open('$HOME/.claude/templates/validation/k8s/k3d-config.yaml.j2').read())
print('Template valid')
"
  </verify>
  <done>k3d-config.yaml.j2 exists, valid Jinja2 syntax, configurable cluster settings</done>
</task>

<task type="auto">
  <name>Task 2: Create setup-local-cluster.sh.j2 (K8S-02)</name>
  <files>~/.claude/templates/validation/k8s/setup-local-cluster.sh.j2</files>
  <action>
Create cluster setup script template:

1. Shebang: #!/usr/bin/env bash
2. set -euo pipefail (strict mode)
3. Variables:
   - CLUSTER_NAME="{{ project_name }}-local"
   - NAMESPACE="{{ k8s.namespace | default('default') }}"
4. Pre-flight checks:
   - Check k3d installed: command -v k3d
   - Check kubectl installed: command -v kubectl
   - Check helm installed: command -v helm
5. Create cluster:
   - k3d cluster create --config k3d-config.yaml
   - Wait for cluster ready: kubectl wait --for=condition=Ready nodes --all --timeout=120s
6. Install Argo Rollouts:
   - kubectl create namespace argo-rollouts --dry-run=client -o yaml | kubectl apply -f -
   - kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml
   - Wait for rollouts controller: kubectl wait --for=condition=Available deployment/argo-rollouts -n argo-rollouts --timeout=120s
7. Create target namespace:
   - kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
8. Apply mock Prometheus (if exists):
   - kubectl apply -f mock-prometheus.yaml -n monitoring --dry-run=client -o yaml | kubectl apply -f - 2>/dev/null || true
9. Print success message with cluster info
  </action>
  <verify>
bash -n ~/.claude/templates/validation/k8s/setup-local-cluster.sh.j2 2>&1 | grep -v "{{" || echo "Jinja2 template (bash -n skips Jinja vars)"
python3 -c "
import jinja2
env = jinja2.Environment()
template = env.from_string(open('$HOME/.claude/templates/validation/k8s/setup-local-cluster.sh.j2').read())
print('Template valid')
"
  </verify>
  <done>setup-local-cluster.sh.j2 exists, installs k3d + Argo Rollouts, configurable namespace</done>
</task>

<task type="auto">
  <name>Task 3: Create teardown.sh.j2 (K8S-04)</name>
  <files>~/.claude/templates/validation/k8s/teardown.sh.j2</files>
  <action>
Create cluster cleanup script template:

1. Shebang: #!/usr/bin/env bash
2. set -euo pipefail
3. Variables:
   - CLUSTER_NAME="{{ project_name }}-local"
4. Check cluster exists:
   - k3d cluster list | grep -q "$CLUSTER_NAME" || { echo "Cluster not found"; exit 0; }
5. Delete cluster:
   - k3d cluster delete "$CLUSTER_NAME"
6. Clean up local registry:
   - docker volume rm k3d-${CLUSTER_NAME}-images 2>/dev/null || true
7. Remove kubeconfig context:
   - kubectl config delete-context k3d-${CLUSTER_NAME} 2>/dev/null || true
8. Print cleanup complete message
  </action>
  <verify>
python3 -c "
import jinja2
env = jinja2.Environment()
template = env.from_string(open('$HOME/.claude/templates/validation/k8s/teardown.sh.j2').read())
print('Template valid')
"
  </verify>
  <done>teardown.sh.j2 exists, safely removes cluster and artifacts, idempotent</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All three .j2 files exist in ~/.claude/templates/validation/k8s/
- [ ] Templates parse without Jinja2 syntax errors
- [ ] Templates reference config variables correctly (project_name, k8s.*)
- [ ] Scripts use strict mode (set -euo pipefail)
</verification>

<success_criteria>
- All tasks completed
- k3d config template created with configurable nodes
- Setup script installs Argo Rollouts
- Teardown script is idempotent
- No Jinja2 syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-local-k8s/03-01-SUMMARY.md`
</output>
