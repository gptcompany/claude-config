# Plan 01-02: Smoke Test Jinja2 Templates

**Phase**: 1 - Core Framework
**Requirements**: SMOKE-01, SMOKE-02, SMOKE-03, SMOKE-04
**Status**: Ready

---

## Objective

Create Jinja2 templates for smoke tests that can be rendered with project-specific configuration.

## Discovery Notes

**Reference Implementations:**
- `/media/sam/1TB/nautilus_dev/tests/conftest.py` — Pytest fixture patterns, sys.path handling
- `/media/sam/1TB/nautilus_dev/.github/workflows/ci-cd-pipeline.yml` — Stage structure (lint, tests, integration)

**Key Patterns from nautilus_dev:**
- Uses `@pytest.fixture` decorators
- MagicMock for service mocking
- sys.path manipulation for test discovery
- TYPE_CHECKING imports for type hints

**Gap Identified:** nautilus_dev has no smoke tests. These templates fill that gap.

---

## Tasks

### T01: Create test_imports.py.j2 (SMOKE-01)

**File**: `~/.claude/templates/validation/smoke/test_imports.py.j2`

Template that generates import validation tests:
- Iterates over `smoke_tests.critical_imports` from config
- Creates test function for each import
- Includes Python version check
- Uses `@pytest.mark.smoke` marker

**Template Variables:**
- `{{ project_name }}` — Project identifier
- `{{ smoke_tests.critical_imports }}` — List of import paths

**Acceptance Criteria:**
- [ ] Generated tests pass ruff lint
- [ ] Generated tests pass mypy type check
- [ ] Tests correctly import from config critical_imports

### T02: Create test_config.py.j2 (SMOKE-02)

**File**: `~/.claude/templates/validation/smoke/test_config.py.j2`

Template that validates config files exist and parse:
- Iterates over `smoke_tests.config_files` from config
- Tests file existence
- Tests file parsing (YAML, JSON, TOML based on extension)
- Schema validation if schema provided

**Template Variables:**
- `{{ project_name }}` — Project identifier
- `{{ smoke_tests.config_files }}` — List of config file paths

**Acceptance Criteria:**
- [ ] Tests file existence
- [ ] Tests file parsing by extension
- [ ] Handles missing files gracefully

### T03: Create test_connectivity.py.j2 (SMOKE-03)

**File**: `~/.claude/templates/validation/smoke/test_connectivity.py.j2`

Template that validates external service connectivity:
- Iterates over `smoke_tests.external_services` from config
- Tests TCP connectivity (socket)
- Optional health endpoint check
- Configurable timeout

**Template Variables:**
- `{{ project_name }}` — Project identifier
- `{{ smoke_tests.external_services }}` — List of "host:port" strings

**Acceptance Criteria:**
- [ ] Tests TCP connectivity
- [ ] Handles connection timeouts
- [ ] Skips if service not required (pytest.mark.skip)

### T04: Create conftest.py.j2 (SMOKE-04)

**File**: `~/.claude/templates/validation/smoke/conftest.py.j2`

Shared pytest fixtures template:
- Project root path fixture
- Config loader fixture (reads validation config)
- Skip markers for optional services
- Timeout configuration

**Template Variables:**
- `{{ project_name }}` — Project identifier

**Acceptance Criteria:**
- [ ] Provides reusable fixtures
- [ ] Handles config loading
- [ ] Sets up pytest markers

---

## Implementation Order

1. T04 (conftest) — Foundation fixtures
2. T01 (imports) — Simplest test
3. T02 (config) — Builds on fixtures
4. T03 (connectivity) — Most complex

## Files Created

```
~/.claude/templates/validation/smoke/
├── conftest.py.j2          [T04]
├── test_imports.py.j2      [T01]
├── test_config.py.j2       [T02]
└── test_connectivity.py.j2 [T03]
```

## Verification

```bash
# After scaffolding a test project
cd /tmp/test-validation

# Render templates (if jinja2-cli available)
jinja2 ~/.claude/templates/validation/smoke/test_imports.py.j2 \
  -D project_name="test_project" \
  -D smoke_tests='{"critical_imports": ["os", "sys", "json"]}'

# Verify generated code
ruff check tests/smoke/
mypy tests/smoke/ --ignore-missing-imports

# Run smoke tests
pytest tests/smoke -v -m smoke --timeout=120
```

---

## Dependencies

- Plan 01-01 (scaffold creates the directory structure)

## Blocked By

- Plan 01-01

## Blocks

- Phase 2 (CI workflows reference smoke tests)
