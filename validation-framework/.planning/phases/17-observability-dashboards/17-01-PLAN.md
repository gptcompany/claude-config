---
phase: 17-observability-dashboards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/grafana/alerting/contact-points.yaml
  - ~/.claude/grafana/alerting/alert-rules.yaml
  - ~/.claude/grafana/alerting/notification-policies.yaml
  - /etc/grafana/provisioning/alerting/validation.yaml
autonomous: true
---

<objective>
Set up Discord alert notifications for validation failures using Grafana Unified Alerting.

Purpose: Alert-first observability - get notified immediately when Tier 1 validators fail, without watching dashboards.
Output: Working Discord alerts that fire on validation failures with proper grouping and flap prevention.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-observability-dashboards/17-RESEARCH.md
@.planning/phases/17-observability-dashboards/17-CONTEXT.md
@~/.claude/scripts/lib/metrics.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Grafana alerting directory structure and contact point</name>
  <files>~/.claude/grafana/alerting/contact-points.yaml</files>
  <action>
1. Create directory: `mkdir -p ~/.claude/grafana/alerting`
2. Create contact-points.yaml with Discord webhook configuration:
   - Use YAML file provisioning format (apiVersion: 1)
   - Reference DISCORD_WEBHOOK_URL from environment
   - Set meaningful message template with validation context
   - Include severity label in message

Reference from RESEARCH.md:
```yaml
apiVersion: 1
contactPoints:
  - orgId: 1
    name: discord-validation
    receivers:
      - uid: discord-webhook
        type: discord
        settings:
          url: ${DISCORD_WEBHOOK_URL}
          message: |
            {{ template "validation.alert" . }}
```

AVOID: Hardcoding webhook URL - use env var substitution.
  </action>
  <verify>File exists at ~/.claude/grafana/alerting/contact-points.yaml with valid YAML structure</verify>
  <done>Contact point YAML created with Discord webhook config</done>
</task>

<task type="auto">
  <name>Task 2: Create alert rules for Tier 1 validation failures</name>
  <files>~/.claude/grafana/alerting/alert-rules.yaml</files>
  <action>
Create alert-rules.yaml with rules for validation failures:

1. **Tier 1 Critical Alert** (syntax, tests, imports):
   - Condition: pass_rate < 80% over 5 minutes
   - Labels: severity=critical, tier=1
   - for: 5m (flap prevention)
   - Query: QuestDB pass rate for Tier 1 dimensions

2. **Tier 2 Warning Alert** (linting, types, coverage):
   - Condition: pass_rate < 70% over 10 minutes
   - Labels: severity=warning, tier=2
   - for: 10m

3. **Quality Score Drop Alert**:
   - Condition: quality score drops >20% from baseline
   - Labels: severity=warning, type=quality

Use $__timeFilter for time range macros. Reference RESEARCH.md for SQL patterns.

AVOID: Alerting on raw events (causes spam). Use aggregated pass rates.
  </action>
  <verify>alert-rules.yaml contains valid YAML with 3 rule definitions</verify>
  <done>Alert rules YAML created with Tier 1, Tier 2, and quality score rules</done>
</task>

<task type="auto">
  <name>Task 3: Create notification policy and provision to Grafana</name>
  <files>~/.claude/grafana/alerting/notification-policies.yaml, /etc/grafana/provisioning/alerting/validation.yaml</files>
  <action>
1. Create notification-policies.yaml:
   - Root policy: group by alertname
   - Route critical (tier=1) to discord-validation immediately
   - Route warnings (tier=2) with 5m group_wait
   - Set group_interval: 5m to batch alerts
   - Set repeat_interval: 4h to prevent spam

2. Create provisioning config at /etc/grafana/provisioning/alerting/validation.yaml:
   - Point to ~/.claude/grafana/alerting/ as source
   - Enable file provisioning for contact points, rules, and policies

3. Restart Grafana to load provisioned alerts:
   `sudo systemctl restart grafana-server`

4. Verify provisioning worked via API:
   `curl -s http://localhost:3000/api/v1/provisioning/alert-rules | head`

AVOID: Missing orgId (must be 1 for default org).
  </action>
  <verify>curl http://localhost:3000/api/v1/provisioning/alert-rules returns the provisioned rules</verify>
  <done>Alert rules provisioned and Grafana restarted, rules visible via API</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ~/.claude/grafana/alerting/ directory exists with 3 YAML files
- [ ] Grafana alerting API shows provisioned rules
- [ ] Contact point shows discord-validation configured
- [ ] No YAML syntax errors in Grafana logs
</verification>

<success_criteria>
- All 3 alert configuration files created
- Grafana provisioning configured and working
- Alert rules visible in Grafana UI (Alerting > Alert rules)
- Contact point visible (Alerting > Contact points)
</success_criteria>

<output>
After completion, create `.planning/phases/17-observability-dashboards/17-01-SUMMARY.md`
</output>
