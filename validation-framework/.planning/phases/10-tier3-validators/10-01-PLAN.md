---
phase: 10-tier3-validators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/templates/validation/validators/mathematical/__init__.py
  - ~/.claude/templates/validation/validators/mathematical/validator.py
  - ~/.claude/templates/validation/validators/mathematical/cas_client.py
  - ~/.claude/templates/validation/validators/mathematical/formula_extractor.py
  - ~/.claude/templates/validation/orchestrator.py
  - ~/.claude/templates/validation/orchestrator.py.j2
autonomous: true
---

<objective>
Create MathematicalValidator that validates LaTeX formulas via CAS microservice with Wolfram MCP fallback.

Purpose: Enable proactive formula validation for research papers and inline code math, catching errors before they compound.
Output: Working MathematicalValidator integrated into orchestrator, with CAS client and formula extractor.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-tier3-validators/10-CONTEXT.md
@.planning/phases/10-tier3-validators/10-RESEARCH.md
@~/.claude/templates/validation/orchestrator.py
@~/.claude/templates/validation/validators/design_principles/validator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CAS client with fallback</name>
  <files>~/.claude/templates/validation/validators/mathematical/cas_client.py, ~/.claude/templates/validation/validators/mathematical/__init__.py</files>
  <action>
Create CASClient class that:
1. Connects to localhost:8769 via httpx with 30s timeout
2. POST to /validate with {"latex": "...", "cas": "maxima|sagemath|matlab"}
3. On ConnectError, return degraded result with `cas_available: false`
4. Include health_check() method that calls /health endpoint
5. Parse response JSON: {success, simplified, factored, confidence, time_ms}

Do NOT implement Wolfram MCP fallback yet - just return error status when CAS unavailable.
The _wolfram_fallback method should be a stub that returns {"success": False, "error": "CAS unavailable, Wolfram fallback not implemented"}.

Use httpx.Client (sync) not AsyncClient - keep it simple for first iteration.
  </action>
  <verify>
cd ~/.claude/templates/validation/validators/mathematical
python3 -c "from cas_client import CASClient; c = CASClient(); print('Import OK')"
  </verify>
  <done>CASClient class importable, handles connection errors gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Create formula extractor</name>
  <files>~/.claude/templates/validation/validators/mathematical/formula_extractor.py</files>
  <action>
Create FormulaExtractor class that:
1. Uses Python AST to extract docstrings from functions, classes, modules
2. Regex matches `:math:`...`` RST directives in docstrings
3. Also matches `$...$` and `$$...$$` LaTeX delimiters in docstrings/comments
4. Returns list of ExtractedFormula dataclass: {latex: str, file: Path, line: int, context: str}
5. Has extract_from_file(path: Path) and extract_from_directory(path: Path, pattern="**/*.py") methods

Use stdlib only (ast, re, pathlib). No external dependencies.
  </action>
  <verify>
cd ~/.claude/templates/validation/validators/mathematical
python3 -c "from formula_extractor import FormulaExtractor; f = FormulaExtractor(); print('Import OK')"
  </verify>
  <done>FormulaExtractor extracts math from docstrings and comments</done>
</task>

<task type="auto">
  <name>Task 3: Create MathematicalValidator and integrate</name>
  <files>~/.claude/templates/validation/validators/mathematical/validator.py, ~/.claude/templates/validation/orchestrator.py, ~/.claude/templates/validation/orchestrator.py.j2</files>
  <action>
1. Create MathematicalValidator class:
   - dimension = "mathematical"
   - tier = ValidationTier.MONITOR (Tier 3)
   - No auto-fix agent (formulas need human review)
   - Uses CASClient and FormulaExtractor
   - validate() method:
     a. Extract formulas from project files
     b. Validate each via CAS client
     c. Return ValidationResult with:
        - passed: True if all formulas valid OR no formulas found OR CAS unavailable (graceful degradation)
        - message: Summary of validation ("X formulas validated, Y errors" or "CAS unavailable" or "No formulas found")
        - details: {formulas_found, validated, errors, cas_available}

2. Update orchestrator.py:
   - Add import with fallback: `from validators.mathematical.validator import MathematicalValidator as MathematicalValidatorImpl`
   - Create MathematicalValidator wrapper class like DesignPrinciplesValidator
   - Keep BaseValidator stub as fallback

3. Update orchestrator.py.j2 template with same changes
  </action>
  <verify>
cd ~/.claude/templates/validation
python3 -c "from orchestrator import ValidationOrchestrator; o = ValidationOrchestrator(); print('mathematical' in o.VALIDATOR_REGISTRY)"
python3 -c "from validators.mathematical.validator import MathematicalValidator; print('Import OK')"
  </verify>
  <done>MathematicalValidator integrated into orchestrator, falls back gracefully when CAS unavailable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All files created in validators/mathematical/
- [ ] CASClient handles connection errors without crashing
- [ ] FormulaExtractor finds :math:, $, and $$ formulas
- [ ] MathematicalValidator returns valid ValidationResult
- [ ] Orchestrator loads real implementation with fallback
- [ ] `python3 -m orchestrator --tier 3` runs without error
</verification>

<success_criteria>

- MathematicalValidator created with CAS client and formula extractor
- Graceful degradation when CAS microservice unavailable
- Orchestrator imports real implementation with fallback
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-tier3-validators/10-01-SUMMARY.md`
</output>
