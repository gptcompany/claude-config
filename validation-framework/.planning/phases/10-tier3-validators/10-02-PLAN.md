---
phase: 10-tier3-validators
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/templates/validation/validators/api_contract/__init__.py
  - ~/.claude/templates/validation/validators/api_contract/validator.py
  - ~/.claude/templates/validation/validators/api_contract/spec_discovery.py
  - ~/.claude/templates/validation/validators/api_contract/oasdiff_runner.py
  - ~/.claude/templates/validation/orchestrator.py
  - ~/.claude/templates/validation/orchestrator.py.j2
autonomous: true
---

<objective>
Create APIContractValidator that detects OpenAPI spec breaking changes via oasdiff CLI.

Purpose: Catch API contract breaks before they reach consumers, enabling proactive drift detection.
Output: Working APIContractValidator integrated into orchestrator, with spec discovery and oasdiff runner.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-tier3-validators/10-CONTEXT.md
@.planning/phases/10-tier3-validators/10-RESEARCH.md
@~/.claude/templates/validation/orchestrator.py
@~/.claude/templates/validation/validators/design_principles/validator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spec discovery and oasdiff runner</name>
  <files>~/.claude/templates/validation/validators/api_contract/spec_discovery.py, ~/.claude/templates/validation/validators/api_contract/oasdiff_runner.py, ~/.claude/templates/validation/validators/api_contract/__init__.py</files>
  <action>
1. Create SpecDiscovery class:
   - STANDARD_PATHS = ["openapi.yaml", "openapi.json", "api/openapi.yaml", "api/openapi.json", "docs/openapi.yaml", "docs/openapi.json", "swagger.yaml", "swagger.json"]
   - find_specs(project_root: Path) -> list[Path]: Check standard paths + glob **openapi*.yaml and **openapi*.json
   - Config override: Accept optional list from validation config
   - Return empty list if no specs found (graceful degradation)

2. Create OasdiffRunner class:
   - __init__(binary: str = "oasdiff"): Store binary path
   - breaking_changes(base_spec: Path, revision_spec: Path) -> dict:
     a. Run subprocess: [binary, "breaking", str(base), str(revision), "-f", "json"]
     b. Timeout 30s, capture stdout/stderr
     c. Return code 0 = no breaking changes, non-zero = has breaking changes
     d. Parse JSON output for messages with level/code/path
     e. Handle FileNotFoundError (oasdiff not installed) gracefully
   - is_available() -> bool: Check if oasdiff binary exists (subprocess.run with --version)

Use stdlib subprocess only. No external dependencies.
  </action>
  <verify>
cd ~/.claude/templates/validation/validators/api_contract
python3 -c "from spec_discovery import SpecDiscovery; s = SpecDiscovery(); print('Import OK')"
python3 -c "from oasdiff_runner import OasdiffRunner; o = OasdiffRunner(); print(f'Available: {o.is_available()}')"
  </verify>
  <done>SpecDiscovery and OasdiffRunner classes created with graceful degradation</done>
</task>

<task type="auto">
  <name>Task 2: Create APIContractValidator and integrate</name>
  <files>~/.claude/templates/validation/validators/api_contract/validator.py, ~/.claude/templates/validation/orchestrator.py, ~/.claude/templates/validation/orchestrator.py.j2</files>
  <action>
1. Create APIContractValidator class:
   - dimension = "api_contract"
   - tier = ValidationTier.MONITOR (Tier 3)
   - No auto-fix agent (contract changes need human review)
   - Uses SpecDiscovery and OasdiffRunner
   - __init__(config: dict | None = None): Accept optional config with baseline_spec_path
   - validate() method:
     a. Find specs via SpecDiscovery
     b. If no specs found: return passed=True, message="No OpenAPI specs found"
     c. If oasdiff not installed: return passed=True, message="oasdiff not installed (skipped)"
     d. For breaking change detection:
        - If config has "baseline_spec" path, compare current spec against baseline
        - Otherwise, just validate spec exists (no baseline comparison)
     e. Return ValidationResult with:
        - passed: True if no breaking changes detected OR no baseline to compare
        - message: "No breaking changes" or "X breaking changes detected" or "No baseline configured"
        - details: {specs_found, oasdiff_available, breaking_changes: [...]}

2. Update orchestrator.py:
   - Add import with fallback: `from validators.api_contract.validator import APIContractValidator as APIContractValidatorImpl`
   - Create APIContractValidator wrapper class like DesignPrinciplesValidator
   - Keep BaseValidator stub as fallback

3. Update orchestrator.py.j2 template with same changes

Note: Baseline tracking is out of scope for this plan - just detect if oasdiff finds issues when baseline is provided via config. Phase 11 can add git-based baseline tracking.
  </action>
  <verify>
cd ~/.claude/templates/validation
python3 -c "from orchestrator import ValidationOrchestrator; o = ValidationOrchestrator(); print('api_contract' in o.VALIDATOR_REGISTRY)"
python3 -c "from validators.api_contract.validator import APIContractValidator; print('Import OK')"
  </verify>
  <done>APIContractValidator integrated into orchestrator, handles missing oasdiff gracefully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All files created in validators/api_contract/
- [ ] SpecDiscovery finds specs in standard locations
- [ ] OasdiffRunner handles missing binary gracefully
- [ ] APIContractValidator returns valid ValidationResult
- [ ] Orchestrator loads real implementation with fallback
- [ ] `python3 -m orchestrator --tier 3` runs without error
</verification>

<success_criteria>

- APIContractValidator created with spec discovery and oasdiff runner
- Graceful degradation when oasdiff not installed or no specs found
- Orchestrator imports real implementation with fallback
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-tier3-validators/10-02-SUMMARY.md`
</output>
