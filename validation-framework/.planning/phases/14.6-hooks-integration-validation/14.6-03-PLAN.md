---
phase: 14.6-hooks-integration-validation
plan: 03
type: execute
wave: 2
depends_on: ["14.6-01", "14.6-02"]
files_modified: [~/.claude/scripts/hooks/performance/benchmark.test.js, ~/.claude/scripts/hooks/performance/error-recovery.test.js, ~/.claude/scripts/hooks/performance/concurrent.test.js, ~/.claude/scripts/hooks/performance/stress.test.js]
autonomous: true
---

<objective>
Performance and reliability tests ensuring hooks work under load and recover from errors.

Purpose: Validate hooks are production-ready with acceptable latency, error recovery, and concurrent execution.
Output: 4 test files with ~43 tests covering benchmarks, error recovery, concurrency, and stress testing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.6-hooks-integration-validation/14.6-01-PLAN.md
@.planning/phases/14.6-hooks-integration-validation/14.6-02-PLAN.md

# Performance baseline from Phase 14.5
@.planning/phases/14.5-hooks-shared-port/14.5-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Benchmark Tests</name>
  <files>~/.claude/scripts/hooks/performance/benchmark.test.js</files>
  <action>
Create benchmark tests with timing constraints (~12 tests):

**Performance requirements:**
1. `individual hook latency` (6 tests)
   - Safety hooks: < 100ms
   - Intelligence hooks: < 200ms
   - Quality hooks: < 300ms
   - Productivity hooks: < 150ms
   - Metrics hooks: < 100ms
   - UX hooks: < 150ms

2. `hook chain latency` (3 tests)
   - Session start chain: < 500ms total
   - Tool use chain: < 500ms total
   - Session end chain: < 500ms total

3. `QuestDB export latency` (3 tests)
   - Single metric export: < 50ms
   - Batch export (100 rows): < 200ms
   - Query response: < 100ms (or skip if unavailable)

Use performance.now() for timing. Run each benchmark 10 times, use median.
Record baseline numbers in test comments for future comparison.
  </action>
  <verify>node --test ~/.claude/scripts/hooks/performance/benchmark.test.js passes all timing constraints</verify>
  <done>12 benchmark tests pass within timing constraints</done>
</task>

<task type="auto">
  <name>Task 2: Error Recovery Tests</name>
  <files>~/.claude/scripts/hooks/performance/error-recovery.test.js</files>
  <action>
Create error recovery tests (~12 tests):

**Recovery scenarios:**
1. `hook failure isolation` (4 tests)
   - Single hook failure doesn't crash chain
   - Failed hook logged but execution continues
   - Exit code reflects failure
   - Error details captured in stderr

2. `malformed input handling` (4 tests)
   - Invalid JSON input -> graceful error
   - Missing required fields -> graceful error
   - Null/undefined values -> handled
   - Extremely large input -> handled (or rejected)

3. `external dependency failures` (4 tests)
   - QuestDB unavailable -> local fallback
   - Git repo unavailable -> graceful degrade
   - Missing config files -> sensible defaults
   - File permission errors -> logged and skipped

Verify no crashes, no data corruption, always returns valid JSON or exits cleanly.
  </action>
  <verify>node --test ~/.claude/scripts/hooks/performance/error-recovery.test.js passes</verify>
  <done>12 error recovery tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Concurrent Execution Tests</name>
  <files>~/.claude/scripts/hooks/performance/concurrent.test.js</files>
  <action>
Create concurrent execution tests (~10 tests):

**Concurrency scenarios:**
1. `parallel hook execution` (4 tests)
   - Run 5 hooks simultaneously
   - Verify all complete
   - Verify no output corruption
   - Verify metrics not duplicated

2. `file locking` (3 tests)
   - Two agents write to same metrics file
   - Verify locking prevents corruption
   - Verify data integrity after unlock

3. `race condition prevention` (3 tests)
   - Rapid claim/release cycles
   - Concurrent session start/end
   - Simultaneous QuestDB exports

Use Promise.all() and child_process.fork() for parallel execution.
Verify with file checksums and data integrity checks.
  </action>
  <verify>node --test ~/.claude/scripts/hooks/performance/concurrent.test.js passes</verify>
  <done>10 concurrency tests pass</done>
</task>

<task type="auto">
  <name>Task 4: Stress Tests</name>
  <files>~/.claude/scripts/hooks/performance/stress.test.js</files>
  <action>
Create stress tests (~9 tests):

**Stress scenarios:**
1. `high volume hook calls` (3 tests)
   - 100 hook invocations in sequence
   - Verify no memory leak (RSS stable)
   - Verify timing consistent (no degradation)

2. `large payload handling` (3 tests)
   - 1MB JSON input -> handled or rejected gracefully
   - 1000-file git diff -> handled
   - 10000-line log file -> handled

3. `sustained load` (3 tests)
   - Run hooks for 60 seconds continuously
   - Verify metrics file doesn't grow unbounded
   - Verify log rotation works
   - Verify no file handle leaks

Use process.memoryUsage() and fs.statSync() to measure resource consumption.
Set reasonable limits (e.g., fail if RSS > 200MB).
  </action>
  <verify>node --test ~/.claude/scripts/hooks/performance/stress.test.js passes</verify>
  <done>9 stress tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] node --test ~/.claude/scripts/hooks/performance/benchmark.test.js passes
- [ ] node --test ~/.claude/scripts/hooks/performance/error-recovery.test.js passes
- [ ] node --test ~/.claude/scripts/hooks/performance/concurrent.test.js passes
- [ ] node --test ~/.claude/scripts/hooks/performance/stress.test.js passes
- [ ] All 4 test files created in performance/ directory
- [ ] Total ~43 performance/reliability tests added
</verification>

<success_criteria>
- All tasks completed
- ~43 performance tests written and passing
- Timing constraints documented and met
- Error recovery verified
- No resource leaks detected
</success_criteria>

<output>
After completion, create `.planning/phases/14.6-hooks-integration-validation/14.6-03-SUMMARY.md`
</output>
