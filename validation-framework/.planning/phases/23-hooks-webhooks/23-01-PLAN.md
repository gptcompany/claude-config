---
phase: 23-hooks-webhooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/openclaw/.openclaw/hooks/validation-gate/HOOK.md
  - /home/openclaw/.openclaw/hooks/validation-gate/handler.ts
  - /home/sam/moltbot-infra/clawdbot-config/openclaw.json
autonomous: true
user_setup: []
---

<objective>
Create custom validation-gate hook and configure OpenClaw webhook surface with GitHub→Matrix routing.

Purpose: Enable quality gate injection at agent bootstrap and declarative webhook routing for external triggers.
Output: Working validation-gate hook + openclaw.json with hooks.enabled, webhook token, and github mapping.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-hooks-webhooks/23-RESEARCH.md
@.planning/phases/22-agent-config/22-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation-gate hook</name>
  <files>/home/openclaw/.openclaw/hooks/validation-gate/HOOK.md, /home/openclaw/.openclaw/hooks/validation-gate/handler.ts</files>
  <action>
    SSH to muletto and create hook files on the node (Workstation) via the openclaw user's home.

    **HOOK.md:**
    - name: validation-gate
    - events: ["agent:bootstrap"]
    - requires.bins: ["python3"]
    - requires.config: ["workspace.dir"]
    - requires.os: ["linux"]
    - always: false (only when eligible)

    **handler.ts:**
    - On agent:bootstrap event, inject VALIDATION.md into bootstrapFiles
    - Content: remind agent to run tests, check validation score, report metrics before completing tasks
    - Push success message to event.messages

    Create on Workstation via SSH: `ssh 192.168.1.111` as sam, then write files to `/home/openclaw/.openclaw/hooks/validation-gate/`.
    Set ownership: `sudo chown -R openclaw:openclaw /home/openclaw/.openclaw/hooks/validation-gate/`
  </action>
  <verify>
    SSH to muletto, run: `docker exec openclaw-gateway node /app/dist/entry.js hooks list`
    Verify validation-gate appears in output.
    Run: `docker exec openclaw-gateway node /app/dist/entry.js hooks list --eligible`
    Verify validation-gate is eligible (python3 + workspace.dir present).
  </verify>
  <done>validation-gate hook exists, is discovered by OpenClaw, and shows as eligible</done>
</task>

<task type="auto">
  <name>Task 2: Configure openclaw.json webhook surface + GitHub mapping</name>
  <files>/home/sam/moltbot-infra/clawdbot-config/openclaw.json</files>
  <action>
    Read current openclaw.json from muletto gateway config.
    Add/update the `hooks` section:

    1. **hooks.internal.entries** — add `"validation-gate": { "enabled": true }` alongside existing entries (session-memory, command-logger, boot-md)

    2. **hooks.enabled**: true (webhook surface)

    3. **hooks.token** — generate a random 32-char hex token using `openssl rand -hex 16`. Store this token:
       - In openclaw.json as `hooks.token`
       - Add `OPENCLAW_WEBHOOK_TOKEN` to SOPS `/media/sam/1TB/.env.enc`

    4. **hooks.path**: "/hooks"

    5. **hooks.mappings.github**:
       ```json
       {
         "match": { "source": "github" },
         "action": "agent",
         "deliver": true,
         "channel": "matrix",
         "to": "!GQeiGgJenxtCKbaxDL:matrix.lan"
       }
       ```

    6. Validate JSON with `jq .` before deploying

    7. Copy updated config to muletto: `scp openclaw.json sam@192.168.1.100:/home/sam/moltbot-infra/clawdbot-config/openclaw.json`

    8. Restart gateway: `ssh 192.168.1.100 'cd /home/sam/moltbot-infra && docker compose restart openclaw-gateway'`

    **Do NOT use `hooks.internal.handlers[]` array format** — use `entries{}` object format (array is deprecated).
    **Do NOT put token in query params** — header auth only (x-openclaw-token).
  </action>
  <verify>
    1. `ssh 192.168.1.100 'docker exec openclaw-gateway node /app/dist/entry.js doctor'` — 0 errors
    2. `ssh 192.168.1.100 'docker exec openclaw-gateway node /app/dist/entry.js hooks list'` — shows validation-gate enabled
    3. Test webhook surface responds:
       `ssh 192.168.1.100 'curl -s -o /dev/null -w "%{http_code}" -X POST http://127.0.0.1:8090/hooks/wake -H "x-openclaw-token: <token>"'`
       Should return 200 or 202.
  </verify>
  <done>openclaw.json has hooks section with validation-gate entry, webhook surface enabled with token auth, github mapping configured. Gateway restarted and healthy.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `openclaw doctor` shows 0 errors
- [ ] `openclaw hooks list` shows validation-gate as enabled
- [ ] Webhook surface responds to authenticated requests
- [ ] openclaw.json is valid JSON
- [ ] OPENCLAW_WEBHOOK_TOKEN stored in SOPS
</verification>

<success_criteria>

- All tasks completed
- validation-gate hook discovered and eligible
- Webhook surface active with token auth
- GitHub mapping configured for Matrix delivery
- No errors introduced in gateway
  </success_criteria>

<output>
After completion, create `.planning/phases/23-hooks-webhooks/23-01-SUMMARY.md`
</output>
