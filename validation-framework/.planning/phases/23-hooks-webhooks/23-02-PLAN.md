---
phase: 23-hooks-webhooks
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - /opt/webhookd/.env
  - /opt/webhookd/mod.ts
  - /etc/systemd/system/webhookd.service
autonomous: false
user_setup:
  - service: github
    why: "GitHub webhook endpoint configuration"
    dashboard_config:
      - task: "Create webhook on target repo(s)"
        location: "GitHub repo → Settings → Webhooks → Add webhook"
        details: "Payload URL: https://webhooks.princyx.xyz/webhook, Content type: application/json, Secret: value from GITHUB_WEBHOOK_SECRET in SOPS, Events: Issues, Pull requests, Check runs"
---

<objective>
Deploy webhookd as GitHub webhook receiver on muletto, expose via Cloudflare Tunnel, and verify end-to-end flow.

Purpose: Enable GitHub events to trigger OpenClaw agent actions with automatic Matrix escalation.
Output: Working webhookd service, CF Tunnel route, GitHub webhook configured, E2E flow verified.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-hooks-webhooks/23-RESEARCH.md
@.planning/phases/23-hooks-webhooks/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy webhookd on muletto</name>
  <files>/opt/webhookd/.env, /opt/webhookd/mod.ts, /etc/systemd/system/webhookd.service</files>
  <action>
    SSH to muletto (192.168.1.100):

    1. **Install Deno** (if not present): `curl -fsSL https://deno.land/install.sh | sh`

    2. **Clone/setup webhookd** in `/opt/webhookd/`:
       - Clone from OpenClaw repo webhookd service, or create minimal Deno server that:
         a. Listens on port 8787
         b. Accepts POST /webhook
         c. Verifies GitHub HMAC-SHA256 signature (X-Hub-Signature-256 header)
         d. Extracts event type from X-GitHub-Event header
         e. Normalizes payload into message string (event type + key fields)
         f. POSTs to `http://127.0.0.1:8090/hooks/agent` with:
            - `x-openclaw-token` header (from OPENCLAW_WEBHOOK_TOKEN)
            - Body: `{ message, name: "GitHub", sessionKey: "github-{event}-{id}", deliver: true, channel: "matrix", to: "!GQeiGgJenxtCKbaxDL:matrix.lan", thinking: "medium", timeoutSeconds: 300 }`
         g. Responds 202 immediately to GitHub (async processing)

    3. **Create .env file:**
       ```
       GITHUB_WEBHOOK_SECRET=<generate with openssl rand -hex 20>
       OPENCLAW_WEBHOOK_TOKEN=<from Plan 23-01>
       OPENCLAW_GATEWAY_URL=http://127.0.0.1:8090
       IGNORE_GITHUB_ACTORS=clawdbot[bot]
       PORT=8787
       ```
       Store GITHUB_WEBHOOK_SECRET in SOPS `/media/sam/1TB/.env.enc`

    4. **Create systemd service** at `/etc/systemd/system/webhookd.service`:
       - Type=simple, WorkingDirectory=/opt/webhookd
       - ExecStart: `deno run -A --env-file=.env mod.ts`
       - Restart=always, RestartSec=2
       - Security: NoNewPrivileges=true, PrivateTmp=true, ProtectSystem=strict, ReadWritePaths=/opt/webhookd

    5. **Enable and start:** `sudo systemctl enable --now webhookd`

    6. **Add CF Tunnel route** for `webhooks.princyx.xyz` pointing to `http://localhost:8787`:
       - Edit CF Tunnel config on muletto (typically `/etc/cloudflared/config.yml` or via `cloudflared tunnel route`)
       - Restart cloudflared if needed

    **IGNORE_GITHUB_ACTORS** prevents webhook loops when bot comments on issues/PRs.
    **Respond 202 immediately** — do NOT wait for agent completion (GitHub retries after 10s).
  </action>
  <verify>
    1. `sudo systemctl status webhookd` — active (running)
    2. `curl -s -o /dev/null -w "%{http_code}" http://localhost:8787/webhook` — returns 400 or 405 (no POST body, but service is up)
    3. `curl -s https://webhooks.princyx.xyz/webhook` — accessible via CF Tunnel (same 400/405)
    4. `journalctl -u webhookd --no-pager -n 5` — no errors
  </verify>
  <done>webhookd running on muletto:8787, exposed via CF Tunnel at webhooks.princyx.xyz, GitHub HMAC verification active</done>
</task>

<task type="auto">
  <name>Task 2: Test E2E webhook flow</name>
  <files>None (testing only)</files>
  <action>
    Test the complete flow locally (without GitHub):

    1. **Generate test HMAC signature:**
       ```bash
       PAYLOAD='{"action":"opened","issue":{"number":999,"title":"Test webhook flow","body":"Automated test"}}'
       SECRET=$(sops --input-type dotenv --output-type dotenv -d /media/sam/1TB/.env.enc 2>/dev/null | grep GITHUB_WEBHOOK_SECRET | cut -d= -f2)
       SIG="sha256=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$SECRET" | cut -d' ' -f2)"
       ```

    2. **Send test webhook to webhookd:**
       ```bash
       curl -X POST http://192.168.1.100:8787/webhook \
         -H "Content-Type: application/json" \
         -H "X-GitHub-Event: issues" \
         -H "X-Hub-Signature-256: $SIG" \
         -d "$PAYLOAD"
       ```
       Expected: 202 Accepted

    3. **Verify agent received the message:**
       Check Matrix channel `!GQeiGgJenxtCKbaxDL:matrix.lan` for agent response about "Test webhook flow".
       Or check gateway logs: `docker logs openclaw-gateway --tail 20`

    4. **Test invalid signature rejection:**
       ```bash
       curl -X POST http://192.168.1.100:8787/webhook \
         -H "Content-Type: application/json" \
         -H "X-GitHub-Event: issues" \
         -H "X-Hub-Signature-256: sha256=invalid" \
         -d "$PAYLOAD"
       ```
       Expected: 401 or 403 (signature mismatch)

    5. **Test actor ignore:**
       Send payload with `"sender": {"login": "clawdbot[bot]"}` — should be silently ignored (200 but no forwarding).
  </action>
  <verify>
    - 202 for valid signature
    - 401/403 for invalid signature
    - Agent response visible in Matrix or gateway logs
    - clawdbot[bot] payloads ignored
  </verify>
  <done>E2E flow verified: GitHub event → webhookd → HMAC verify → gateway /hooks/agent → agent processes → Matrix delivery</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete hooks & webhooks pipeline: validation-gate hook, webhook surface, webhookd receiver, CF Tunnel, E2E flow</what-built>
  <how-to-verify>
    1. Check Matrix channel "bambam" for the test webhook response from the agent
    2. Verify the agent understood and processed the fake issue #999
    3. SSH to muletto: `sudo systemctl status webhookd` — should be active
    4. Test CF Tunnel: `curl -s -o /dev/null -w "%{http_code}" https://webhooks.princyx.xyz/webhook` — returns 400/405 (alive)
    5. Check `openclaw hooks list` shows validation-gate
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] webhookd service running on muletto
- [ ] CF Tunnel route active for webhooks.princyx.xyz
- [ ] HMAC signature verification works (valid accepted, invalid rejected)
- [ ] Agent receives and processes webhook payloads
- [ ] Matrix delivery works
- [ ] Actor ignore prevents loops
- [ ] GITHUB_WEBHOOK_SECRET stored in SOPS
</verification>

<success_criteria>

- All tasks completed
- webhookd deployed and healthy
- E2E flow verified (fake GitHub event → agent response in Matrix)
- Human approved the complete pipeline
- No errors in gateway or webhookd logs
  </success_criteria>

<output>
After completion, create `.planning/phases/23-hooks-webhooks/23-02-SUMMARY.md`
</output>
