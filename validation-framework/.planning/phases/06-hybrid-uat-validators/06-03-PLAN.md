---
phase: 06-hybrid-uat-validators
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/templates/validation/validators/security/trivy.yaml.j2
  - ~/.claude/templates/validation/validators/security/.trivyignore.j2
  - ~/.claude/templates/validation/ci/security.yml.j2
autonomous: true
---

<objective>
Create security scanning templates using Trivy for container and dependency vulnerabilities.

Purpose: Enable automated vulnerability detection in CI/CD pipelines with SARIF reporting.
Output: Jinja2 templates for Trivy config, ignore file, and GitHub Actions workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-hybrid-uat-validators/06-RESEARCH.md
@~/.claude/templates/validation/config.schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Trivy configuration template</name>
  <files>~/.claude/templates/validation/validators/security/trivy.yaml.j2</files>
  <action>
Create a Jinja2 template for Trivy configuration:
1. Set severity filter (CRITICAL, HIGH by default)
2. Configure output format (table, json, sarif)
3. Enable ignore-unfixed to skip unpatched vulnerabilities
4. Set cache directory
5. Configure scan types (vuln, secret, misconfig)
6. Set timeout for large scans

Include Jinja2 variables for:
- {{ project_name }}
- {{ severity | default('CRITICAL,HIGH') }}
- {{ ignore_unfixed | default(true) }}
- {{ scan_types | default(['vuln', 'secret']) }}
- {{ timeout | default('10m') }}

Follow Trivy YAML config format from trivy.dev documentation.
  </action>
  <verify>python3 -c "import yaml; yaml.safe_load(open('~/.claude/templates/validation/validators/security/trivy.yaml.j2').read().replace('{{', '').replace('}}', '').replace('{%', '').replace('%}', '').replace('true', 'True').replace('false', 'False'))"</verify>
  <done>Template contains valid Trivy YAML configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create Trivy ignore file template</name>
  <files>~/.claude/templates/validation/validators/security/.trivyignore.j2</files>
  <action>
Create a Jinja2 template for Trivy ignore file:
1. Header comment explaining purpose
2. Section for CVEs to ignore with justification format
3. Section for files/paths to exclude
4. Example entries (commented out) showing format

Include Jinja2 variables for:
- {{ project_name }}
- {{ ignored_cves | default([]) }}
- {{ excluded_paths | default([]) }}

Format:
```
# CVE-XXXX-YYYY: Justification why this is acceptable
CVE-XXXX-YYYY
```

Emphasize: each ignore MUST have justification comment.
  </action>
  <verify>test -f ~/.claude/templates/validation/validators/security/.trivyignore.j2</verify>
  <done>Template contains valid .trivyignore with example format</done>
</task>

<task type="auto">
  <name>Task 3: Create security CI workflow template</name>
  <files>~/.claude/templates/validation/ci/security.yml.j2</files>
  <action>
Create a Jinja2 template for GitHub Actions security workflow:
1. Trigger on push/PR to main/develop
2. Run two scan types:
   - Container scan (if Dockerfile exists)
   - Filesystem/dependency scan
3. Use aquasecurity/trivy-action@master
4. Output SARIF format for GitHub Security tab
5. Upload SARIF to GitHub Code Scanning
6. Exit with code 1 on CRITICAL/HIGH findings (blocking PR)
7. Upload detailed report as artifact

Include Jinja2 variables for:
- {{ project_name }}
- {{ image_name | default('app') }}
- {{ severity | default('CRITICAL,HIGH') }}
- {{ scan_refs | default(['.']) }}

CRITICAL: Always set exit-code: '1' - research shows this is commonly missed.
Follow pattern from trivy.dev/latest/docs CI/CD examples.
  </action>
  <verify>python3 -c "import yaml; yaml.safe_load(open('~/.claude/templates/validation/ci/security.yml.j2').read().replace('{{', '').replace('}}', '').replace('{%', '').replace('%}', '').replace('${{', '').replace('}}', ''))"</verify>
  <done>Template contains valid GitHub Actions workflow with Trivy scanning</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] trivy.yaml.j2 created with scan configuration
- [ ] .trivyignore.j2 created with ignore template
- [ ] security.yml.j2 created with CI workflow
- [ ] All templates are valid Jinja2
- [ ] CI workflow sets exit-code: '1' for blocking
</verification>

<success_criteria>

- All tasks completed
- Templates follow patterns from research
- CI workflow blocks PRs on CRITICAL/HIGH vulnerabilities
- SARIF output integrates with GitHub Security
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/06-hybrid-uat-validators/06-03-SUMMARY.md`
</output>
