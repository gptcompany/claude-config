---
phase: 06-hybrid-uat-validators
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/templates/validation/validators/performance/lighthouserc.js.j2
  - ~/.claude/templates/validation/validators/performance/budgets.json.j2
  - ~/.claude/templates/validation/ci/performance.yml.j2
autonomous: true
---

<objective>
Create performance validation templates using Lighthouse CI for Core Web Vitals.

Purpose: Enable automated performance budgets and Core Web Vitals assertions in CI/CD.
Output: Jinja2 templates for Lighthouse CI config, performance budgets, and GitHub Actions workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-hybrid-uat-validators/06-RESEARCH.md
@~/.claude/templates/validation/config.schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Lighthouse CI configuration template</name>
  <files>~/.claude/templates/validation/validators/performance/lighthouserc.js.j2</files>
  <action>
Create a Jinja2 template for Lighthouse CI configuration:
1. **collect**: Configure URLs to test, numberOfRuns (5 for variance reduction)
2. **assert**: Set Core Web Vitals thresholds:
   - first-contentful-paint: max 2000ms (error)
   - largest-contentful-paint: max 2500ms (error)
   - cumulative-layout-shift: max 0.1 (error)
   - total-blocking-time: max 300ms (error)
3. **assert categories**:
   - accessibility: min 0.9 (error)
   - best-practices: min 0.8 (warn)
4. **upload**: temporary-public-storage for reports

Include Jinja2 variables for:
- {{ project_name }}
- {{ urls | default(['http://localhost:3000/']) }}
- {{ number_of_runs | default(5) }}
- {{ fcp_max | default(2000) }}
- {{ lcp_max | default(2500) }}
- {{ cls_max | default(0.1) }}
- {{ tbt_max | default(300) }}

Use aggregationMethod: 'optimistic' to reduce flakiness (from research).
Follow lighthouse-ci docs pattern exactly.
  </action>
  <verify>node -e "require('./lighthouserc.js.j2')" 2>&1 | grep -v "Cannot find" || true</verify>
  <done>Template contains valid Lighthouse CI configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create performance budgets template</name>
  <files>~/.claude/templates/validation/validators/performance/budgets.json.j2</files>
  <action>
Create a Jinja2 template for Lighthouse performance budgets:
1. Define resource budgets:
   - script: max 300KB total
   - document: max 14KB
   - image: max 20 count
   - font: max 4 count
   - third-party: max 100KB
2. Define timing budgets:
   - firstCpuIdle: max 3000ms
   - interactive: max 5000ms
3. Per-path overrides if needed

Include Jinja2 variables for:
- {{ project_name }}
- {{ script_budget_kb | default(300) }}
- {{ image_count_budget | default(20) }}
- {{ third_party_kb | default(100) }}

Format as valid JSON with comments (JSONC-style for docs, stripped on render).
  </action>
  <verify>python3 -c "import json; json.loads(open('~/.claude/templates/validation/validators/performance/budgets.json.j2').read().replace('{{', '\"').replace('}}', '\"').replace('{%', '').replace('%}', ''))"</verify>
  <done>Template contains valid JSON performance budgets</done>
</task>

<task type="auto">
  <name>Task 3: Create performance CI workflow template</name>
  <files>~/.claude/templates/validation/ci/performance.yml.j2</files>
  <action>
Create a Jinja2 template for GitHub Actions performance workflow:
1. Trigger on push/PR to main/develop
2. Setup Node.js with caching
3. Install @lhci/cli globally
4. Build the application
5. Start dev server in background (with wait-on)
6. Run lhci autorun with config
7. Upload Lighthouse report as artifact
8. Comment on PR with performance summary (if PR)
9. Fail on budget violations

Include Jinja2 variables for:
- {{ project_name }}
- {{ node_version | default('20') }}
- {{ build_command | default('npm run build') }}
- {{ start_command | default('npm run start') }}
- {{ start_url | default('http://localhost:3000') }}

Use wait-on package to ensure server is ready before testing.
Follow pattern from lighthouse-ci GitHub Actions examples.
  </action>
  <verify>python3 -c "import yaml; yaml.safe_load(open('~/.claude/templates/validation/ci/performance.yml.j2').read().replace('{{', '').replace('}}', '').replace('{%', '').replace('%}', '').replace('${{', '').replace('}}', ''))"</verify>
  <done>Template contains valid GitHub Actions workflow with Lighthouse CI</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] lighthouserc.js.j2 created with Core Web Vitals assertions
- [ ] budgets.json.j2 created with resource limits
- [ ] performance.yml.j2 created with CI workflow
- [ ] All templates are valid Jinja2
- [ ] CI workflow uses numberOfRuns: 5 to reduce variance
</verification>

<success_criteria>

- All tasks completed
- Templates follow patterns from research
- CI workflow fails on Core Web Vitals violations
- Uses multiple runs to reduce flakiness
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/06-hybrid-uat-validators/06-04-SUMMARY.md`
</output>
