---
phase: 14-hooks-nodejs-port
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/scripts/lib/utils.js
  - ~/.claude/scripts/lib/package-manager.js
autonomous: true
---

<objective>
Create the Node.js utils.js shared library by porting ECC's cross-platform utilities and adding our validation-specific helpers.

Purpose: Foundation for all Node.js hooks - cross-platform file ops, hook I/O, git helpers.
Output: `~/.claude/scripts/lib/utils.js` and `~/.claude/scripts/lib/package-manager.js` (758+ LOC)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-hooks-nodejs-port/14-RESEARCH.md
@.planning/phases/14-hooks-nodejs-port/14-CONTEXT.md

# ECC Reference Implementation (port from these):
# /media/sam/1TB/everything-claude-code/scripts/lib/utils.js (368 LOC)
# /media/sam/1TB/everything-claude-code/scripts/lib/package-manager.js (390 LOC)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure and port utils.js</name>
  <files>~/.claude/scripts/lib/utils.js</files>
  <action>
1. Create directory: `mkdir -p ~/.claude/scripts/lib`
2. Port ECC's utils.js from `/media/sam/1TB/everything-claude-code/scripts/lib/utils.js`
3. Keep all cross-platform functions:
   - Platform detection: `isWindows`, `isMacOS`, `isLinux`
   - Directories: `getHomeDir`, `getClaudeDir`, `getSessionsDir`, `getLearnedSkillsDir`, `getTempDir`, `ensureDir`
   - Date/Time: `getDateString`, `getTimeString`, `getDateTimeString`
   - File ops: `findFiles`, `readFile`, `writeFile`, `appendFile`, `replaceInFile`, `countInFile`, `grepFile`
   - Hook I/O: `readStdinJson`, `log`, `output`
   - System: `commandExists`, `runCommand`, `isGitRepo`, `getGitModifiedFiles`
4. Add header comment crediting ECC as source
5. Use CommonJS (require/module.exports) for Node.js 18+ compatibility

DO NOT modify the ECC patterns - they are battle-tested. Copy faithfully.
  </action>
  <verify>node -e "const u = require('$HOME/.claude/scripts/lib/utils.js'); console.log(u.isLinux, u.getHomeDir())"</verify>
  <done>utils.js exists with all 21 exported functions, runs without error</done>
</task>

<task type="auto">
  <name>Task 2: Port package-manager.js</name>
  <files>~/.claude/scripts/lib/package-manager.js</files>
  <action>
1. Port ECC's package-manager.js from `/media/sam/1TB/everything-claude-code/scripts/lib/package-manager.js`
2. Keep all functions:
   - `PACKAGE_MANAGERS` object with npm/pnpm/yarn/bun configs
   - `getPackageManager(options)` - detection with priority chain
   - `setPreferredPackageManager(pmName)` - global preference
   - `setProjectPackageManager(pmName, projectDir)` - per-project
   - `getRunCommand(script, options)` - get command for script
   - `getExecCommand(binary, args, options)` - get npx/pnpm dlx command
   - `getSelectionPrompt()` - user prompt for selection
   - `getCommandPattern(action)` - regex pattern for all PMs
3. Ensure it requires utils.js with correct relative path
4. Add header comment crediting ECC

DO NOT modify the detection priority or command patterns - they match hooks.json matchers.
  </action>
  <verify>node -e "const pm = require('$HOME/.claude/scripts/lib/package-manager.js'); console.log(pm.getPackageManager().name)"</verify>
  <done>package-manager.js exists with all 9 exported functions, detects current PM</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for utils.js</name>
  <files>~/.claude/scripts/lib/utils.test.js</files>
  <action>
1. Create basic unit tests for utils.js
2. Test cross-platform functions:
   - `getHomeDir()` returns non-empty string
   - `getClaudeDir()` returns path ending in `.claude`
   - `ensureDir()` creates directory
   - `getDateString()` returns YYYY-MM-DD format
   - `findFiles()` with pattern matching
   - `readStdinJson()` can be called (async)
   - `commandExists('node')` returns true
   - `isGitRepo()` returns boolean
3. Use Node.js built-in test runner (node --test)
4. Keep tests simple - verify functions exist and return expected types

Tests should pass on Linux. Windows/macOS testing is Plan 14-05.
  </action>
  <verify>node --test ~/.claude/scripts/lib/utils.test.js</verify>
  <done>Tests pass, covering all major utility categories</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `~/.claude/scripts/lib/utils.js` exists (368+ LOC)
- [ ] `~/.claude/scripts/lib/package-manager.js` exists (390+ LOC)
- [ ] `~/.claude/scripts/lib/utils.test.js` passes
- [ ] Both libraries can be required without error
- [ ] `node -e "require('$HOME/.claude/scripts/lib/utils.js')"` succeeds
- [ ] `node -e "require('$HOME/.claude/scripts/lib/package-manager.js')"` succeeds
</verification>

<success_criteria>

- utils.js ported with all 21 functions
- package-manager.js ported with all 9 functions
- Unit tests pass
- Libraries are cross-platform compatible (tested on Linux, designed for Windows/macOS)
</success_criteria>

<output>
After completion, create `.planning/phases/14-hooks-nodejs-port/14-01-SUMMARY.md`
</output>
