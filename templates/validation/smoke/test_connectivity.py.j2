"""
Smoke Tests - External Service Connectivity

Project: {{ project_name }}
Domain: {{ domain }}
Auto-generated by validation framework.

Tests connectivity to external services.
These tests may be skipped in CI if services are not available.
"""
from __future__ import annotations

import socket
from typing import TYPE_CHECKING

import pytest

if TYPE_CHECKING:
    pass

# Default timeout for connection tests (seconds)
CONNECT_TIMEOUT = 5


def check_tcp_connection(host: str, port: int, timeout: float = CONNECT_TIMEOUT) -> bool:
    """Check if a TCP connection can be established."""
    try:
        with socket.create_connection((host, port), timeout=timeout):
            return True
    except (OSError, TimeoutError):
        return False


@pytest.mark.smoke
@pytest.mark.connectivity
class TestExternalServices:
    """Verify connectivity to external services."""
{% for service in smoke_tests.external_services %}
{% set host, port = service.rsplit(':', 1) %}

    def test_{{ host | replace('.', '_') | replace('-', '_') }}_{{ port }}_reachable(self) -> None:
        """Service {{ service }} is reachable."""
        host = "{{ host }}"
        port = {{ port }}

        if not check_tcp_connection(host, port):
            pytest.skip(
                f"Service {host}:{port} not reachable. "
                "This may be expected in CI environments."
            )
{% endfor %}
{% if not smoke_tests.external_services %}

    def test_placeholder(self) -> None:
        """Placeholder - add external_services to config.json."""
        # No external services configured
        # Edit .claude/validation/config.json to add services (host:port format)
        pass
{% endif %}


@pytest.mark.smoke
@pytest.mark.connectivity
class TestServiceHealthEndpoints:
    """Test health endpoints if services expose them."""

    def test_services_have_health_check(
        self, external_services: list[tuple[str, int]]
    ) -> None:
        """At least one service is configured (informational)."""
        if not external_services:
            pytest.skip("No external services configured")

        # This is informational - just log the configured services
        for host, port in external_services:
            reachable = check_tcp_connection(host, port)
            status = "reachable" if reachable else "unreachable"
            print(f"  {host}:{port} - {status}")


@pytest.mark.smoke
class TestNetworkBasics:
    """Basic network sanity checks."""

    def test_dns_resolution(self) -> None:
        """DNS resolution works."""
        try:
            socket.gethostbyname("localhost")
        except socket.gaierror:
            pytest.fail("DNS resolution failed for localhost")

    def test_loopback_available(self) -> None:
        """Loopback interface is available."""
        assert check_tcp_connection("127.0.0.1", 22, timeout=0.1) or True, (
            "This test always passes - just verifies socket module works"
        )
