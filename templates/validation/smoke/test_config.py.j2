"""
Smoke Tests - Configuration Validation

Project: {{ project_name }}
Domain: {{ domain }}
Auto-generated by validation framework.

Tests that config files exist and parse correctly.
"""
from __future__ import annotations

import json
from pathlib import Path
from typing import Any

import pytest

# Try to import optional config parsers
try:
    import yaml
    HAS_YAML = True
except ImportError:
    HAS_YAML = False

try:
    import tomllib
except ImportError:
    try:
        import tomli as tomllib  # type: ignore[import-not-found]
        HAS_TOML = True
    except ImportError:
        HAS_TOML = False
else:
    HAS_TOML = True


def parse_config_file(path: Path) -> dict[str, Any]:
    """Parse a config file based on its extension."""
    suffix = path.suffix.lower()

    if suffix in (".yaml", ".yml"):
        if not HAS_YAML:
            pytest.skip("PyYAML not installed")
        with open(path) as f:
            return yaml.safe_load(f) or {}

    elif suffix == ".json":
        with open(path) as f:
            return json.load(f)

    elif suffix == ".toml":
        if not HAS_TOML:
            pytest.skip("tomllib/tomli not available")
        with open(path, "rb") as f:
            return tomllib.load(f)

    else:
        pytest.skip(f"Unknown config format: {suffix}")
        return {}


@pytest.mark.smoke
class TestConfigFiles:
    """Verify config files exist and parse correctly."""
{% for config_file in smoke_tests.config_files %}

    def test_{{ config_file | replace('/', '_') | replace('.', '_') | replace('-', '_') }}_exists(
        self, project_root: Path
    ) -> None:
        """Config file {{ config_file }} exists."""
        path = project_root / "{{ config_file }}"
        assert path.exists(), f"Config file not found: {path}"

    def test_{{ config_file | replace('/', '_') | replace('.', '_') | replace('-', '_') }}_parses(
        self, project_root: Path
    ) -> None:
        """Config file {{ config_file }} parses without error."""
        path = project_root / "{{ config_file }}"
        if not path.exists():
            pytest.skip(f"Config file not found: {path}")

        try:
            data = parse_config_file(path)
            assert isinstance(data, dict), f"Expected dict, got {type(data)}"
        except Exception as e:
            pytest.fail(f"Failed to parse {{ config_file }}: {e}")
{% endfor %}
{% if not smoke_tests.config_files %}

    def test_placeholder(self) -> None:
        """Placeholder - add config_files to config.json."""
        # No config files configured
        # Edit .claude/validation/config.json to add files to validate
        pass
{% endif %}


@pytest.mark.smoke
class TestValidationConfig:
    """Verify the validation config itself is valid."""

    def test_validation_config_exists(self, project_root: Path) -> None:
        """Validation config exists at .claude/validation/config.json."""
        path = project_root / ".claude" / "validation" / "config.json"
        assert path.exists(), f"Validation config not found: {path}"

    def test_validation_config_valid(self, validation_config: dict[str, Any]) -> None:
        """Validation config has required fields."""
        assert "project_name" in validation_config, "Missing project_name"
        assert "domain" in validation_config, "Missing domain"
        assert validation_config["domain"] in (
            "trading", "workflow", "data", "general"
        ), f"Invalid domain: {validation_config['domain']}"
