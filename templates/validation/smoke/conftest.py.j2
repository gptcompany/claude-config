"""
Pytest configuration and shared fixtures for smoke tests.

Project: {{ project_name }}
Domain: {{ domain }}
Auto-generated by validation framework.
"""
from __future__ import annotations

import json
import sys
from pathlib import Path
from typing import Any

import pytest

# Add project root to sys.path
PROJECT_ROOT = Path(__file__).parent.parent.parent
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))


def pytest_configure(config: pytest.Config) -> None:
    """Register custom markers."""
    config.addinivalue_line("markers", "smoke: quick validation tests (< 2 min total)")
    config.addinivalue_line("markers", "connectivity: tests requiring external services")


@pytest.fixture(scope="session")
def project_root() -> Path:
    """Return the project root directory."""
    return PROJECT_ROOT


@pytest.fixture(scope="session")
def validation_config(project_root: Path) -> dict[str, Any]:
    """Load the validation configuration."""
    config_path = project_root / ".claude" / "validation" / "config.json"
    if not config_path.exists():
        pytest.skip(f"Validation config not found: {config_path}")
    with open(config_path) as f:
        return json.load(f)


@pytest.fixture(scope="session")
def critical_imports(validation_config: dict[str, Any]) -> list[str]:
    """Return list of critical imports to test."""
    return validation_config.get("smoke_tests", {}).get("critical_imports", [])


@pytest.fixture(scope="session")
def config_files(validation_config: dict[str, Any], project_root: Path) -> list[Path]:
    """Return list of config file paths to validate."""
    files = validation_config.get("smoke_tests", {}).get("config_files", [])
    return [project_root / f for f in files]


@pytest.fixture(scope="session")
def external_services(validation_config: dict[str, Any]) -> list[tuple[str, int]]:
    """Return list of external services as (host, port) tuples."""
    services = validation_config.get("smoke_tests", {}).get("external_services", [])
    result = []
    for svc in services:
        if ":" in svc:
            host, port = svc.rsplit(":", 1)
            result.append((host, int(port)))
    return result


@pytest.fixture
def skip_if_no_services(external_services: list[tuple[str, int]]) -> None:
    """Skip test if no external services configured."""
    if not external_services:
        pytest.skip("No external services configured")
