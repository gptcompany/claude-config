# Analysis Templates for Argo Rollouts Canary Deployment
#
# Project: {{ project_name }}
# Domain: {{ domain }}
# Auto-generated by validation framework.
#
# Deploy with: kubectl apply -f analysis-templates.yaml
{% if domain == "trading" %}
---
# Pre-built trading metrics analysis templates

apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: {{ project_name | replace('_', '-') }}-success-rate
  namespace: {{ k8s.namespace | default('default') }}
spec:
  args:
    - name: service-name
  metrics:
    - name: error-rate
      interval: 1m
      count: 10
      successCondition: result[0] < 0.05
      failureLimit: 3
      provider:
        prometheus:
          address: http://prometheus.monitoring.svc.cluster.local:9090
          query: |
            sum(rate(trading_errors_total{service="{{ '{{' }}args.service-name{{ '}}' }}", env="prod"}[5m]))
            /
            sum(rate(trading_requests_total{service="{{ '{{' }}args.service-name{{ '}}' }}", env="prod"}[5m]))

---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: {{ project_name | replace('_', '-') }}-latency
  namespace: {{ k8s.namespace | default('default') }}
spec:
  args:
    - name: service-name
  metrics:
    - name: latency-p99
      interval: 1m
      count: 10
      successCondition: result[0] < 100
      failureLimit: 3
      provider:
        prometheus:
          address: http://prometheus.monitoring.svc.cluster.local:9090
          query: |
            histogram_quantile(0.99,
              sum(rate(order_latency_ms_bucket{service="{{ '{{' }}args.service-name{{ '}}' }}", env="prod"}[5m]))
              by (le)
            )

---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: {{ project_name | replace('_', '-') }}-var
  namespace: {{ k8s.namespace | default('default') }}
spec:
  metrics:
    - name: var-threshold
      interval: 2m
      count: 5
      {% set var_threshold = 5.0 %}
      {% for trigger in rollback_triggers | default([]) %}
      {% if trigger.metric == "var_pct" %}
      {% set var_threshold = trigger.threshold %}
      {% endif %}
      {% endfor %}
      successCondition: result[0] < {{ var_threshold }}
      failureLimit: 2
      provider:
        prometheus:
          address: http://prometheus.monitoring.svc.cluster.local:9090
          query: |
            max(trading_risk_var_pct{env="prod"})

---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: {{ project_name | replace('_', '-') }}-drawdown
  namespace: {{ k8s.namespace | default('default') }}
spec:
  metrics:
    - name: drawdown-check
      interval: 1m
      count: 10
      {% set drawdown_threshold = 10.0 %}
      {% for trigger in rollback_triggers | default([]) %}
      {% if trigger.metric == "drawdown_pct" %}
      {% set drawdown_threshold = trigger.threshold %}
      {% endif %}
      {% endfor %}
      successCondition: result[0] < {{ drawdown_threshold }}
      failureLimit: 2
      provider:
        prometheus:
          address: http://prometheus.monitoring.svc.cluster.local:9090
          query: |
            max(trading_risk_drawdown_pct{env="prod"})

{% if rollback_triggers %}
# Custom rollback triggers from config
{% for trigger in rollback_triggers %}
{% if trigger.metric not in ["var_pct", "drawdown_pct", "error_rate", "latency_p99_ms"] %}
---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: {{ project_name | replace('_', '-') }}-{{ trigger.metric | replace('_', '-') }}
  namespace: {{ k8s.namespace | default('default') }}
spec:
  metrics:
    - name: {{ trigger.metric | replace('_', '-') }}
      interval: 1m
      count: 10
      {% if trigger.operator == "<" %}
      successCondition: result[0] < {{ trigger.threshold }}
      {% elif trigger.operator == ">" %}
      successCondition: result[0] > {{ trigger.threshold }}
      {% elif trigger.operator == "<=" %}
      successCondition: result[0] <= {{ trigger.threshold }}
      {% elif trigger.operator == ">=" %}
      successCondition: result[0] >= {{ trigger.threshold }}
      {% elif trigger.operator == "==" %}
      successCondition: result[0] == {{ trigger.threshold }}
      {% elif trigger.operator == "!=" %}
      successCondition: result[0] != {{ trigger.threshold }}
      {% endif %}
      failureLimit: 3
      provider:
        prometheus:
          address: http://prometheus.monitoring.svc.cluster.local:9090
          query: |
            {{ trigger.metric }}{env="prod"}

{% endif %}
{% endfor %}
{% endif %}
---
# Circuit breaker state analysis
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: {{ project_name | replace('_', '-') }}-circuit-breaker
  namespace: {{ k8s.namespace | default('default') }}
spec:
  metrics:
    - name: circuit-breaker-state
      interval: 1m
      count: 10
      successCondition: result[0] == 0
      failureLimit: 1
      provider:
        prometheus:
          address: http://prometheus.monitoring.svc.cluster.local:9090
          query: |
            max(circuit_breaker_halted{env="prod"})
{% else %}
# Skipped: domain is not "trading" (domain={{ domain }})
# This template only generates analysis templates when domain == "trading"
#
# To enable trading analysis templates, set domain: "trading" in config.json
{% endif %}
