# Security Scanning Workflow for {{ project_name }}
# Generated by validation-framework
#
# Features:
# - Trivy vulnerability scanning (container + dependencies)
# - Secret detection
# - SARIF output for GitHub Security tab
# - PR blocking on CRITICAL/HIGH vulnerabilities

name: Security Scan

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run daily at 2 AM UTC for continuous monitoring
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity to report'
        required: false
        default: '{{ severity | default("CRITICAL,HIGH") }}'
        type: choice
        options:
          - CRITICAL
          - CRITICAL,HIGH
          - CRITICAL,HIGH,MEDIUM

permissions:
  contents: read
  security-events: write
  actions: read

env:
  IMAGE_NAME: {{ image_name | default('app') }}
  SEVERITY: {{ severity | default('CRITICAL,HIGH') }}

jobs:
  # ==========================================================================
  # Filesystem Vulnerability Scan (Dependencies)
  # ==========================================================================
  dependency-scan:
    name: Dependency Vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: {% raw %}${{ github.event.inputs.severity || env.SEVERITY }}{% endraw %}
          exit-code: '1'
          ignore-unfixed: {{ ignore_unfixed | default(true) | lower }}
          scanners: '{{ scan_types | default(["vuln", "secret"]) | join(",") }}'
{%- if trivyignore_path is defined %}
          trivyignores: '{{ trivyignore_path }}'
{%- endif %}

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'

  # ==========================================================================
  # Container Image Scan (if Dockerfile exists)
  # ==========================================================================
  container-scan:
    name: Container Vulnerabilities
    runs-on: ubuntu-latest
    # Only run if Dockerfile exists
    if: {% raw %}${{ hashFiles('Dockerfile', '**/Dockerfile') != '' }}{% endraw %}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: {% raw %}${{ env.IMAGE_NAME }}:${{ github.sha }}{% endraw %}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner (container)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '{% raw %}${{ env.IMAGE_NAME }}:${{ github.sha }}{% endraw %}'
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: {% raw %}${{ github.event.inputs.severity || env.SEVERITY }}{% endraw %}
          exit-code: '1'
          ignore-unfixed: {{ ignore_unfixed | default(true) | lower }}
          scanners: '{{ scan_types | default(["vuln", "secret"]) | join(",") }}'
{%- if 'misconfig' in (scan_types | default(['vuln', 'secret'])) %}
          # Include Dockerfile misconfiguration checks
          vuln-type: 'os,library'
{%- endif %}

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-image-results.sarif'
          category: 'trivy-container'

  # ==========================================================================
  # Secret Scanning
  # ==========================================================================
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Run Trivy secret scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-secrets-results.sarif'
          exit-code: '1'
          scanners: 'secret'
{%- if trivyignore_path is defined %}
          trivyignores: '{{ trivyignore_path }}'
{%- endif %}

      - name: Upload secret scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-secrets-results.sarif'
          category: 'trivy-secrets'

{%- if 'misconfig' in (scan_types | default(['vuln', 'secret'])) %}

  # ==========================================================================
  # IaC/Config Misconfiguration Scan
  # ==========================================================================
  misconfig-scan:
    name: Misconfiguration Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config-results.sarif'
          exit-code: '1'
          severity: {% raw %}${{ github.event.inputs.severity || env.SEVERITY }}{% endraw %}
{%- if trivyignore_path is defined %}
          trivyignores: '{{ trivyignore_path }}'
{%- endif %}

      - name: Upload config scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-config-results.sarif'
          category: 'trivy-misconfig'
{%- endif %}

  # ==========================================================================
  # SBOM Generation (Software Bill of Materials)
  # ==========================================================================
  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    # Only on main/master branch pushes
    if: {% raw %}${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}{% endraw %}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy in SBOM mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-{% raw %}${{ github.sha }}{% endraw %}
          path: sbom.json
          retention-days: 90

  # ==========================================================================
  # Summary Job
  # ==========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-scan]
    if: always()

    steps:
      - name: Check scan results
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | {% raw %}${{ needs.dependency-scan.result == 'success' && '✅ Pass' || '❌ Fail' }}{% endraw %} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets | {% raw %}${{ needs.secret-scan.result == 'success' && '✅ Pass' || '❌ Fail' }}{% endraw %} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the [Security tab]({% raw %}${{ github.server_url }}/${{ github.repository }}{% endraw %}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any scan failed
        if: {% raw %}${{ needs.dependency-scan.result == 'failure' || needs.secret-scan.result == 'failure' }}{% endraw %}
        run: |
          echo "::error::Security vulnerabilities detected. Check the Security tab for details."
          exit 1
