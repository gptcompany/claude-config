# Performance Validation Workflow for {{ project_name }}
# Uses Lighthouse CI for Core Web Vitals testing
# Generated by validation-framework

name: Performance Validation

on:
  push:
    branches: [{{ main_branch | default('main') }}, {{ develop_branch | default('develop') }}]
  pull_request:
    branches: [{{ main_branch | default('main') }}]
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to test (optional, uses config default)'
        required: false
        type: string

concurrency:
  group: performance-${{ '{{' }} github.ref {{ '}}' }}
  cancel-in-progress: true

env:
  NODE_VERSION: '{{ node_version | default("20") }}'
  {% if lhci_token_secret is defined %}
  LHCI_TOKEN: ${{ '{{' }} secrets.{{ lhci_token_secret }} {{ '}}' }}
  {% endif %}

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: {{ runner | default('ubuntu-latest') }}
    timeout-minutes: {{ timeout_minutes | default(15) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ '{{' }} env.NODE_VERSION {{ '}}' }}
          cache: '{{ package_manager | default("npm") }}'

      - name: Install dependencies
        run: {{ install_command | default('npm ci') }}

      {% if build_command is defined %}
      - name: Build application
        run: {{ build_command }}
        env:
          NODE_ENV: production
          {% if build_env_vars is defined %}
          {% for key, value in build_env_vars.items() %}
          {{ key }}: {{ value }}
          {% endfor %}
          {% endif %}
      {% endif %}

      - name: Install wait-on for server readiness
        run: npm install -g wait-on

      {% if start_server_command is defined %}
      - name: Start server
        run: |
          {{ start_server_command }} &
          wait-on {{ wait_on_url | default('http://localhost:3000') }} --timeout {{ wait_on_timeout | default(60000) }}
        env:
          NODE_ENV: production
          PORT: {{ server_port | default(3000) }}
      {% endif %}

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        id: lighthouse
        with:
          configPath: {{ lighthouserc_path | default('./lighthouserc.js') }}
          uploadArtifacts: true
          temporaryPublicStorage: {{ temporary_public_storage | default(true) | lower }}
          runs: {{ number_of_runs | default(5) }}
          {% if custom_urls is defined %}
          urls: |
            {% for url in custom_urls %}
            {{ url }}
            {% endfor %}
          {% endif %}

      - name: Verify Core Web Vitals
        run: |
          echo "## Lighthouse Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Score | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Parse results and create summary
          RESULTS='${{ '{{' }} steps.lighthouse.outputs.manifest {{ '}}' }}'

          if [ -n "$RESULTS" ]; then
            echo "Lighthouse audit completed successfully"
            echo "Results URL: ${{ '{{' }} steps.lighthouse.outputs.links {{ '}}' }}"
          else
            echo "Warning: No Lighthouse results available"
          fi

      {% if performance_comment | default(true) %}
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const links = ${{ '{{' }} steps.lighthouse.outputs.links {{ '}}' }};
            const manifest = ${{ '{{' }} steps.lighthouse.outputs.manifest {{ '}}' }};

            if (!manifest || manifest.length === 0) {
              console.log('No Lighthouse results to comment');
              return;
            }

            // Get the first result for summary
            const result = manifest[0];
            const summary = result.summary;

            const formatScore = (score) => {
              if (score === null || score === undefined) return 'N/A';
              const pct = Math.round(score * 100);
              const emoji = pct >= 90 ? 'ðŸŸ¢' : pct >= 50 ? 'ðŸŸ¡' : 'ðŸ”´';
              return `${emoji} ${pct}`;
            };

            const body = `## Lighthouse Performance Report

            | Category | Score |
            |----------|-------|
            | Performance | ${formatScore(summary.performance)} |
            | Accessibility | ${formatScore(summary.accessibility)} |
            | Best Practices | ${formatScore(summary['best-practices'])} |
            | SEO | ${formatScore(summary.seo)} |

            [View Full Report](${Object.values(links)[0]})

            <details>
            <summary>Core Web Vitals Thresholds</summary>

            - FCP: max {{ fcp_max | default(2000) }}ms
            - LCP: max {{ lcp_max | default(2500) }}ms
            - CLS: max {{ cls_max | default(0.1) }}
            - TBT: max {{ tbt_max | default(300) }}ms

            </details>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
      {% endif %}

      {% if artifact_retention is defined %}
      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: {{ artifact_retention }}
      {% endif %}

  {% if budget_validation | default(true) %}
  budget-check:
    name: Performance Budget Check
    runs-on: {{ runner | default('ubuntu-latest') }}
    needs: lighthouse
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate performance budgets
        run: |
          echo "## Performance Budget Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Budget | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Scripts | {{ script_budget_kb | default(300) }}KB | Checked in Lighthouse |" >> $GITHUB_STEP_SUMMARY
          echo "| Styles | {{ css_budget_kb | default(100) }}KB | Checked in Lighthouse |" >> $GITHUB_STEP_SUMMARY
          echo "| Images | {{ image_budget_kb | default(500) }}KB | Checked in Lighthouse |" >> $GITHUB_STEP_SUMMARY
          echo "| Total | {{ total_budget_kb | default(1500) }}KB | Checked in Lighthouse |" >> $GITHUB_STEP_SUMMARY
  {% endif %}

  {% if notify_on_failure | default(false) %}
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lighthouse{% if budget_validation | default(true) %}, budget-check{% endif %}]
    if: failure()

    steps:
      - name: Send failure notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: {{ slack_channel | default('#alerts') }}
          slack-message: |
            :warning: Performance validation failed for {{ project_name }}
            Branch: ${{ '{{' }} github.ref_name {{ '}}' }}
            Commit: ${{ '{{' }} github.sha {{ '}}' }}
            Run: ${{ '{{' }} github.server_url {{ '}}' }}/${{ '{{' }} github.repository {{ '}}' }}/actions/runs/${{ '{{' }} github.run_id {{ '}}' }}
        env:
          SLACK_BOT_TOKEN: ${{ '{{' }} secrets.SLACK_BOT_TOKEN {{ '}}' }}
  {% endif %}
