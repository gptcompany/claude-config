/**
 * Lighthouse CI Configuration for {{ project_name }}
 *
 * Core Web Vitals thresholds configured for optimal user experience.
 * Generated by validation-framework.
 */
module.exports = {
  ci: {
    collect: {
      // URLs to test - defaults to localhost:3000
      url: {{ urls | default(['http://localhost:3000/']) | tojson }},

      // Run multiple times to reduce variance
      numberOfRuns: {{ number_of_runs | default(5) }},

      // Wait for server to be ready before testing
      startServerCommand: '{{ start_server_command | default("npm start") }}',
      startServerReadyPattern: '{{ server_ready_pattern | default("ready on") }}',
      startServerReadyTimeout: {{ server_ready_timeout | default(30000) }},

      // Chrome flags for consistent testing
      settings: {
        chromeFlags: '--no-sandbox --headless --disable-gpu',
        // Use mobile preset for Core Web Vitals (default Lighthouse behavior)
        preset: '{{ preset | default("desktop") }}',
        // Throttling settings
        throttlingMethod: '{{ throttling_method | default("simulate") }}',
      },
    },

    assert: {
      // Use optimistic aggregation to reduce flakiness
      aggregationMethod: '{{ aggregation_method | default("optimistic") }}',

      assertions: {
        // Core Web Vitals - Performance Metrics
        'first-contentful-paint': ['error', { maxNumericValue: {{ fcp_max | default(2000) }} }],
        'largest-contentful-paint': ['error', { maxNumericValue: {{ lcp_max | default(2500) }} }],
        'cumulative-layout-shift': ['error', { maxNumericValue: {{ cls_max | default(0.1) }} }],
        'total-blocking-time': ['error', { maxNumericValue: {{ tbt_max | default(300) }} }],

        // Additional performance metrics
        'interactive': ['warn', { maxNumericValue: {{ tti_max | default(3500) }} }],
        'speed-index': ['warn', { maxNumericValue: {{ si_max | default(3000) }} }],

        // Category scores (0-1 scale)
        'categories:performance': ['error', { minScore: {{ perf_score_min | default(0.8) }} }],
        'categories:accessibility': ['error', { minScore: {{ a11y_score_min | default(0.9) }} }],
        'categories:best-practices': ['warn', { minScore: {{ bp_score_min | default(0.9) }} }],
        'categories:seo': ['warn', { minScore: {{ seo_score_min | default(0.9) }} }],

        // Resource budget assertions
        'resource-summary:script:size': ['error', { maxNumericValue: {{ script_budget_kb | default(300) }} * 1024 }],
        'resource-summary:stylesheet:size': ['warn', { maxNumericValue: {{ css_budget_kb | default(100) }} * 1024 }],
        'resource-summary:image:size': ['warn', { maxNumericValue: {{ image_budget_kb | default(500) }} * 1024 }],
        'resource-summary:total:size': ['warn', { maxNumericValue: {{ total_budget_kb | default(1500) }} * 1024 }],

        // Critical rendering path
        'render-blocking-resources': ['warn', { maxLength: {{ max_render_blocking | default(2) }} }],
        'uses-responsive-images': '{{ responsive_images_level | default("warn") }}',
        'uses-optimized-images': '{{ optimized_images_level | default("warn") }}',
        'uses-text-compression': '{{ text_compression_level | default("error") }}',

        {% if strict_mode | default(false) %}
        // Strict mode: additional assertions
        'no-unload-listeners': 'error',
        'uses-http2': 'error',
        'uses-passive-event-listeners': 'error',
        'deprecations': 'error',
        {% endif %}
      },
    },

    upload: {
      // Upload results for historical tracking
      target: '{{ upload_target | default("temporary-public-storage") }}',
      {% if lhci_server_url is defined %}
      serverBaseUrl: '{{ lhci_server_url }}',
      token: process.env.LHCI_TOKEN,
      {% endif %}
      {% if github_app_token is defined %}
      // GitHub status checks
      githubAppToken: process.env.LHCI_GITHUB_APP_TOKEN,
      githubToken: process.env.GITHUB_TOKEN,
      {% endif %}
    },
  },
};
